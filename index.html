
#Requires -Version 5.1
[CmdletBinding()]
param(
    [string]$OutDir   = 'D:\000. í˜„ì¥\0000. ì§„ë‹¨ ë³´ê³ ì„œ\2026\ëª¨ë°”ì¼ ì½”ë”©',
    [string]$FileName = 'index.html',
    [switch]$Open,
    [switch]$Hash
)

$ErrorActionPreference = 'Stop'

# ì¶œë ¥ í´ë” ìƒì„±/í™•ì¸
try {
    if (-not (Test-Path -LiteralPath $OutDir)) {
        New-Item -ItemType Directory -Path $OutDir -Force | Out-Null
    }
} catch {
    Write-Error "ì¶œë ¥ í´ë” ìƒì„±/í™•ì¸ ì¤‘ ì˜¤ë¥˜: $($_.Exception.Message)"
    throw
}

$indexPath = Join-Path $OutDir $FileName

# HTML ì „ì²´(ëª¨ë°”ì¼ ìœ„í—˜ì„± í‰ê°€ ì›¹ì•±)
$html = @'
<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<meta name="color-scheme" content="light" />
<title>LGì „ì ESì—ë„ˆì§€ì»¨ì„¤íŒ…íŒ€ ìœ„í—˜ì„± í‰ê°€í‘œ (ëª¨ë°”ì¼ í‘œ Ver.)</title>

<!-- âœ… html2pdf.js (CDN) ì˜¬ë°”ë¥¸ ì‚½ì… -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"
        integrity="sha512-GsLlZN/3F2ErC5ifS5QtgpiJtWd43JWSuIgh7mbzZ8zBps+dvLusV+eNQATqgA/HdeKFVgA5v3S/cIrLF7QnIg=="
        crossorigin="anonymous" referrerpolicy="no-referrer"></script>

<style>
@font-face{
  font-family: "LGìŠ¤ë§ˆíŠ¸ì²´";
  src: url("LGSmartRegular.woff2") format("woff2"),
       url("LGSmartRegular.woff") format("woff");
  font-weight: 400; font-style: normal; font-display: swap;
}
:root{
  --bg:#f6f7fb; --card:#fff; --text:#111827; --border:#e5e7eb; --primary:#111827;
  --fs-body: clamp(15.6px, 2.04vw, 18px);
  --fs-label: clamp(14.4px, 1.92vw, 16.8px);
  --fs-title: clamp(21.6px, 4.32vw, 26.4px);
  --fs-h2: clamp(16.8px, 3.12vw, 19.2px);
  --fs-btn: clamp(15.6px, 2.88vw, 18px);
  --line:1.45; --radius:12px; --table-pad:6px;
  --radius-input:10px; --focus:#3b82f6; --shadow:0 2px 6px rgba(0,0,0,.06); --title-accent:#8B1B3D;
}
*{ box-sizing:border-box }
html,body{
  margin:0; padding:0; width:100%; min-height:100vh; overflow-x:hidden;
  -webkit-text-size-adjust:100%; -webkit-tap-highlight-color:transparent;
  background:var(--bg); color:var(--text);
  font-family:"LGìŠ¤ë§ˆíŠ¸ì²´","Malgun Gothic","Apple SD Gothic Neo","Noto Sans KR",system-ui,-apple-system,"Segoe UI",Roboto,sans-serif;
  font-size:var(--fs-body); line-height:var(--line);
}
header{
  background:var(--card);
  border-bottom:1px solid var(--border);
  position:sticky; top:0; z-index:10;
  backdrop-filter:saturate(120%) blur(6px);
}
.wrap{max-width:1000px; margin:0 auto; padding:12px}
.brand{display:flex; align-items:center; justify-content:space-between; gap:8px}
.title{font-weight:800;}
.main-title{
  color:var(--title-accent);
  font-size:calc(var(--fs-title) + 8px);
  text-shadow:0 1px 0 rgba(0,0,0,.05);
  letter-spacing:2px;
  transform:translateY(-4px);
  text-align:center;
  line-height:1.25;
  margin:6px 0 10px 0;
}
.toolbar{display:flex; gap:8px; margin-top:8px}
.toolbar-left{display:flex; gap:8px; margin-right:auto}
button{
  border:1px solid var(--border); background:var(--primary); color:#fff;
  border-radius:var(--radius); padding:9px 12px; font-size:var(--fs-btn);
  min-height:40px; cursor:pointer; font-family:inherit;
}
button.secondary{background:#374151}
button.warn{background:#b91c1c}
button.mini{ padding:6px 8px; min-height:32px; font-size:calc(var(--fs-btn) - 2px); border-radius:10px }
@media (pointer:coarse){
  button{min-height:44px}
  input,select,textarea{min-height:48px; font-family:inherit}
  .table-wrap{overflow-x:auto; -webkit-overflow-scrolling:touch}
  button.mini{ min-height:36px }
}
main{padding:12px 0}
.card{
  background:var(--card); border:1px solid var(--border); border-radius:var(--radius);
  padding:18px; margin:12px auto; box-shadow:var(--shadow)
}
.field{
  width:100%; padding:10px 12px;
  border:1px solid var(--border); border-radius:var(--radius-input);
  outline:none; font-family:inherit; font-size:inherit; background:#fff;
  transition:border-color .15s ease, box-shadow .15s ease;
  min-height:48px;
}
.field:focus{ border-color:var(--focus); box-shadow:0 0 0 3px rgba(59,130,246,.15) }
.field.textarea{ min-height:72px; resize:vertical }
.table-wrap{
  width:100%; overflow-x:auto; -webkit-overflow-scrolling:touch;
  border:1px solid var(--border); border-radius:var(--radius); background:#fff;
}
table{
  width:100%; border-collapse:collapse; min-width:920px; table-layout:fixed;
  word-break:keep-all; font-family:inherit;
}
/* í™”ë©´ìš© ì—´ í­ */
col.c-task{ width:72px }
col.c-hazard{ width:364px }
col.c-ok{ width:72px }
col.c-fix{ width:72px }
col.c-na{ width:88px }
col.c-miti{ width:220px }
col.c-done{ width:56px }
th,td{ border:1px solid var(--border); padding:var(--table-pad); font-size:var(--fs-body); vertical-align:top }
thead th{ background:#f3f4f6; text-align:center; white-space:nowrap }
td{ text-align:left }
td.section{
  text-align:center !important; vertical-align:middle !important; font-weight:600; background:#f8fafc;
}
.section-cell{ display:flex; flex-direction:column; align-items:center; justify-content:space-between; min-height:100%; gap:8px }
.section-title{ font-weight:700 }
.section-actions{ display:flex; gap:6px; justify-content:center; flex-wrap:wrap } /* + / - ë²„íŠ¼ ì»¨í…Œì´ë„ˆ */
.chk-wrap{ display:flex; align-items:center; justify-content:center; min-height:32px; }
.riskchk{ width:18px; height:18px; accent-color:#111827; cursor:pointer; }
@media(pointer:coarse){ .riskchk{ width:21px; height:21px } }
.cell-input{
  width:100%; min-height:40px; border:1px solid var(--border); border-radius:8px; background:#fff;
  font-family:inherit; font-size:inherit; padding:6px 8px; outline:none;
  white-space:pre-wrap; word-break:break-word; overflow-wrap:break-word; resize:vertical;
}
/* â–¼ ë³´ì™„ëŒ€ì±… ë“œë¡­ì…€/ì‚¬ìš©ìì…ë ¥ UI */
.miti-cell{ padding:6px !important; position:relative; }
.miti-ui{ display:flex; flex-direction:column; gap:6px; }
.miti-select,
.miti-user{
  box-sizing:border-box; width:100%; height:48px;
  padding:0 34px 0 10px; border:1px solid var(--border); border-radius:8px; background:#fff;
  font-family:inherit; font-size:inherit; line-height:48px; outline:none;
  -webkit-appearance:none; appearance:none; background-image:none;
}
.miti-user{ display:none; padding:6px 8px; line-height:normal; }
.miti-cell::after{
  content:""; position:absolute; right:14px; top:50%; margin-top:-4px; width:0; height:0;
  border-left:6px solid transparent; border-right:6px solid transparent; border-top:8px solid #6b7280;
}
@supports (-webkit-touch-callout: none){ .miti-select{ line-height:48px; } }
@media (pointer:coarse) and (max-width:800px){ .miti-select{ line-height:48px; } }
.miti-print{ display:none; min-height:48px; white-space:pre-wrap; word-break:break-word; }

.signature{ width:100%; height:130px }
.sig-box{ position:relative }
#printPDF{ position:absolute; top:-50px; right:14px; transform:none; z-index:2 }
.signature canvas{
  width:100%; height:100%; display:block; border:1px dashed var(--border);
  border-radius:8px; background:#fff; touch-action:none
}

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
ğŸ–¨ï¸ ì¸ì‡„ ìµœì í™” + 3ë‹¨ë½ ë¬¶ê¸° + ì—´í­ ë™ê¸°í™”
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
@page{ margin:15mm }  /* ê¸°ë³¸ ì—¬ë°± 15mmë¡œ í™•ëŒ€ */
@media print{
  html, body{
    background:#fff !important; color:#000 !important;
    -webkit-print-color-adjust: exact; print-color-adjust: exact;
  }
  .wrap{ transform:none !important; width:auto !important }
  header,.toolbar{ display:none !important }
  .card{ box-shadow:none !important; background:#fff !important; border-color:#ddd !important; transform-origin:top left; }
  .table-wrap, table, thead, tbody, tfoot, tr, th, td,
  input.field, textarea.field, .signature canvas{ background:#fff !important; }
  thead th{ background:#fff !important } td.section{ background:#fff !important }
  #printPDF, #clearAll, #clearSigSafety, #clearSigW1, #clearSigW2, #clearSigW3 { display:none !important; }
  .section-actions{ display:none !important; }
  thead{ display:table-header-group !important } tfoot{ display:table-footer-group !important }
  table{ min-width:auto; width:100%; table-layout:auto; border-collapse:collapse }
  .table-wrap{ overflow:visible !important }
  tr, th, td, .sig-box, .signature, .section-cell, .miti-print, .cell-input, .miti-select, .miti-user{
    page-break-inside:avoid !important; break-inside:avoid !important;
  }
  tbody{ page-break-inside:auto; break-inside:auto }
  p, .cell-input, .miti-print{ orphans:3; widows:3 }
  h1,h2,h3, .main-title, .section-title{ page-break-after:avoid; break-after:avoid }
  .page-block{ page-break-inside:avoid !important; break-inside:avoid !important; }
  .page-start{ page-break-before:always !important; break-before:page !important; }
  html.print-portrait  col.c-task{width:8%!important}  html.print-portrait  col.c-hazard{width:36%!important}
  html.print-portrait  col.c-ok{width:6%!important}   html.print-portrait  col.c-fix{width:6%!important}
  html.print-portrait  col.c-na{width:6%!important}   html.print-portrait  col.c-miti{width:36%!important}
  html.print-portrait  col.c-done{width:2%!important}
  html.print-landscape col.c-task{width:8%!important}  html.print-landscape col.c-hazard{width:36%!important}
  html.print-landscape col.c-ok{width:5%!important}   html.print-landscape col.c-fix{width:5%!important}
  html.print-landscape col.c-na{width:5%!important}   html.print-landscape col.c-miti{width:36%!important}
  html.print-landscape col.c-done{width:5%!important}
  .miti-ui{ display:none !important; } .miti-print{ display:block !important; }
}

/* ğŸ§© ë‚´ë³´ë‚´ê¸°ìš© ìƒíƒœ: PDF ë·°ì–´ë¡œ ë‚´ë³´ë‚¼ ë•Œ UI ìˆ¨ê¹€ + í…ìŠ¤íŠ¸ë§Œ ì¶œë ¥ */
html.export-mode header,
html.export-mode .toolbar,
html.export-mode #printPDF,
html.export-mode #clearAll,
html.export-mode #clearSigSafety,
html.export-mode #clearSigW1,
html.export-mode #clearSigW2,
html.export-mode #clearSigW3,
html.export-mode .section-actions,
html.export-mode button { display:none !important; }

/* í‘œ/ì…ë ¥ UIëŠ” ê°ì¶”ê³  ê°’ë§Œ ë³´ì´ë„ë¡ */
html.export-mode .miti-ui    { display:none !important; }
html.export-mode .miti-print { display:block !important; }

/* ë°°ê²½/ê²½ê³„ ë³´ì •(ë‚´ë³´ë‚´ê¸° ì‹œ í° ë°°ê²½) */
html.export-mode .card{
  box-shadow:none !important;
  background:#fff !important;
  border-color:#ddd !important;
}
html.export-mode html,
html.export-mode body,
html.export-mode .table-wrap, 
html.export-mode table, 
html.export-mode thead, 
html.export-mode tbody, 
html.export-mode tr, 
html.export-mode th, 
html.export-mode td { background:#fff !important; }

/* ğŸ“± ëª¨ë°”ì¼ ì „ìš© UI ì¡°ì • */
@media (max-width:800px), (pointer:coarse){
  col.c-hazard, col.c-miti { width:182px !important }
  tbody td:nth-child(2){ word-break:break-word; overflow-wrap:break-word; white-space:normal }
  main .card:first-of-type input[type="date"].field{
    width:100%; min-width:0; -webkit-appearance:none; appearance:none;
    height:48px; line-height:48px; color:var(--text); caret-color:var(--text);
  }
  main .card:first-of-type input[type="date"].field::-webkit-calendar-picker-indicator{
    margin:0 6px 0 0; padding:0; width:18px; height:18px;
  }
  .wrap{ transform:scale(.8); transform-origin:top left; width:calc(100%/.8) }
}
#approvalSection > h2{ font-size:calc(var(--fs-h2) - 4px + 3px) }
</style>
</head>
<body>
<header>
  <div class="wrap">
    <div class="brand">
      <div class="title">LGì „ì ESì—ë„ˆì§€ì»¨ì„¤íŒ…íŒ€ ìœ„í—˜ì„± í‰ê°€í‘œ (ëª¨ë°”ì¼ í‘œ Ver.)</div>
    </div>
    <div class="toolbar">
      <div class="toolbar-left">
        <button id="clearAll" class="warn" type="button">ì´ˆê¸°í™”</button>
        <!-- ìƒˆ íƒ­ ë·°ì–´ë¡œ ì—´ê¸° -->
        <button id="openViewer" class="secondary" type="button" title="PDF ë·°ì–´ë¡œ ì—´ê¸°">ë·°ì–´ë¡œ ì—´ê¸°</button>
        <!-- âœ… ê³µìœ  ë²„íŠ¼ (HTTPS + ì§€ì› ë¸Œë¼ìš°ì €ì—ì„œ OS ê³µìœ  ì‹œíŠ¸ë¡œ íŒŒì¼ ê³µìœ ) -->
        <button id="sharePDF" class="secondary" type="button" title="ê³µìœ ">ê³µìœ </button>
      </div>
    </div>
  </div>
</header>

<main class="wrap">
  <!-- 1) í˜„ì¥ ì •ë³´ë€ -->
  <section class="card page-block" id="metaCard">
    <div class="title main-title">ìˆ˜ì‹œ ìœ„í—˜ì„± í‰ê°€í‘œ</div>
    <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px">
      <div><label class="hint">ì—…ì²´ëª…</label><input id="fCompany" type="text" value="LGì „ì ESì—ë„ˆì§€ì»¨ì„¤íŒ…íŒ€" class="field"></div>
      <div><label class="hint">í˜„ì¥ëª…</label><input id="fSiteName" type="text" placeholder="ì˜ˆ: â—‹â—‹ê³µì¥ â—‹â—‹ë¼ì¸" class="field"></div>
      <div><label class="hint">ì§„ë‹¨ ì‹œì‘</label><input id="fDiagStart" type="date" class="field"></div>
      <div><label class="hint">ì§„ë‹¨ ì¢…ë£Œ</label><input id="fDiagEnd" type="date" class="field"></div>
      <div><label class="hint">ì‘ì„± ì¼ì</label><input id="fWrittenDate" type="date" class="field"></div>
      <div><label class="hint">í˜„ì¥ê´€ë¦¬ì</label><input id="fSafety" type="text" placeholder="ì„±ëª…" class="field"></div>
      <div><label class="hint">ì‹¤ë¬´ì1</label><input id="fWorker1" type="text" placeholder="ì„±ëª…" class="field"></div>
      <div><label class="hint">ì‹¤ë¬´ì2</label><input id="fWorker2" type="text" placeholder="ì„±ëª…" class="field"></div>
      <div><label class="hint">ì‹¤ë¬´ì3</label><input id="fWorker3" type="text" placeholder="ì„±ëª…" class="field"></div>
      <div style="grid-column:1/-1"><label class="hint">ë¹„ê³ </label>
        <textarea id="fRemark" class="field textarea" placeholder="íŠ¹ì´ì‚¬í•­/ì°¸ê³ ì‚¬í•­"></textarea>
      </div>
    </div>
  </section>

  <!-- 2) ì²´í¬ë¦¬ìŠ¤íŠ¸ -->
  <section class="card page-block page-start" id="checklistCard">
    <h2 style="display:none">ì‘ì—…ë³„ ìœ í•´ìœ„í—˜ìš”ì¸ í‰ê°€</h2>
    <div class="table-wrap">
      <table id="riskTable">
        <colgroup>
          <col class="c-task"/><col class="c-hazard"/><col class="c-ok"/><col class="c-fix"/><col class="c-na"/><col class="c-miti"/><col class="c-done"/>
        </colgroup>
        <thead>
          <tr>
            <th rowspan="2" class="th-center">ì‘ì—…</th>
            <th rowspan="2" class="th-center">ìœ í•´Â·ìœ„í—˜ìš”ì¸ íŒŒì•…</th>
            <th colspan="3" class="th-center">ìœ„í—˜ì„± í™•ì¸ê²°ê³¼</th>
            <th rowspan="2" class="th-center">ë³´ì™„ ëŒ€ì±…</th>
            <th rowspan="2" class="th-center">
              <div style="display:flex; flex-direction:column; align-items:center; gap:4px">
                <span>í™•ì¸</span>
                <label class="chk-wrap" title="ì „ì²´ í™•ì¸ ì²´í¬/í•´ì œ">
                  <input id="chkConfirmAll" type="checkbox" class="riskchk" style="width:18px;height:18px">
                </label>
              </div>
            </th>
          </tr>
          <tr>
            <th>ì ì •</th><th>ë³´ì™„</th><th>í•´ë‹¹ì—†ìŒ</th>
          </tr>
        </thead>
        <tbody>
          <!-- ì‚¬ì „ì¤€ë¹„ ì‘ì—… -->
          <tr id="prep-master-row">
            <td id="prep-section-cell" class="section" rowspan="8">
              <div class="section-cell">
                <div class="section-title">ì‚¬ì „ì¤€ë¹„ ì‘ì—…</div>
                <div class="section-actions">
                  <button type="button" class="secondary mini" id="btnPrepAdd">+</button>
                  <button type="button" class="warn mini" id="btnPrepRemove">-</button>
                </div>
              </div>
            </td>
            <td>ì‘ì—… ì¥ì†Œ (ê¸°ê³„ì‹¤, ì „ê¸°ì‹¤, ì˜¥ìƒ ë“±)ê¹Œì§€ ë˜ëŠ” ì¥ì†Œ ë‚´ ì´ë™ ë° ì‘ì—…ì— ìˆì–´ ìœ í•´, ìœ„í—˜ ìš”ì¸ì´ ìˆëŠ”ê°€? ìˆë‹¤ë©´ ì•„ë˜ ì ê²€.</td>
            <td class="no-ok"></td><td class="no-fix"></td><td></td>
            <td class="miti-cell"></td><td></td>
          </tr>
          <tr class="prep-sub-row"><td>- ì‘ì—…ì¥ ë˜ëŠ” í†µë¡œì— ë°°ê´€ ë“± ë¨¸ë¦¬ ë¶€ë”ªí˜ ê°€ëŠ¥</td><td></td><td></td><td></td><td class="miti-cell"></td><td></td></tr>
          <tr class="prep-sub-row"><td>- ì‘ì—…ì¥ ë˜ëŠ” í†µë¡œì— ì¶”ë½ ê°€ëŠ¥ ì¥ì†Œ ìˆìŒ</td><td></td><td></td><td></td><td class="miti-cell"></td><td></td></tr>
          <tr class="prep-sub-row"><td>- ì‘ì—…ì¥ ë˜ëŠ” í†µë¡œì— ë–¨ì–´ì§ ê°€ëŠ¥ ì¥ì†Œ ìˆìŒ</td><td></td><td></td><td></td><td class="miti-cell"></td><td></td></tr>
          <tr class="prep-sub-row"><td>- ì‘ì—…ì¥ ë˜ëŠ” í†µë¡œì— ê³ ì „ì•• ì£¼ì˜ ì¥ì†Œ ìˆìŒ</td><td></td><td></td><td></td><td class="miti-cell"></td><td></td></tr>
          <tr class="prep-sub-row"><td>- ì‘ì—…ì¥ ë˜ëŠ” í†µë¡œì— íšŒì „ì¥ë¹„ê°€ ìˆìŒ</td><td></td><td></td><td></td><td class="miti-cell"></td><td></td></tr>
          <tr><td>ì¸¡ì •ì¥ë¹„ì˜ í˜„ì¥ ìš´ë°˜ê¹Œì§€ ìœ í•´, ìœ„í—˜ ìš”ì¸ì´ ìˆëŠ”ê°€?</td><td></td><td></td><td></td><td class="miti-cell"></td><td></td></tr>
          <tr id="prep-last-fixed"><td>ì‘ì—… ê³µê°„ì´ ë°€íë˜ê±°ë‚˜, ì†Œí†µì´ ì–´ë ¤ìš´ í™˜ê²½ì¸ê°€? Ex. ê¸´ê¸‰, ì‘ê¸‰ìƒí™© ëŒ€ì²˜</td><td></td><td></td><td></td><td class="miti-cell"></td><td></td></tr>

          <!-- ì‘ì—…ì‹œ -->
          <tr>
            <td id="task-works-label" class="section" rowspan="5">
              <div class="section-cell">
                <div class="section-title">ì‘ì—…ì‹œ</div>
                <div class="section-actions">
                  <button type="button" class="secondary mini" id="btnWorksAdd">+</button>
                  <button type="button" class="warn mini" id="btnWorksRemove">-</button>
                </div>
              </div>
            </td>
            <td>ë³´ì˜¨ì¬ íƒˆê±°/ì œê±°, ê°ì¢… ì¸¡ì • ë“±ì˜ ì‘ì—…ì´ ë°”ë‹¥ì— ì„œì„œ í•  ìˆ˜ ìˆëŠ”ê°€? Ex. ì‚¬ë‹¤ë¦¬ í•„ìš”ì—¬ë¶€</td>
            <td></td><td></td><td></td><td class="miti-cell"></td><td></td>
          </tr>
          <tr><td>ë³´ì˜¨ì¬ íƒˆê±° ë° ì œê±°ë¥¼ ê³ ê°ì¸¡ ë˜ëŠ” ì „ë¬¸ì ì¸¡ ì¸ì›ì´ ìˆ˜í–‰í•˜ëŠ”ê°€?</td><td></td><td></td><td></td><td class="miti-cell"></td><td></td></tr>
          <tr><td>ì§ì ‘ íƒˆê±° ë° ì œê±°ë¥¼ í•  ê²½ìš° ë² ì„ë°©ì§€ ì¥ê°‘ ì°©ìš©, ë³´ì•ˆê²½ ì°©ìš© ë“± ì•ˆì „ê·œì •ì„ ì§€í‚¤ëŠ”ê°€?</td><td></td><td></td><td></td><td class="miti-cell"></td><td></td></tr>
          <tr><td>ê¸°ì¡´ ì˜¨ë„ì„¼ì„œ ì œê±° ë° ìì‚¬ ì˜¨ë„ì„¼ì„œ ë¶€ì°© ì‹œ ë°°ê´€ ë‚´ ì••ë ¥ì— ì˜í•´ ë¬¸ì œê°€ ìƒê¸¸ ìˆ˜ ìˆëŠ”ê°€?</td><td></td><td></td><td></td><td class="miti-cell"></td><td></td></tr>
          <tr id="works-last-fixed"><td>220V ì´ìƒ ì „ì›ì´ ìˆëŠ” ì¥ì†Œì—ì„œ ì‘ì—…ì„ í•˜ëŠ”ê°€?</td><td></td><td></td><td></td><td class="miti-cell"></td><td></td></tr>

          <!-- ê¸°íƒ€ -->
          <tr id="misc-section-row">
            <td id="misc-section-cell" class="section" rowspan="1">
              <div class="section-cell">
                <div class="section-title">ê¸°íƒ€</div>
                <div class="section-actions">
                  <button id="addMiscRow" class="secondary mini" type="button">+</button>
                  <button id="removeMiscRow" class="warn mini" type="button">-</button>
                </div>
              </div>
            </td>
            <td></td><td></td><td></td><td></td>
            <td class="miti-cell"></td><td></td>
          </tr>
        </tbody>
      </table>
    </div>
  </section>

  <!-- 3) ì„œëª…ë€ -->
  <section id="approvalSection" class="card page-block page-start">
    <h2>í˜„ì¥ í™•ì¸ ë° ìŠ¹ì¸ ì„œëª…</h2>
    <div style="display:grid; grid-template-columns:repeat(4, 1fr); gap:8px">
      <div class="sig-box">
        <label>í˜„ì¥ê´€ë¦¬ì</label>
        <input id="sigNameSafety" type="text" placeholder="ì„±ëª…" class="field">
        <div class="signature" style="margin-top:6px"><canvas id="sigCanvasSafety"></canvas></div>
        <div style="margin-top:6px"><button class="secondary" id="clearSigSafety" type="button">Clear</button></div>
      </div>
      <div class="sig-box">
        <label>ì‹¤ë¬´ì1</label>
        <input id="sigNameW1" type="text" placeholder="ì„±ëª…" class="field">
        <div class="signature" style="margin-top:6px"><canvas id="sigCanvasW1"></canvas></div>
        <div style="margin-top:6px"><button class="secondary" id="clearSigW1" type="button">Clear</button></div>
      </div>
      <div class="sig-box">
        <label>ì‹¤ë¬´ì2</label>
        <input id="sigNameW2" type="text" placeholder="ì„±ëª…" class="field">
        <div class="signature" style="margin-top:6px"><canvas id="sigCanvasW2"></canvas></div>
        <div style="margin-top:6px"><button class="secondary" id="clearSigW2" type="button">Clear</button></div>
      </div>
      <div class="sig-box">
        <label>ì‹¤ë¬´ì3</label>
        <input id="sigNameW3" type="text" placeholder="ì„±ëª…" class="field">
        <div class="signature" style="margin-top:6px"><canvas id="sigCanvasW3"></canvas></div>
        <button id="printPDF" class="secondary" type="button" title="PDFë¡œ ë‚´ë³´ë‚´ê¸°">PDF</button>
        <div style="margin-top:6px"><button class="secondary" id="clearSigW3" type="button">Clear</button></div>
      </div>
    </div>
  </section>
</main>

<script>
const byId = (id)=>document.getElementById(id);
const qs = (sel)=>document.querySelector(sel);
const qsa = (sel)=>Array.from(document.querySelectorAll(sel));

document.addEventListener('DOMContentLoaded', ()=>{
  document.querySelectorAll('thead th.th-center').forEach((th)=>{ th.style.textAlign = 'center'; });
});

function injectCheckbox(cell, colKey, labelText){
  const input=document.createElement("input");
  input.type="checkbox"; input.className="riskchk";
  input.setAttribute("data-col", colKey); input.setAttribute("title", labelText);
  const wrap=document.createElement("label");
  wrap.className="chk-wrap"; wrap.appendChild(input);
  cell.innerHTML=""; cell.appendChild(wrap);
  return input;
}
function injectTextarea(cell){
  const ta=document.createElement("textarea");
  ta.className="cell-input"; ta.setAttribute("rows","1");
  function autosize(){ ta.style.height="auto"; ta.style.height=(ta.scrollHeight)+"px"; }
  ta.addEventListener("input", autosize); setTimeout(autosize,0);
  cell.innerHTML=""; cell.appendChild(ta);
  return ta;
}
function injectMitiInput(cell){
  cell.innerHTML=""; cell.classList.add("miti-cell");
  const ui=document.createElement("div"); ui.className="miti-ui";
  const sel=document.createElement("select"); sel.className="miti-select";
  sel.innerHTML = `
    <option value="">ì„ íƒ</option>
    <option value="ì™„ë£Œ">ì•ˆì „ ì¡°ì¹˜ ì™„ë£Œ</option>
    <option value="ì…ë ¥">ì‚¬ìš©ì ì…ë ¥</option>
  `;
  const user=document.createElement("input");
  user.type="text"; user.className="miti-user"; user.placeholder=""; user.style.display="none";
  const printDiv=document.createElement("div"); printDiv.className="miti-print";
  function sync(){
    const v = sel.value;
    if(v === "ì™„ë£Œ"){
      user.style.display="none";
      printDiv.textContent = "ì•ˆì „ ì¡°ì¹˜ ì™„ë£Œ";
    }else if(v === "ì…ë ¥"){
      user.style.display="block";
      printDiv.textContent = user.value || "";
    }else{
      user.style.display="none";
      printDiv.textContent = ""; // ë””í´íŠ¸ 'ì„ íƒ'ì€ ì¸ì‡„/ë‚´ë³´ë‚´ê¸°ì—ì„œ ê³µë°±
    }
  }
  sel.addEventListener("change", sync);
  user.addEventListener("input", sync);
  setTimeout(sync,0);
  ui.appendChild(sel); ui.appendChild(user);
  cell.appendChild(ui); cell.appendChild(printDiv);
  return sel;
}
function initRiskRow(tr){
  const tds=tr.querySelectorAll("td"); const len=tds.length; if(len<6) return;
  const idxHaz = (len===7 ? 1 : 0);
  const idxOk  = idxHaz + 1;
  const idxFix = idxHaz + 2;
  const idxNa  = idxHaz + 3;
  const idxMiti= idxHaz + 4;
  const idxDone= idxHaz + 5;

  const isPrepMaster = tr.id === "prep-master-row";
  if(isPrepMaster){
    if(!tds[idxNa].querySelector(".riskchk")) injectCheckbox(tds[idxNa], "na", "í•´ë‹¹ì—†ìŒ");
  } else {
    if(!tds[idxOk ].querySelector(".riskchk")) injectCheckbox(tds[idxOk ], "ok",  "ì ì •");
    if(!tds[idxFix].querySelector(".riskchk")) injectCheckbox(tds[idxFix], "fix", "ë³´ì™„");
    if(!tds[idxNa ].querySelector(".riskchk")) injectCheckbox(tds[idxNa ], "na",  "í•´ë‹¹ì—†ìŒ");
    const rowChks=tr.querySelectorAll(".riskchk");
    rowChks.forEach((chk)=>{
      chk.addEventListener("change", ()=>{
        if(chk.checked && (chk.dataset.col==="ok" || chk.dataset.col==="fix" || chk.dataset.col==="na")){
          rowChks.forEach((other)=>{
            if(other!==chk && (other.dataset.col==="ok" || other.dataset.col==="fix" || other.dataset.col==="na")) other.checked=false;
          });
        }
      });
    });
  }
  if(!tds[idxDone].querySelector(".riskchk")) injectCheckbox(tds[idxDone], "done", "í™•ì¸");
  if(!tds[idxMiti].querySelector(".miti-select")) injectMitiInput(tds[idxMiti]);
  if(idxHaz>=0 && tds[idxHaz].textContent.trim()==="" && !tds[idxHaz].querySelector(".cell-input")){
    injectTextarea(tds[idxHaz]);
  }
}
function initRiskTable(){ document.querySelectorAll("#riskTable tbody tr").forEach(initRiskRow); }

const PREP_BASE_ROWS  = 8;
const WORKS_BASE_ROWS = 5;
const MISC_BASE_ROWS  = 1;

function adjustRowspan(cellId, base, delta){
  const td = byId(cellId); if(!td) return;
  const cur = td.rowSpan || base;
  let next = cur + delta;
  if(next < base) next = base;
  td.rowSpan = next;
}
function addPrepRow(){
  try{
    const tbody = qs("#riskTable tbody"), lastFixed = byId("prep-last-fixed");
    if(!tbody || !lastFixed) return;
    let insertAfter = lastFixed;
    while(insertAfter.nextElementSibling &&
          insertAfter.nextElementSibling.classList &&
          insertAfter.nextElementSibling.classList.contains("prep-extra-row")){
      insertAfter = insertAfter.nextElementSibling;
    }
    const tr = document.createElement("tr"); tr.className = "prep-extra-row";
    tr.innerHTML = '<td></td><td></td><td></td><td></td><td class="miti-cell"></td><td></td>';
    tbody.insertBefore(tr, insertAfter ? insertAfter.nextElementSibling : null);
    const tds = tr.querySelectorAll("td");
    injectTextarea(tds[0]); injectMitiInput(tds[4]); initRiskRow(tr);
    adjustRowspan("prep-section-cell", PREP_BASE_ROWS, +1);
  }catch(e){
    console.error(e);
    alert("ì‚¬ì „ì¤€ë¹„ ì‘ì—… í–‰ ì¶”ê°€ ì¤‘ ì˜¤ë¥˜: " + (e && e.message ? e.message : e));
  }
}
function removePrepRow(){
  try{
    const tbody = qs("#riskTable tbody"); if(!tbody) return;
    let lastExtra = null, node = tbody.lastElementChild;
    while(node){
      if(node.classList && node.classList.contains("prep-extra-row")){ lastExtra = node; break; }
      node = node.previousElementSibling;
    }
    if(!lastExtra){ alert("ì‚¬ì „ì¤€ë¹„ ì„¹ì…˜ì— ì‚­ì œí•  ì¶”ê°€ í–‰ì´ ì—†ìŠµë‹ˆë‹¤."); return; }
    tbody.removeChild(lastExtra);
    adjustRowspan("prep-section-cell", PREP_BASE_ROWS, -1);
  }catch(e){
    console.error(e);
    alert("ì‚¬ì „ì¤€ë¹„ ì‘ì—… í–‰ ì‚­ì œ ì¤‘ ì˜¤ë¥˜: " + (e && e.message ? e.message : e));
  }
}
function addWorkRow(){
  try{
    const tbody = qs("#riskTable tbody"), lastFixed = byId("works-last-fixed");
    if(!tbody || !lastFixed) return;
    let insertAfter = lastFixed;
    while(insertAfter.nextElementSibling &&
          insertAfter.nextElementSibling.classList &&
          insertAfter.nextElementSibling.classList.contains("extra-work-row")){
      insertAfter = insertAfter.nextElementSibling;
    }
    const tr = document.createElement("tr"); tr.className = "extra-work-row";
    tr.innerHTML = '<td></td><td></td><td></td><td></td><td class="miti-cell"></td><td></td>';
    tbody.insertBefore(tr, insertAfter ? insertAfter.nextElementSibling : null);
    const tds = tr.querySelectorAll("td");
    injectTextarea(tds[0]); injectMitiInput(tds[4]); initRiskRow(tr);
    adjustRowspan("task-works-label", WORKS_BASE_ROWS, +1);
  }catch(e){ console.error(e); alert("ì‘ì—…ì‹œ í–‰ ì¶”ê°€ ì¤‘ ì˜¤ë¥˜: " + (e && e.message ? e.message : e)); }
}
function removeWorkRow(){
  try{
    const tbody = qs("#riskTable tbody"); if(!tbody) return;
    let lastExtra = null, node = tbody.lastElementChild;
    while(node){
      if(node.classList && node.classList.contains("extra-work-row")){ lastExtra = node; break; }
      node = node.previousElementSibling;
    }
    if(!lastExtra){ alert("ì‘ì—…ì‹œ ì„¹ì…˜ì— ì‚­ì œí•  ì¶”ê°€ í–‰ì´ ì—†ìŠµë‹ˆë‹¤."); return; }
    tbody.removeChild(lastExtra);
    adjustRowspan("task-works-label", WORKS_BASE_ROWS, -1);
  }catch(e){
    console.error(e); alert("ì‘ì—…ì‹œ ì¶”ê°€ í–‰ ì‚­ì œ ì¤‘ ì˜¤ë¥˜: " + (e && e.message ? e.message : e));
  }
}
function addMiscRow(){
  try{
    const tbody = qs("#riskTable tbody"), miscHead = byId("misc-section-row");
    if(!tbody || !miscHead) return;
    let insertAfter = miscHead;
    while(insertAfter.nextElementSibling &&
          insertAfter.nextElementSibling.classList &&
          insertAfter.nextElementSibling.classList.contains("misc-extra-row")){
      insertAfter = insertAfter.nextElementSibling;
    }
    const tr = document.createElement("tr"); tr.className = "misc-extra-row";
    tr.innerHTML = '<td></td><td></td><td></td><td></td><td class="miti-cell"></td><td></td>';
    tbody.insertBefore(tr, insertAfter ? insertAfter.nextElementSibling : null);
    const tds = tr.querySelectorAll("td");
    injectTextarea(tds[0]); injectMitiInput(tds[4]); initRiskRow(tr);
    adjustRowspan("misc-section-cell", MISC_BASE_ROWS, +1);
  }catch(e){ console.error(e); alert("ê¸°íƒ€ ì„¹ì…˜ í–‰ ì¶”ê°€ ì¤‘ ì˜¤ë¥˜: " + (e && e.message ? e.message : e)); }
}
function removeMiscRow(){
  try{
    const tbody = qs("#riskTable tbody"); if(!tbody) return;
    let lastExtra = null, node = tbody.lastElementChild;
    while(node){
      if(node.classList && node.classList.contains("misc-extra-row")){ lastExtra = node; break; }
      node = node.previousElementSibling;
    }
    if(!lastExtra){ alert("ê¸°íƒ€ ì„¹ì…˜ì— ì‚­ì œí•  ì¶”ê°€ í–‰ì´ ì—†ìŠµë‹ˆë‹¤."); return; }
    tbody.removeChild(lastExtra);
    adjustRowspan("misc-section-cell", MISC_BASE_ROWS, -1);
  }catch(e){
    console.error(e); alert("ê¸°íƒ€ ì„¹ì…˜ í–‰ ì‚­ì œ ì¤‘ ì˜¤ë¥˜: " + (e && e.message ? e.message : e));
  }
}

/* â€˜í•´ë‹¹ì—†ìŒâ€™ ì²´í¬ ì‹œ ì‚¬ì „ì¤€ë¹„ í•˜ì´í”ˆ ì„œë¸Œí–‰ ì „ì²´ ì ê¸ˆ/í•´ì œ(í™•ì¸+ë³´ì™„ëŒ€ì±… í¬í•¨) */
function setPrepSubRowsDisabled(disabled){
  qsa("#riskTable tbody tr.prep-sub-row").forEach((row)=>{
    ["ok","fix","na","done"].forEach((colKey)=>{
      const chk=row.querySelector('input.riskchk[data-col="'+colKey+'"]');
      if(chk){ if(disabled){ chk.checked=false; } chk.disabled=!!disabled; }
    });
    const sel=row.querySelector('.miti-select');
    const user=row.querySelector('.miti-user');
    if(sel){ sel.disabled=!!disabled; }
    if(user){ user.disabled=!!disabled; }
  });
}
function initPrepRowLogic(){
  const master=byId("prep-master-row"); if(!master) return;
  function evalState(){
    const na = master.querySelector('input.riskchk[data-col="na"]');
    const disabled = !!(na && na.checked);
    setPrepSubRowsDisabled(disabled);
  }
  qsa('#prep-master-row input.riskchk[data-col="na"]').forEach((chk)=>{ chk.addEventListener("change", evalState); });
  evalState();
}

/* ì„œëª… íŒ¨ë“œ */
function initSignature(canvasId, clearBtnId){
  const cvs=byId(canvasId), btn=byId(clearBtnId); if(!cvs) return;
  const ctx=cvs.getContext('2d');
  function resize(){
    const ratio=Math.max((window.devicePixelRatio || 1), 1);
    const rect=cvs.getBoundingClientRect(); const w=Math.floor(rect.width*ratio), h=Math.floor(rect.height*ratio);
    cvs.width=w; cvs.height=h; ctx.setTransform(1,0,0,1,0,0); ctx.scale(ratio,ratio);
    ctx.lineWidth=2; ctx.lineJoin='round'; ctx.lineCap='round'; ctx.strokeStyle='#111827';
    ctx.clearRect(0,0,w,h);
  }
  let drawing=false, last=null;
  function getPos(e){ const r=cvs.getBoundingClientRect(); const t=(e.touches&&e.touches[0]) || null; return t?{x:t.clientX-r.left, y:t.clientY-r.top}:{x:e.clientX-r.left, y:e.clientY-r.top}; }
  function start(e){ if(e&&e.preventDefault) e.preventDefault(); drawing=true; last=getPos(e); }
  function move (e){ if(!drawing) return; if(e&&e.preventDefault) e.preventDefault(); const p=getPos(e); ctx.beginPath(); ctx.moveTo(last.x,last.y); ctx.lineTo(p.x,p.y); ctx.stroke(); last=p; }
  function end (){ drawing=false; last=null; }
  cvs.addEventListener('mousedown',start); cvs.addEventListener('mousemove',move); window.addEventListener('mouseup',end);
  cvs.addEventListener('touchstart',start,{passive:false}); cvs.addEventListener('touchmove',move,{passive:false}); cvs.addEventListener('touchend',end);
  window.addEventListener('resize',resize); resize();
  if(btn){ btn.addEventListener('click', ()=>{ ctx.clearRect(0,0,cvs.width,cvs.height); }); }
}

/* ìƒë‹¨ ì„±ëª… â†’ í•˜ë‹¨ ì„œëª…ë€ ì´ë¦„ ìë™ ë°˜ì˜ */
function syncSigFromMeta(){
  [
    {src:"fSafety",  dst:"sigNameSafety"},
    {src:"fWorker1", dst:"sigNameW1"},
    {src:"fWorker2", dst:"sigNameW2"},
    {src:"fWorker3", dst:"sigNameW3"}
  ].forEach((m)=>{
    const s=byId(m.src), d=byId(m.dst); if(!s || !d) return;
    d.value = s.value || "";
    ["input","change"].forEach((ev)=>{ s.addEventListener(ev, ()=>{ d.value = s.value || ""; }); });
  });
}

/* ğŸ“± ëª¨ë°”ì¼: ìœ í•´ìš”ì¸/ë³´ì™„ëŒ€ì±… í­ ë™ì¼ ìœ ì§€ */
function equalizeHazardMitiWidth(){
  const isMobile = window.matchMedia("(max-width: 800px), (pointer:coarse)").matches;
  const styleId = "dyn-mobile-cols";
  let styleEl = document.getElementById(styleId);
  if(!styleEl){ styleEl = document.createElement("style"); styleEl.id = styleId; document.head.appendChild(styleEl); }
  if(!isMobile){ styleEl.textContent=""; return; }
  try{
    const tb = document.getElementById("riskTable"); if(!tb || !tb.tBodies.length) return;
    const firstRow = tb.tBodies[0].rows[0]; if(!firstRow || firstRow.cells.length < 2) return;
    const hazardCell = firstRow.cells[1];
    const width = Math.round(hazardCell.getBoundingClientRect().width);
    if(width>0){ styleEl.textContent = `@media (max-width:800px), (pointer:coarse){ col.c-miti{ width:${width}px !important; } }`; }
  }catch(e){ /* silent */ }
}

/* ğŸ–¨ï¸ ì¸ì‡„ ì‹œ ê°€ë¡œ/ì„¸ë¡œ ê°ì§€ â†’ ì—´ í­ í´ë˜ìŠ¤ ë¶€ì—¬ */
function setPrintOrientationClass(){
  try{
    const isLandscape = (window.matchMedia && window.matchMedia("(orientation: landscape)").matches) || (window.innerWidth > window.innerHeight);
    const rootEl = document.documentElement;
    if(isLandscape){ rootEl.classList.add("print-landscape"); rootEl.classList.remove("print-portrait"); }
    else{           rootEl.classList.add("print-portrait");  rootEl.classList.remove("print-landscape"); }
  }catch(e){ /* silent */ }
}
function clearPrintOrientationClass(){
  const rootEl = document.documentElement;
  rootEl.classList.remove("print-landscape");
  rootEl.classList.remove("print-portrait");
}

/* ğŸ”§ ì¸ì‡„ ì§ì „: ë¸”ë¡ ìë™ ì¶•ì†Œ + ì¸ì‡„ í…ìŠ¤íŠ¸ ë™ê¸°í™” */
function scalePageBlocksForPrint(){
  try{
    const blocks = qsa('.page-block');
    const viewportH = window.innerHeight || document.documentElement.clientHeight || 0;
    const marginComp = 40;
    const usableH = Math.max(0, viewportH - marginComp);
    blocks.forEach(block=>{
      block.style.transform = ''; block.style.width = '';
      const rect = block.getBoundingClientRect(); const h = rect.height;
      if(usableH > 0 && h > usableH){
        let scale = usableH / h;
        scale = Math.max(0.8, Math.min(1.0, scale));
        block.style.transform = `scale(${scale})`;
        block.style.transformOrigin = 'top left';
        block.style.width = `calc(100% / ${scale})`;
      }
    });
    qsa('.miti-cell').forEach(cell=>{
      const sel = cell.querySelector('.miti-select');
      const user = cell.querySelector('.miti-user');
      const p = cell.querySelector('.miti-print');
      if(!p || !sel) return;
      const v = sel.value;
      if(v === 'ì™„ë£Œ'){ p.textContent = 'ì•ˆì „ ì¡°ì¹˜ ì™„ë£Œ'; }
      else if(v === 'ì…ë ¥'){ p.textContent = (user && user.value) ? user.value : ''; }
      else { p.textContent = ''; }
    });
  }catch(e){ /* silent */ }
}
function resetBlockScaleAfterPrint(){
  qsa('.page-block').forEach(block=>{
    block.style.transform = '';
    block.style.width = '';
  });
}

/* âœ… ëª¨ë°”ì¼ í”„ë¦°íŠ¸ íŒì—… ë°©ì§€ ë¡œì§: ì‚¬ìš©ì ì œìŠ¤ì²˜ ë‚´ 1íšŒ í˜¸ì¶œ */
function attachSafePrint(btn){
  if(!btn) return;
  let printing = false;
  const handler = (ev)=>{
    if(printing) return;
    printing = true;
    try { window.print(); } catch (e) { /* no retry */ }
    finally { setTimeout(()=>{ printing = false; }, 1200); }
  };
  btn.addEventListener("click", handler, {passive:false});
}

/* í™•ì¸ í—¤ë” ë§ˆìŠ¤í„° ì²´í¬: í™•ì¸ ì—´ ì „ì²´ í† ê¸€ (ë¹„í™œì„±í™” ì œì™¸) */
function initConfirmMaster(){
  const master = byId("chkConfirmAll"); if(!master) return;
  master.addEventListener("change", ()=>{
    const state = !!master.checked;
    qsa('input.riskchk[data-col="done"]').forEach((chk)=>{
      if(!chk.disabled){ chk.checked = state; }
    });
  });
}

/* ì´ˆê¸°í™”(íšŒì‚¬ëª… ì œì™¸) + ë™ì  í–‰/rowSpan ë³µêµ¬ */
function resetToMaster(){
  try{
    qsa('.riskchk').forEach((chk)=>{ chk.checked=false; chk.disabled=false; });
    qsa('input[type="text"], input[type="date"], textarea').forEach((el)=>{
      if(el.id === "fCompany") return;
      el.value = "";
    });
    qsa('.miti-select').forEach((sel)=>{ sel.value=""; });
    qsa('.miti-user').forEach((inp)=>{ inp.value=""; inp.style.display="none"; });
    qsa('.miti-print').forEach((el)=>{ el.textContent=""; });
    ["sigCanvasSafety","sigCanvasW1","sigCanvasW2","sigCanvasW3"].forEach((cid)=>{
      const cvs=byId(cid); if(!cvs) return; const ctx=cvs.getContext('2d'); ctx.clearRect(0,0,cvs.width,cvs.height);
    });
    qsa(".prep-extra-row").forEach((r)=>{ r.remove(); });
    qsa(".extra-work-row").forEach((r)=>{ r.remove(); });
    qsa(".misc-extra-row").forEach((r)=>{ r.remove(); });
    const prepCell = byId("prep-section-cell");  if(prepCell)  prepCell.rowSpan  = PREP_BASE_ROWS;
    const worksCell= byId("task-works-label");   if(worksCell) worksCell.rowSpan = WORKS_BASE_ROWS;
    const miscCell = byId("misc-section-cell");  if(miscCell)  miscCell.rowSpan  = MISC_BASE_ROWS;
    setTimeout(equalizeHazardMitiWidth, 50);
  }catch(e){
    console.error(e); alert("ì´ˆê¸°í™” ì¤‘ ì˜¤ë¥˜: " + (e && e.message ? e.message : e));
  }
}

/* ì¸ì‡„ ì´ë²¤íŠ¸ */
window.addEventListener('beforeprint', ()=>{
  setPrintOrientationClass();
  scalePageBlocksForPrint();
});
window.addEventListener('afterprint', ()=>{
  clearPrintOrientationClass();
  resetBlockScaleAfterPrint();
});

/* âœ… PDF Blob ìƒì„± â†’ ìƒˆ íƒ­(ë¸Œë¼ìš°ì € PDF ë·°ì–´)ë¡œ ì—´ê¸° â€” ë‚´ë³´ë‚´ê¸° ëª¨ë“œ ì ìš© */
async function openPdfViewerTab(){
  document.documentElement.classList.add('export-mode');
  try{
    setPrintOrientationClass();
    scalePageBlocksForPrint();
    qsa('.miti-cell').forEach(cell=>{
      const sel  = cell.querySelector('.miti-select');
      const user = cell.querySelector('.miti-user');
      const p    = cell.querySelector('.miti-print');
      if(!p || !sel) return;
      const v = sel.value;
      if(v === 'ì™„ë£Œ'){ p.textContent = 'ì•ˆì „ ì¡°ì¹˜ ì™„ë£Œ'; }
      else if(v === 'ì…ë ¥'){ p.textContent = (user && user.value) ? user.value : ''; }
      else { p.textContent = ''; }
    });

    const opt = {
      margin: 15,
      filename: 'ìœ„í—˜ì„±_í‰ê°€í‘œ.pdf',
      image: { type: 'jpeg', quality: 0.98 },
      html2canvas: { scale: 2, useCORS: true },
      jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
    };
    const blob = await html2pdf().set(opt).from(document.body).toPdf().output('blob');
    const url  = URL.createObjectURL(blob);
    window.open(url, '_blank');
  }catch(e){
    alert('PDF ë·°ì–´ ì—´ê¸° ì¤‘ ì˜¤ë¥˜: ' + (e && e.message ? e.message : e));
  }finally{
    document.documentElement.classList.remove('export-mode');
    clearPrintOrientationClass();
    resetBlockScaleAfterPrint();
  }
}

/* âœ… ê³µìœ : ê°€ëŠ¥í•˜ë©´ OS ê³µìœ  ì‹œíŠ¸(ì¹´ì¹´ì˜¤í†¡/ë©”ì¼) â†’ ë¯¸ì§€ì›/HTTPë©´ ë·°ì–´/ë‹¤ìš´ë¡œë“œ í´ë°± */
async function sharePdfDirect(){
  const isHttps = location.protocol === 'https:';
  document.documentElement.classList.add('export-mode');
  try{
    setPrintOrientationClass();
    scalePageBlocksForPrint();
    qsa('.miti-cell').forEach(cell=>{
      const sel=cell.querySelector('.miti-select');
      const user=cell.querySelector('.miti-user');
      const p=cell.querySelector('.miti-print');
      if(!p || !sel) return;
      p.textContent = sel.value === 'ì™„ë£Œ' ? 'ì•ˆì „ ì¡°ì¹˜ ì™„ë£Œ'
                   : sel.value === 'ì…ë ¥' ? (user && user.value ? user.value : '')
                   : '';
    });

    const opt = {
      margin: 15, filename: 'ìœ„í—˜ì„±_í‰ê°€í‘œ.pdf',
      image: { type: 'jpeg', quality: 0.98 },
      html2canvas: { scale: 2, useCORS: true },
      jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
    };
    const blob = await html2pdf().set(opt).from(document.body).toPdf().output('blob');

    // Web Share API íŒŒì¼ ê³µìœ  ì‹œë„(HTTPS + ì§€ì› ë¸Œë¼ìš°ì €)
    const file = new File([blob], 'ìœ„í—˜ì„±_í‰ê°€í‘œ.pdf', { type: 'application/pdf' });
    const data = { files: [file], title: 'ìœ„í—˜ì„± í‰ê°€í‘œ', text: 'PDF ê³µìœ ' };

    if (isHttps && 'canShare' in navigator && navigator.canShare(data)) {
      try {
        await navigator.share(data); // OS ê³µìœ  ì‹œíŠ¸ â†’ ì¹´ì¹´ì˜¤í†¡Â·ë©”ì¼ ì„ íƒ
      } catch(e) {
        if (e.name !== 'AbortError') alert('ê³µìœ  ì¤‘ ì˜¤ë¥˜: ' + (e.message || e));
      }
    } else {
      // í´ë°±: ìƒˆ íƒ­(ë¸Œë¼ìš°ì € PDF ë·°ì–´) ë˜ëŠ” ë‹¤ìš´ë¡œë“œ ë§í¬
      const url = URL.createObjectURL(blob);
      // ìƒˆ íƒ­ ë·°ì–´ ì—´ê¸°
      window.open(url, '_blank');
      // í•„ìš” ì‹œ ë‹¤ìš´ë¡œë“œê¹Œì§€ ì œê³µí•˜ë ¤ë©´ ë‹¤ìŒ ì£¼ì„ì„ í•´ì œ:
      // const a = document.createElement('a'); a.download = file.name; a.href = url; a.click();
      // setTimeout(()=>URL.revokeObjectURL(url), 1000);
    }
  }catch(e){
    alert('ê³µìœ  ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜: ' + (e && e.message ? e.message : e));
  }finally{
    document.documentElement.classList.remove('export-mode');
    clearPrintOrientationClass();
    resetBlockScaleAfterPrint();
  }
}

function initAll(){
  try{
    /* ì„ íƒ: ë¡œì»¬ìŠ¤í† ë¦¬ì§€ ë³µì› */
    try{
      const raw=localStorage.getItem("hra-risk-mobile-v3");
      if(raw){
        const doc=JSON.parse(raw);
        ["fSiteName","fDiagStart","fDiagEnd","fWrittenDate","fSafety","fWorker1","fWorker2","fWorker3","fRemark"].forEach((id)=>{
          const el=byId(id); if(!el) return;
          const keyMap={fSiteName:"siteName",fDiagStart:"diagStart",fDiagEnd:"diagEnd",fWrittenDate:"writtenDate",fSafety:"safetyManager",
                        fWorker1:"worker1",fWorker2:"worker2",fWorker3:"worker3",fRemark:"remark"};
          const k=keyMap[id]; el.value = (doc.meta && doc.meta[k]) || "";
        });
        const c=byId("fCompany"); if(c) c.value = (doc.meta && doc.meta.companyName) || c.value || "LGì „ì ESì—ë„ˆì§€ì»¨ì„¤íŒ…íŒ€";
      }
    }catch(e){ /* ë¬´ì‹œ */ }

    const btnPrint     = byId("printPDF"),        btnClear      = byId("clearAll");
    const btnPrepAdd   = byId("btnPrepAdd"),      btnPrepRemove = byId("btnPrepRemove");
    const btnWorksAdd  = byId("btnWorksAdd"),     btnWorksRemove= byId("btnWorksRemove");
    const btnMiscAdd   = byId("addMiscRow"),      btnMiscRemove = byId("removeMiscRow");
    const btnOpenViewer= byId("openViewer");
    const btnShare     = byId("sharePDF");

    attachSafePrint(btnPrint);
    if(btnClear){ btnClear.addEventListener("click", ()=>{ if(confirm("ì´ˆê¸°í™” í•˜ì‹œê² ìŠµë‹ˆê¹Œ? ì €ì¥ëœ ë°ì´í„°ê°€ ì‚­ì œë©ë‹ˆë‹¤.")){ resetToMaster(); } }); }
    if(btnPrepAdd)    btnPrepAdd   .addEventListener("click", addPrepRow);
    if(btnPrepRemove) btnPrepRemove.addEventListener("click", removePrepRow);
    if(btnWorksAdd)   btnWorksAdd  .addEventListener("click", addWorkRow);
    if(btnWorksRemove)btnWorksRemove.addEventListener("click", removeWorkRow);
    if(btnMiscAdd)    btnMiscAdd   .addEventListener("click", addMiscRow);
    if(btnMiscRemove) btnMiscRemove.addEventListener("click", removeMiscRow);

    // ìƒˆ íƒ­ ë·°ì–´ ì—´ê¸°
    if(btnOpenViewer){ btnOpenViewer.addEventListener("click", openPdfViewerTab); }
    // OS ê³µìœ  ì‹œíŠ¸ (ê°€ëŠ¥ ì‹œ) + í´ë°±
    if(btnShare){ btnShare.addEventListener("click", sharePdfDirect); }

    initRiskTable();
    initPrepRowLogic();
    initConfirmMaster();

    initSignature('sigCanvasSafety','clearSigSafety');
    initSignature('sigCanvasW1','clearSigW1');
    initSignature('sigCanvasW2','clearSigW2');
    initSignature('sigCanvasW3','clearSigW3');

    syncSigFromMeta();
    setTimeout(equalizeHazardMitiWidth, 50);
    window.addEventListener("resize", ()=>{ requestAnimationFrame(equalizeHazardMitiWidth); });
    window.addEventListener("orientationchange", equalizeHazardMitiWidth);
  }catch(e){
    console.error(e); alert("ê¸°ëŠ¥ ì´ˆê¸°í™” ì¤‘ ì˜¤ë¥˜: " + (e && e.message ? e.message : e));
  }
}
window.addEventListener("DOMContentLoaded", initAll);
</script>
</body>
</html>
'@

# íŒŒì¼ ì“°ê¸°
Set-Content -Path $indexPath -Value $html -Encoding UTF8

# í°íŠ¸ ë³µì‚¬(ìˆì„ ê²½ìš°)
$fontFiles = @("LGSmartRegular.woff2","LGSmartRegular.woff")
foreach($f in $fontFiles){
  $src = Join-Path $PSScriptRoot $f
  $dst = Join-Path $OutDir $f
  if(Test-Path $src){ Copy-Item -LiteralPath $src -Destination $dst -Force }
}

# í•´ì‹œ ì¶œë ¥(ì„ íƒ)
if ($Hash) {
  try {
    $h = Get-FileHash -LiteralPath $indexPath -Algorithm SHA256
    Write-Host ("SHA256: " + $h.Hash)
  } catch {
    Write-Warning "SHA256 í•´ì‹œ ê³„ì‚° ì‹¤íŒ¨: $($_.Exception.Message)"
  }
}

# ìë™ ì—´ê¸°(ì„ íƒ)
if ($Open) {
  try {
    Start-Process $indexPath
    Write-Host "ìƒì„± ì™„ë£Œ: $indexPath (ìë™ ì—´ê¸°)"
  } catch {
    Write-Warning "ìƒì„±ì€ ì™„ë£Œë˜ì—ˆì§€ë§Œ ìë™ ì—´ê¸°ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. íŒŒì¼ì„ ì§ì ‘ ë”ë¸”í´ë¦­ í•´ì£¼ì„¸ìš”."
  }
} else {
  Write-Host "ìƒì„± ì™„ë£Œ: $indexPath"
}
``
