<!DOCTYPE html>

<html lang="en">

<head>
  <meta charset="utf-8" />
  <meta content="width=device-width, initial-scale=1, viewport-fit=cover" name="viewport" />
  <title>LGE SAC Commissioning Report</title>
  <style>
    :root {
      --bg: #f7f9fc;
      --card: #ffffff;
      --text: #0f172a;
      --muted: #475569;
      --accent: #A50034;
      /* LG Red */
      --accent-2: #6b0022;
      --danger: #b91c1c;
      --ok: #16a34a;
      --ng: #dc2626;
      --border: #e2e8f0;
    }

    html,
    body {
      height: 100%;
    }

    body {
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
      margin: 0;
      background: var(--bg);
      color: var(--text);
    }

    .container {
      max-width: 960px;
      margin: 0 auto;
      padding: 12px;
    }

    header {
      position: sticky;
      top: 0;
      z-index: 10;
      background: var(--bg);
      backdrop-filter: blur(6px);
      border-bottom: 1px solid var(--border);
    }

    .header-inner {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      padding: 8px 0;
    }

    h1.title {
      font-size: 1.25rem;
      margin: 0;
      font-weight: 700;
    }

    .toggle {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .pill {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 6px 10px;
      border: 1px solid var(--border);
      border-radius: 999px;
      background: var(--card);
    }

    .pill button {
      border: none;
      background: transparent;
      padding: 6px 10px;
      border-radius: 999px;
      cursor: pointer;
      font-weight: 600;
    }

    .pill button.active {
      background: var(--accent);
      color: white;
    }

    .pill .divider {
      width: 1px;
      height: 18px;
      background: var(--border);
    }

    /* Toggle Switch */
    .switch {
      position: relative;
      display: inline-block;
      width: 44px;
      height: 24px;
    }

    .switch input {
      opacity: 0;
      width: 0;
      height: 0;
    }

    .slider {
      position: absolute;
      cursor: pointer;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: #ccc;
      transition: .4s;
      border-radius: 24px;
    }

    .slider:before {
      position: absolute;
      content: "";
      height: 18px;
      width: 18px;
      left: 3px;
      bottom: 3px;
      background-color: white;
      transition: .4s;
      border-radius: 50%;
    }

    input:checked+.slider {
      background-color: var(--accent);
    }

    input:checked+.slider:before {
      transform: translateX(20px);
    }

    .mode-label {
      font-size: 0.85rem;
      font-weight: 600;
      color: var(--muted);
      margin-right: 8px;
    }

    .icon-btn {
      background: transparent;
      border: none;
      cursor: pointer;
      padding: 4px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--muted);
    }

    .icon-btn:hover {
      color: var(--text);
    }

    .icon-btn svg {
      width: 20px;
      height: 20px;
    }

    .btn {
      appearance: none;
      border: none;
      border-radius: 8px;
      padding: 10px 14px;
      font-weight: 600;
      cursor: pointer;
      background: var(--accent);
      color: white;
    }

    .btn.secondary {
      background: #64748b;
      /* Gray */
    }

    .btn.muted {
      background: #94a3b8;
      /* Lighter Gray */
    }

    .btn.danger {
      background: var(--danger);
    }

    .btn.link {
      background: transparent;
      color: var(--accent);
      padding: 0;
      display: inline-block;
    }

    .grid {
      display: grid;
      gap: 12px;
    }

    .card {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 12px;
      box-shadow: 0 1px 2px rgba(0, 0, 0, .04);
      padding: 12px;
    }

    .row {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      align-items: center;
    }

    label {
      font-weight: 600;
      color: var(--muted);
    }

    input[type=text],
    select,
    textarea,
    input[type=date] {
      width: 100%;
      padding: 10px;
      border: 1px solid var(--border);
      border-radius: 8px;
      background: white;
      font-size: 14px;
      box-sizing: border-box;
    }

    textarea {
      min-height: 40px;
      resize: vertical;
      overflow: hidden;
    }

    table {
      width: 100%;
      border-collapse: collapse;
    }

    th,
    td {
      border: 1px solid var(--border);
      padding: 8px;
      font-size: 14px;
    }

    th {
      background: #f1f5f9;
      text-align: left;
    }

    .category {
      break-inside: avoid;
      page-break-inside: avoid;
    }

    .category-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .category-title {
      font-size: 1rem;
      font-weight: 700;
      width: 100%;
      box-sizing: border-box;
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 8px;
      background: white;
    }

    .user-mode .category-title {
      border: none;
      background: transparent;
      pointer-events: none;
      padding: 0 0 0 2px;
      /* Add small padding to prevent first letter cutoff */
    }

    .checklist-item {
      border: 1px dashed var(--border);
      border-radius: 10px;
      padding: 10px;
      margin-top: 8px;
    }

    .product-type-label {
      font-weight: 700;
      color: #334155;
    }

    .status {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .status .ok {
      color: var(--text);
      font-weight: 700;
    }

    .status .ng {
      color: var(--text);
      font-weight: 700;
    }

    .img-strip {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      margin-top: 8px;
    }


    .img-thumb {
      width: 120px;
      height: 90px;
      object-fit: cover;
      border: 1px solid var(--border);
      border-radius: 8px;
      background: #f8fafc;
    }

    .signature-pad {
      border: 1px dashed var(--border);
      background: white;
      border-radius: 8px;
      height: 140px;
      touch-action: none;
      width: 100%;
    }

    .footer {
      display: flex;
      justify-content: flex-end;
      gap: 8px;
      margin: 16px 0;
    }

    .hidden {
      display: none !important;
    }

    /* Mobile-first adjustments */
    @media (min-width: 640px) {
      .two-cols {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 12px;
      }

      .three-cols {
        display: grid;
        grid-template-columns: 1fr 1fr 1fr;
        gap: 12px;
      }
    }

    /* Unified Print Styles */
    @media print {
      @page {
        size: A4 portrait;
        margin: 12mm;
      }

      body {
        background: white;
        margin: 0;
        padding: 0;
        -webkit-print-color-adjust: exact;
        print-color-adjust: exact;
      }

      /* Hide interactive elements */
      .controls,
      .btn,
      .pill,
      .mode-indicator,
      .edit-only,
      .interactive-only,
      .product-type-inline,
      .ref-btn,
      .add-image-btn,
      .switch,
      .icon-btn {
        display: none !important;
      }

      /* Header: Show Title, Hide Controls */
      header {
        display: block !important;
        position: static;
        border-bottom: none;
        margin: 0 0 10px 0;
        padding: 0;
      }

      header .toggle {
        display: none !important;
      }

      /* Layout Reset */
      .container {
        max-width: 100%;
        margin: 0;
        padding: 0;
      }

      .card {
        box-shadow: none;
        border: none;
        padding: 0;
        margin-bottom: 10px;
        page-break-inside: avoid;
        break-inside: avoid;
      }

      /* Use Flex/Block instead of Grid for better page breaks */
      .grid {
        display: block;
      }

      .row {
        display: flex;
        flex-wrap: wrap;
      }

      .two-cols,
      .three-cols {
        display: flex;
        flex-wrap: wrap;
        gap: 12px;
      }

      .two-cols>div,
      .three-cols>div {
        flex: 1;
        min-width: 200px;
      }

      /* Specific Elements */
      .category {
        page-break-inside: avoid;
        break-inside: avoid;
        margin-bottom: 10px;
      }

      .checklist-item {
        border: 1px solid #ddd;
        page-break-inside: avoid;
        break-inside: avoid;
        margin-bottom: 5px;
      }

      .signature-section {
        page-break-inside: avoid;
        break-inside: avoid;
        margin-top: 20px;
      }

      .img-thumb {
        width: 140px;
        height: 105px;
      }

      .signature-pad {
        border: 1px solid #ddd;
      }

      /* Badges */
      .product-type-badge {
        display: inline-block !important;
        border: 1px solid #ccc;
        padding: 2px 6px;
        border-radius: 4px;
        font-size: 0.8em;
        color: #555;
        margin-right: 6px;
      }
    }

    /* PDF Mode (Duplicate of Print Styles for html2pdf) */
    .pdf-mode body {
      background: white;
      margin: 0;
      padding: 0;
      -webkit-print-color-adjust: exact;
      print-color-adjust: exact;
    }

    .pdf-mode .controls,
    .pdf-mode .btn,
    .pdf-mode .pill,
    .pdf-mode .mode-indicator,
    .pdf-mode .edit-only,
    .pdf-mode .interactive-only,
    .pdf-mode .product-type-inline,
    .pdf-mode .ref-btn,
    .pdf-mode .add-image-btn,
    .pdf-mode .switch,
    .pdf-mode .icon-btn {
      display: none !important;
    }

    .pdf-mode header {
      display: block !important;
      position: static;
      border-bottom: none;
      margin: 0 0 10px 0;
      padding: 0;
    }

    .pdf-mode header .toggle {
      display: none !important;
    }

    .pdf-mode .container {
      max-width: 100%;
      margin: 0;
      padding: 0;
    }

    .pdf-mode .card {
      box-shadow: none;
      border: none;
      padding: 0;
      margin-bottom: 10px;
      page-break-inside: avoid;
      break-inside: avoid;
    }

    .pdf-mode .grid {
      display: block;
    }

    .pdf-mode .row {
      display: flex;
      flex-wrap: wrap;
    }

    .pdf-mode .two-cols,
    .pdf-mode .three-cols {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
    }

    .pdf-mode .two-cols>div,
    .pdf-mode .three-cols>div {
      flex: 1;
      min-width: 200px;
    }

    .pdf-mode .category {
      page-break-inside: avoid;
      break-inside: avoid;
      margin-bottom: 10px;
    }

    .pdf-mode .checklist-item {
      border: 1px solid #ddd;
      page-break-inside: avoid;
      break-inside: avoid;
      margin-bottom: 5px;
    }

    .pdf-mode .signature-section {
      page-break-inside: avoid;
      break-inside: avoid;
      margin-top: 20px;
    }

    .pdf-mode .img-thumb {
      width: 140px;
      height: 105px;
    }

    .pdf-mode .signature-pad {
      border: 1px solid #ddd;
    }

    .pdf-mode .product-type-badge {
      display: inline-block !important;
      border: 1px solid #ccc;
      padding: 2px 6px;
      border-radius: 4px;
      font-size: 0.8em;
      color: #555;
      margin-right: 6px;
    }


    .product-type-badge {
      display: none;
    }

    .user-mode .product-type-badge {
      display: inline-block;
      background: #f1f5f9;
      color: #475569;
      padding: 2px 6px;
      border-radius: 4px;
      font-size: 0.75rem;
      font-weight: 600;
      margin-right: 6px;
      vertical-align: middle;
    }

    .user-mode .item-text {
      border: none;
      background: transparent;
      resize: none;
      pointer-events: none;
      /* Optional: prevents clicking/focusing if desired, but readOnly is enough for editing */
    }
  </style>
</head>

<body>
  <header>
    <div class="container header-inner">
      <h1 class="title" id="docTitle">LGE SAC Commissioning Report</h1>
      <div class="toggle">
        <span class="mode-label" id="modeLabel">User</span>
        <label class="switch">
          <input type="checkbox" id="modeToggle">
          <span class="slider"></span>
        </label>
        <button class="icon-btn edit-only" id="changePasswordBtn" type="button" aria-label="Change Password">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5"
            stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round"
              d="M15.75 5.25a3 3 0 013 3m3 0a6 6 0 01-7.029 5.912c-.563-.097-1.159.026-1.563.43L10.5 17.25H8.25v2.25H6v2.25H2.25v-2.818c0-.597.237-1.17.659-1.591l6.499-6.499c.404-.404.527-1 .43-1.563A6 6 0 1121.75 8.25z" />
          </svg>
        </button>
      </div>
    </div>
  </header>
  <main class="container grid" id="appRoot">

    <!-- Project Information -->
    <section class="card">
      <h2 style="font-size:1rem; margin:0 0 6px 0;">Project information</h2>
      <div class="two-cols">
        <div>
          <label>Project name</label>
          <input id="projectName" type="text" />
        </div>
        <div>
          <label>Opportunity No.</label>
          <input id="opportunityNo" type="text" />
        </div>
      </div>

      <div class="row" style="align-items: flex-end; margin-top: 12px;">
        <div style="flex:1 1 320px;">
          <label>Address</label>
          <input id="addressInput" placeholder="" type="text" />
        </div>
        <div>
          <button class="btn secondary" id="getLocationBtn" type="button">Get location</button>
        </div>
      </div>

      <div class="row" style="margin-top: 12px;">
        <div style="flex:1 1 220px;">
          <label>Product Type</label>
          <select id="globalProductType"></select>
        </div>
      </div>

      <h2 style="font-size:1rem; margin:16px 0 6px 0;">Product list</h2>
      <div style="width:100%;">
        <div>
          <div>
            <table>
              <thead>
                <tr>
                  <th style="width:30%">Product</th>
                  <th>Model name</th>
                  <th style="width:20%">Quantity</th>
                </tr>
              </thead>
              <tbody>
                <tr>
                  <td>ODU</td>
                  <td><input id="oduModel" type="text" style="width:100%; box-sizing:border-box;" /></td>
                  <td><input id="oduQty" type="text" style="width:100%; box-sizing:border-box;" /></td>
                </tr>
                <tr>
                  <td>IDU</td>
                  <td><input id="iduModel" type="text" style="width:100%; box-sizing:border-box;" /></td>
                  <td><input id="iduQty" type="text" style="width:100%; box-sizing:border-box;" /></td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </section>
    <!-- Categories container -->
    <section class="grid" id="categoriesContainer"></section>

    <!-- Add Category Button (Edit Mode Only) -->
    <div class="row edit-only" style="justify-content: center; margin: 10px 0;">
      <button class="btn secondary" id="addCategoryBtn" type="button" style="width: 100%;">Add Category</button>
    </div>

    <!-- Date & signatures -->
    <section class="card">
      <div class="row">
        <div style="flex:1 1 220px;">
          <label>Inspection date</label>
          <input id="inspectionDate" type="date" />
        </div>
      </div>
      <div class="three-cols signature-section" style="margin-top:8px;">
        <div>
          <label>Commissioner Signature</label>
          <canvas class="signature-pad" id="sigCommissioner"></canvas>
          <div class="row interactive-only" style="margin-top:6px;">
            <button class="btn muted" data-clear="sigCommissioner" type="button">Clear</button>
          </div>
        </div>
        <div>
          <label>Installer Signature</label>
          <canvas class="signature-pad" id="sigInstaller"></canvas>
          <div class="row interactive-only" style="margin-top:6px;">
            <button class="btn muted" data-clear="sigInstaller" type="button">Clear</button>
          </div>
        </div>
        <div>
          <label>Customer Signature</label>
          <canvas class="signature-pad" id="sigCustomer"></canvas>
          <div class="row interactive-only" style="margin-top:6px;">
            <button class="btn muted" data-clear="sigCustomer" type="button">Clear</button>
          </div>
        </div>
      </div>
    </section>
    <div class="footer">
      <button class="btn" id="printBtn" type="button">PDF Export</button>
    </div>
  </main>
  <!-- Password Modal -->
  <dialog id="passwordModal">
    <form method="dialog" style="min-width:280px;">
      <h3 style="margin-top:0;">Enter admin password</h3>
      <input id="passwordInput" placeholder="Password" type="password" />
      <div class="row" style="margin-top:10px; justify-content:flex-end;">
        <button class="btn muted" value="cancel">Cancel</button>
        <button class="btn" id="passwordSubmit" type="button" value="ok">Enter</button>
      </div>
    </form>
  </dialog>
  <!-- Change Password Modal -->
  <dialog id="changePasswordModal">
    <form method="dialog" style="min-width:300px;">
      <h3 style="margin-top:0;">Change admin password</h3>
      <input id="newPassword1" placeholder="New password" type="password" />
      <input id="newPassword2" placeholder="Confirm new password" style="margin-top:8px;" type="password" />
      <div class="row" style="margin-top:10px; justify-content:flex-end;">
        <button class="btn muted" value="cancel">Cancel</button>
        <button class="btn" id="changePasswordSubmit" type="button" value="ok">Change</button>
      </div>
    </form>
  </dialog>
  <template id="categoryTemplate">
    <section class="card category">
      <div class="category-header">
        <input class="category-title" type="text" />
        <div class="row edit-only">
          <button class="btn danger" data-action="delete-category" type="button">Delete</button>
        </div>
      </div>
      <div class="checklists"></div>
      <div class="row edit-only" style="margin-top:8px;">
        <button class="btn secondary" data-action="add-checklist" type="button">Add Checklist</button>
      </div>
    </section>
  </template>
  <template id="checklistTemplate">
    <div class="checklist-item">
      <div class="row" style="align-items:flex-start;">
        <div style="flex:1 1 100%;">
          <div class="product-type-inline">
            <label>Product type</label>
            <select class="item-product-type"></select>
          </div>
          <div style="display:flex; align-items:flex-start;">
            <span class="product-type-badge" style="margin-top: 6px;"></span>
            <textarea class="item-text" rows="1"
              style="font-weight:500; flex:1; resize:none; overflow:hidden; min-height:38px; font-family:inherit;"></textarea>
          </div>
        </div>
      </div>
      <div style="margin-top:6px;">
        <label>Issue</label>
        <textarea class="item-issue" placeholder="Describe issue (optional)" rows="1"></textarea>
      </div>
      <div class="row" style="margin-top:6px; align-items: center;">
        <div aria-label="status" class="status" style="margin-right: auto;">
          <label><input class="okBox" type="checkbox" /> <span class="ok">OK</span></label>
          <label><input class="ngBox" type="checkbox" /> <span class="ng">NG</span></label>
        </div>
        <input accept="image/*" capture="environment" class="add-image-input" style="display:none;" type="file" />
        <button class="btn add-image-btn interactive-only" type="button">Add image</button>
        <button class="btn muted ref-btn interactive-only" type="button">Ref.</button>
        <button class="btn secondary edit-only" data-action="move-up" type="button" title="Move Up">↑</button>
        <button class="btn secondary edit-only" data-action="move-down" type="button" title="Move Down">↓</button>
        <button class="btn danger edit-only" data-action="delete-checklist" type="button">Delete</button>
      </div>
      <div class="img-strip item-images"></div>
      <div class="img-strip item-ref-images"></div>
    </div>
  </template>
  <section class="container card edit-only controls" id="editorControls">
    <div class="row" style="align-items:center;">
      <div style="flex:1 1 auto;">
        <label>Report title</label>
        <input id="titleInput" type="text" />
      </div>
    </div>
    <div style="margin-top:8px;">
      <label>Manage Product Types</label>
      <div class="row" id="productTypesEditor"></div>
    </div>
  </section>
  <script>
    // ---- Persistence helpers ----
    const LS_CONFIG_KEY = 'sacConfig.v1';
    const LS_DATA_KEY = 'sacData.v1';
    const LS_PASS_KEY = 'sacPasswordHash.v1';

    function clone(obj) { return JSON.parse(JSON.stringify(obj)); }

    const defaultConfig = {
      title: 'LGE SAC Commissioning Report',
      productTypes: ['Common', 'Multi V', 'AHU', 'Water', 'H/kit', 'ISC'],
      categories: [
        {
          name: 'Installation', items: [
            { productType: 'Common', text: 'Is SVC area secured?' },
            { productType: 'Common', text: 'Is equipment anchored and leveled?' }
          ]
        },
        {
          name: 'Piping', items: [
            { productType: 'Common', text: 'Are refrigerant lines insulated properly?' },
            { productType: 'Common', text: 'Leak test performed and passed?' }
          ]
        },
        {
          name: 'Control', items: [
            { productType: 'Common', text: 'Controller wiring verified?' },
            { productType: 'Common', text: 'BMS integration tested?' }
          ]
        }
      ]
    };

    const defaultData = {
      projectName: '',
      opportunityNo: '',
      address: '',
      globalProductType: 'All',
      productList: { oduModel: '', oduQty: '', iduModel: '', iduQty: '' },
      inspectionDate: '',
      categories: [] // parallel to config categories by index
    };

    // Initialize password with 'admin' (hashed) if none
    async function ensurePassword() {
      const stored = localStorage.getItem(LS_PASS_KEY);
      if (!stored) {
        const hash = await sha256('admin');
        localStorage.setItem(LS_PASS_KEY, hash);
      }
    }

    async function sha256(str) {
      const data = new TextEncoder().encode(str);
      const hashBuffer = await crypto.subtle.digest('SHA-256', data);
      const hashArray = Array.from(new Uint8Array(hashBuffer));
      const hashHex = hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
      return hashHex;
    }

    // ---- State ----
    let CONFIG = null; // structure defining categories/items
    let DATA = null;   // user inputs incl. statuses and images
    let EDIT_MODE = false;

    function loadConfig() {
      const raw = localStorage.getItem(LS_CONFIG_KEY);
      CONFIG = raw ? JSON.parse(raw) : clone(defaultConfig);
    }
    function saveConfig() { localStorage.setItem(LS_CONFIG_KEY, JSON.stringify(CONFIG)); }

    function loadData() {
      const raw = localStorage.getItem(LS_DATA_KEY);
      DATA = raw ? JSON.parse(raw) : clone(defaultData);
      // Ensure categories data matches config length
      if (!Array.isArray(DATA.categories) || DATA.categories.length !== CONFIG.categories.length) {
        DATA.categories = CONFIG.categories.map(cat => ({ items: cat.items.map(_ => ({ status: null, issue: '', images: [], refImages: [] })) }));
      }
    }
    function saveData() { localStorage.setItem(LS_DATA_KEY, JSON.stringify(DATA)); }

    // ---- UI rendering ----
    const docTitleEl = document.getElementById('docTitle');
    const categoriesContainer = document.getElementById('categoriesContainer');
    const projectNameInput = document.getElementById('projectName');
    const opportunityNoInput = document.getElementById('opportunityNo');
    const globalProductTypeSel = document.getElementById('globalProductType');
    const addressInput = document.getElementById('addressInput');
    const oduModel = document.getElementById('oduModel');
    const oduQty = document.getElementById('oduQty');
    const iduModel = document.getElementById('iduModel');
    const iduQty = document.getElementById('iduQty');
    const inspectionDate = document.getElementById('inspectionDate');

    function syncTopSection() {
      docTitleEl.textContent = CONFIG.title;
      // product types
      globalProductTypeSel.innerHTML = '';
      // Add 'All' option first
      const allOpt = document.createElement('option'); allOpt.value = 'All'; allOpt.textContent = 'All'; globalProductTypeSel.appendChild(allOpt);

      CONFIG.productTypes.forEach(pt => {
        if (pt === 'Common') return; // Skip Common in list as it's covered by 'All' or implicit logic
        const opt = document.createElement('option'); opt.value = pt; opt.textContent = pt; globalProductTypeSel.appendChild(opt);
      });
      // If current selection is not in list and not 'All', default to 'All'
      if (DATA.globalProductType !== 'All' && !CONFIG.productTypes.includes(DATA.globalProductType)) DATA.globalProductType = 'All';
      globalProductTypeSel.value = DATA.globalProductType;

      projectNameInput.value = DATA.projectName || '';
      opportunityNoInput.value = DATA.opportunityNo || '';
      addressInput.value = DATA.address || '';
      oduModel.value = DATA.productList.oduModel || '';
      oduQty.value = DATA.productList.oduQty || '';
      iduModel.value = DATA.productList.iduModel || '';
      iduQty.value = DATA.productList.iduQty || '';

      inspectionDate.value = DATA.inspectionDate || formatDate(new Date());
    }

    function renderCategories() {
      categoriesContainer.innerHTML = '';
      CONFIG.categories.forEach((cat, ci) => {
        // Check if category has any visible items
        const visibleItems = cat.items.filter(item =>
          DATA.globalProductType === 'All' ||
          item.productType === 'Common' ||
          item.productType === DATA.globalProductType
        );

        // In User mode, hide category if no visible items
        if (!EDIT_MODE && visibleItems.length === 0) return;

        const catTpl = document.getElementById('categoryTemplate');
        const catEl = catTpl.content.cloneNode(true);
        const sec = catEl.querySelector('section.category');
        sec.dataset.idx = ci;
        const titleInput = sec.querySelector('.category-title');
        titleInput.value = cat.name;

        // Auto-expand/resize not strictly needed for single line input but good to have binding
        titleInput.addEventListener('input', () => {
          cat.name = titleInput.value;
          saveConfig();
        });
        const checklistsContainer = catEl.querySelector('.checklists');

        cat.items.forEach((item, ii) => {
          // Filter by global product type: 
          // If global is 'All', show ALL. Otherwise show matching type OR item is 'Common'.
          const show = DATA.globalProductType === 'All' || item.productType === 'Common' || item.productType === DATA.globalProductType;
          if (!show) return;
          const itemTpl = document.getElementById('checklistTemplate');
          const itemEl = itemTpl.content.cloneNode(true);
          const root = itemEl.querySelector('.checklist-item');
          root.dataset.idx = ii;

          const ptSel = itemEl.querySelector('.item-product-type');
          const textInput = itemEl.querySelector('.item-text');
          const okBox = itemEl.querySelector('.okBox');
          const ngBox = itemEl.querySelector('.ngBox');
          const issueArea = itemEl.querySelector('.item-issue');
          const addImgBtn = itemEl.querySelector('.add-image-btn');
          const addImgInput = itemEl.querySelector('.add-image-input');
          const refBtn = itemEl.querySelector('.ref-btn');
          const imagesStrip = itemEl.querySelector('.item-images');
          const refImagesStrip = itemEl.querySelector('.item-ref-images');

          // populate product types
          CONFIG.productTypes.forEach(pt => {
            const opt = document.createElement('option'); opt.value = pt; opt.textContent = pt; ptSel.appendChild(opt);
          });
          ptSel.value = item.productType;
          itemEl.querySelector('.product-type-badge').textContent = item.productType;
          textInput.value = item.text;

          // data binding
          const datum = (DATA.categories[ci] && DATA.categories[ci].items[ii]) ? DATA.categories[ci].items[ii] : { status: null, issue: '', images: [], refImages: [] };
          okBox.checked = datum.status === 'OK';
          ngBox.checked = datum.status === 'NG';
          issueArea.value = datum.issue || '';

          okBox.addEventListener('change', () => { if (okBox.checked) { ngBox.checked = false; datum.status = 'OK'; } else { datum.status = null; } saveData(); });
          ngBox.addEventListener('change', () => { if (ngBox.checked) { okBox.checked = false; datum.status = 'NG'; } else { datum.status = null; } saveData(); });

          // Auto-expand textarea for Issue
          function autoResizeIssue() {
            issueArea.style.height = 'auto';
            issueArea.style.height = issueArea.scrollHeight + 'px';
          }
          issueArea.addEventListener('input', () => {
            datum.issue = issueArea.value;
            autoResizeIssue();
            saveData();
          });
          // Init height
          if (datum.issue) setTimeout(autoResizeIssue, 0);

          // Auto-expand textarea for Item Text
          function autoResizeText() {
            textInput.style.height = 'auto';
            textInput.style.height = (textInput.scrollHeight + 2) + 'px'; // Add buffer
          }
          textInput.addEventListener('input', () => {
            item.text = textInput.value;
            autoResizeText();
            saveConfig();
          });
          // Init height
          setTimeout(autoResizeText, 0);

          // Add to global resize list
          if (!window.resizeListeners) window.resizeListeners = [];
          window.resizeListeners.push(autoResizeText);


          addImgBtn.addEventListener('click', () => addImgInput.click());
          addImgInput.addEventListener('change', async (e) => {
            const file = e.target.files[0]; if (!file) return;
            const dataUrl = await resizeImageFile(file, 1600, 1600, 0.8);
            datum.images.push(dataUrl);
            saveData();
            renderImages(imagesStrip, datum.images);
          });

          refBtn.addEventListener('click', async () => {
            if (EDIT_MODE) {
              // Upload refs in edit mode
              const input = document.createElement('input'); input.type = 'file'; input.accept = 'image/*'; input.multiple = true;
              input.onchange = async (e) => {
                const files = Array.from(e.target.files || []);
                for (const f of files) {
                  const url = await resizeImageFile(f, 2000, 2000, 0.9); // higher res for refs
                  datum.refImages.push(url);
                }
                saveData();
                renderImages(refImagesStrip, datum.refImages);
              };
              input.click();
            } else {
              // View refs in user mode: open a simple gallery dialog
              const dlg = document.createElement('dialog');
              dlg.style.maxWidth = '90vw'; dlg.style.padding = '0';
              const wrap = document.createElement('div'); wrap.style.padding = '12px'; wrap.style.background = 'white';
              const h = document.createElement('h3'); h.textContent = 'Reference images'; h.style.margin = '0 0 8px 0'; wrap.appendChild(h);
              const strip = document.createElement('div'); strip.style.display = 'flex'; strip.style.flexWrap = 'wrap'; strip.style.gap = '8px';
              datum.refImages.forEach(url => { const img = document.createElement('img'); img.src = url; img.style.maxWidth = '42vw'; img.style.maxHeight = '60vh'; img.style.border = '1px solid #e2e8f0'; img.style.borderRadius = '8px'; strip.appendChild(img); });
              if (datum.refImages.length === 0) { const p = document.createElement('p'); p.textContent = 'No reference images.'; strip.appendChild(p); }
              wrap.appendChild(strip);
              const row = document.createElement('div'); row.style.display = 'flex'; row.style.justifyContent = 'flex-end'; row.style.gap = '8px'; row.style.marginTop = '8px';
              const closeBtn = document.createElement('button'); closeBtn.textContent = 'Close'; closeBtn.className = 'btn muted'; closeBtn.addEventListener('click', () => dlg.close()); row.appendChild(closeBtn);
              wrap.appendChild(row);
              dlg.appendChild(wrap);
              document.body.appendChild(dlg);
              dlg.addEventListener('close', () => dlg.remove());
              dlg.showModal();
            }
          });

          renderImages(imagesStrip, datum.images);
          renderImages(refImagesStrip, datum.refImages);

          // Edit bindings
          ptSel.addEventListener('change', () => { item.productType = ptSel.value; saveConfig(); rerender(); });
          // textInput listener is already added above with autoResizeText

          // delete checklist in edit mode
          const delBtn = itemEl.querySelector('[data-action="delete-checklist"]');
          delBtn.addEventListener('click', () => {
            if (!EDIT_MODE) return; cat.items.splice(ii, 1); saveConfig(); // also remove data
            DATA.categories[ci].items.splice(ii, 1); saveData(); rerender();
          });

          // Reorder buttons
          const upBtn = itemEl.querySelector('[data-action="move-up"]');
          const downBtn = itemEl.querySelector('[data-action="move-down"]');

          upBtn.addEventListener('click', () => {
            if (!EDIT_MODE || ii === 0) return;
            // Swap in CONFIG
            [cat.items[ii - 1], cat.items[ii]] = [cat.items[ii], cat.items[ii - 1]];
            saveConfig();
            // Swap in DATA
            [DATA.categories[ci].items[ii - 1], DATA.categories[ci].items[ii]] = [DATA.categories[ci].items[ii], DATA.categories[ci].items[ii - 1]];
            saveData();
            rerender();
          });

          downBtn.addEventListener('click', () => {
            if (!EDIT_MODE || ii === cat.items.length - 1) return;
            // Swap in CONFIG
            [cat.items[ii], cat.items[ii + 1]] = [cat.items[ii + 1], cat.items[ii]];
            saveConfig();
            // Swap in DATA
            [DATA.categories[ci].items[ii], DATA.categories[ci].items[ii + 1]] = [DATA.categories[ci].items[ii + 1], DATA.categories[ci].items[ii]];
            saveData();
            rerender();
          });

          checklistsContainer.appendChild(itemEl);
        });

        // Add checklist button
        const addBtn = catEl.querySelector('[data-action="add-checklist"]');
        addBtn.addEventListener('click', () => {
          if (!EDIT_MODE) return; cat.items.push({ productType: CONFIG.productTypes[0] || 'Common', text: 'New checklist' }); saveConfig(); // add data row
          DATA.categories[ci].items.push({ status: null, issue: '', images: [], refImages: [] }); saveData(); rerender();
        });

        // Delete category
        const delCatBtn = catEl.querySelector('[data-action="delete-category"]');
        delCatBtn.addEventListener('click', () => { if (!EDIT_MODE) return; CONFIG.categories.splice(ci, 1); saveConfig(); DATA.categories.splice(ci, 1); saveData(); rerender(); });

        categoriesContainer.appendChild(catEl);
      });
    }

    function renderImages(strip, arr) {

      strip.innerHTML = '';
      arr.forEach((url, idx) => {
        const img = document.createElement('img'); img.src = url; img.className = 'img-thumb'; img.alt = 'image';
        strip.appendChild(img);
      });
    }

    function rerender() {
      syncTopSection();
      renderCategories();
      applyModeClasses();
    }

    // ---- Event wiring ----
    const modeToggle = document.getElementById('modeToggle');
    const modeLabel = document.getElementById('modeLabel');

    modeToggle.addEventListener('change', () => {
      if (modeToggle.checked) {
        // User wants to enter Edit Mode
        passwordModal.showModal();
      } else {
        // User wants to leave Edit Mode
        setEditMode(false);
      }
    });

    const passwordModal = document.getElementById('passwordModal');
    const changePasswordModal = document.getElementById('changePasswordModal');

    // Password modal cancel -> revert toggle
    passwordModal.addEventListener('close', () => {
      if (passwordModal.returnValue !== 'ok') {
        modeToggle.checked = false; // Revert
      }
    });

    document.getElementById('passwordSubmit').addEventListener('click', async () => {
      const pwd = document.getElementById('passwordInput').value || '';
      const inputHash = await sha256(pwd);
      const stored = localStorage.getItem(LS_PASS_KEY);
      if (inputHash === stored) {
        passwordModal.returnValue = 'ok';
        passwordModal.close();
        setEditMode(true);
        document.getElementById('passwordInput').value = '';
      } else {
        alert('Incorrect password.');
        // Do not close, let user try again or cancel
      }
    });

    document.getElementById('changePasswordBtn').addEventListener('click', () => {
      if (!EDIT_MODE) return; changePasswordModal.showModal();
    });

    document.getElementById('changePasswordSubmit').addEventListener('click', async () => {
      const p1 = document.getElementById('newPassword1').value || '';
      const p2 = document.getElementById('newPassword2').value || '';
      if (p1.length < 4) { alert('Use at least 4 characters.'); return; }
      if (p1 !== p2) { alert('Passwords do not match.'); return; }
      const hash = await sha256(p1);
      localStorage.setItem(LS_PASS_KEY, hash);
      alert('Password updated.');
      changePasswordModal.close();
      document.getElementById('newPassword1').value = '';
      document.getElementById('newPassword2').value = '';
    });

    function setEditMode(flag) {
      EDIT_MODE = !!flag;
      modeToggle.checked = EDIT_MODE;
      modeLabel.textContent = EDIT_MODE ? 'Edit' : 'User';
      rerender(); // Rerender to show/hide empty categories
    }
    function applyModeClasses() {
      document.querySelectorAll('.edit-only').forEach(el => { el.style.display = EDIT_MODE ? '' : 'none'; });
      document.querySelectorAll('.interactive-only').forEach(el => { el.style.display = EDIT_MODE ? '' : ''; });

      // Show/hide per-item product type editor in edit mode
      document.querySelectorAll('.product-type-inline').forEach(el => {
        el.style.display = EDIT_MODE ? '' : 'none';
      });

      // Toggle readOnly for checklist item text
      document.querySelectorAll('.item-text').forEach(el => {
        el.readOnly = !EDIT_MODE;
      });

      // Toggle readOnly for category titles
      document.querySelectorAll('.category-title').forEach(el => {
        el.readOnly = !EDIT_MODE;
      });

      // Toggle user-mode class on body for specific styles
      if (EDIT_MODE) document.body.classList.remove('user-mode');
      else document.body.classList.add('user-mode');
    }

    // Title editor
    const titleInput = document.getElementById('titleInput');
    titleInput.addEventListener('input', () => { CONFIG.title = titleInput.value; saveConfig(); docTitleEl.textContent = CONFIG.title; });

    // Product type editor
    const productTypesEditor = document.getElementById('productTypesEditor');
    function renderProductTypesEditor() {
      productTypesEditor.innerHTML = '';
      CONFIG.productTypes.forEach((pt, idx) => {
        const wrap = document.createElement('div'); wrap.className = 'row'; wrap.style.alignItems = 'center';
        wrap.style.gap = '6px';
        const input = document.createElement('input'); input.type = 'text'; input.value = pt; input.style.flex = '1 1 160px';

        if (pt === 'Common') {
          input.disabled = true;
          input.title = "Cannot modify Common type";
          wrap.appendChild(input);
          // No delete button for Common
        } else {
          input.addEventListener('input', () => { CONFIG.productTypes[idx] = input.value; saveConfig(); rerender(); });
          const del = document.createElement('button'); del.className = 'btn danger'; del.type = 'button'; del.textContent = 'Delete';
          del.addEventListener('click', () => { CONFIG.productTypes.splice(idx, 1); saveConfig(); rerender(); renderProductTypesEditor(); });
          wrap.appendChild(input); wrap.appendChild(del);
        }
        productTypesEditor.appendChild(wrap);
      });
      const add = document.createElement('button'); add.className = 'btn secondary'; add.type = 'button'; add.textContent = 'Add Product Type';
      add.addEventListener('click', () => { CONFIG.productTypes.push('NewType'); saveConfig(); rerender(); renderProductTypesEditor(); });
      productTypesEditor.appendChild(add);
    }

    // Global bindings
    projectNameInput.addEventListener('input', () => { DATA.projectName = projectNameInput.value; saveData(); });
    opportunityNoInput.addEventListener('input', () => { DATA.opportunityNo = opportunityNoInput.value; saveData(); });
    globalProductTypeSel.addEventListener('change', () => { DATA.globalProductType = globalProductTypeSel.value; saveData(); rerender(); });
    addressInput.addEventListener('input', () => { DATA.address = addressInput.value; saveData(); });
    oduModel.addEventListener('input', () => { DATA.productList.oduModel = oduModel.value; saveData(); });
    oduQty.addEventListener('input', () => { DATA.productList.oduQty = oduQty.value; saveData(); });
    iduModel.addEventListener('input', () => { DATA.productList.iduModel = iduModel.value; saveData(); });
    iduQty.addEventListener('input', () => { DATA.productList.iduQty = iduQty.value; saveData(); });
    inspectionDate.addEventListener('input', () => { DATA.inspectionDate = inspectionDate.value; saveData(); });

    // Geolocation + reverse geocode via Nominatim (with fallback to lat/lon)
    document.getElementById('getLocationBtn').addEventListener('click', () => {
      if (!navigator.geolocation) { alert('Geolocation not supported.'); return; }
      navigator.geolocation.getCurrentPosition(async (pos) => {
        const { latitude, longitude } = pos.coords;
        try {
          const url = `https://nominatim.openstreetmap.org/reverse?format=jsonv2&lat=${latitude}&lon=${longitude}`;
          const res = await fetch(url, { headers: { 'Accept': 'application/json' } });
          const json = await res.json();
          const addr = json.display_name || `${latitude.toFixed(5)}, ${longitude.toFixed(5)}`;
          addressInput.value = addr; DATA.address = addr; saveData();
        } catch (e) {
          const coords = `${latitude.toFixed(5)}, ${longitude.toFixed(5)}`;
          addressInput.value = coords; DATA.address = coords; saveData();
        }
      }, (err) => { alert('Failed to get location: ' + err.message); });
    });

    // Signature pads
    const sigPads = ['sigCommissioner', 'sigInstaller', 'sigCustomer'].map(id => document.getElementById(id));
    const sigCtxs = sigPads.map(c => c.getContext('2d'));
    sigCtxs.forEach((ctx, i) => { ctx.lineWidth = 2; ctx.strokeStyle = '#111'; });

    function resizeCanvasToDisplaySize(canvas) {
      const { width, height } = canvas.getBoundingClientRect();
      if (canvas.width !== Math.round(width) || canvas.height !== Math.round(height)) {
        const imgData = canvas.toDataURL('image/png');
        canvas.width = Math.round(width); canvas.height = Math.round(height);
        // restore previous drawing
        const img = new Image(); img.onload = () => canvas.getContext('2d').drawImage(img, 0, 0, canvas.width, canvas.height); img.src = imgData;
      }
    }

    function initSignaturePad(canvas) {
      resizeCanvasToDisplaySize(canvas);
      let drawing = false, lastX = 0, lastY = 0;
      function pos(e) {
        const rect = canvas.getBoundingClientRect();
        const x = (e.touches ? e.touches[0].clientX : e.clientX) - rect.left;
        const y = (e.touches ? e.touches[0].clientY : e.clientY) - rect.top;
        return { x, y };
      }
      const ctx = canvas.getContext('2d');
      function start(e) { drawing = true; const p = pos(e); lastX = p.x; lastY = p.y; e.preventDefault(); }
      function move(e) { if (!drawing) return; const p = pos(e); ctx.beginPath(); ctx.moveTo(lastX, lastY); ctx.lineTo(p.x, p.y); ctx.stroke(); lastX = p.x; lastY = p.y; e.preventDefault(); }
      function end() { drawing = false; saveSignatures(); }
      canvas.addEventListener('mousedown', start); canvas.addEventListener('mousemove', move); canvas.addEventListener('mouseup', end); canvas.addEventListener('mouseleave', end);
      canvas.addEventListener('touchstart', start, { passive: false }); canvas.addEventListener('touchmove', move, { passive: false }); canvas.addEventListener('touchend', end);
    }

    function saveSignatures() {
      const urls = sigPads.map(c => c.toDataURL('image/png'));
      DATA.signatures = urls; saveData();
    }

    function restoreSignatures() {
      if (!DATA.signatures) return;
      DATA.signatures.forEach((url, i) => {
        const img = new Image();
        img.onload = () => { const ctx = sigPads[i].getContext('2d'); ctx.clearRect(0, 0, sigPads[i].width, sigPads[i].height); ctx.drawImage(img, 0, 0, sigPads[i].width, sigPads[i].height); };
        img.src = url;
      });
    }

    document.querySelectorAll('[data-clear]').forEach(btn => {
      btn.addEventListener('click', () => {
        const id = btn.getAttribute('data-clear');
        const canvas = document.getElementById(id); const ctx = canvas.getContext('2d');
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        saveSignatures();
      });
    });

    // Print
    document.getElementById('printBtn').addEventListener('click', () => {
      window.print();
    });

    // Date formatting with ordinal
    function formatDate(d) {
      // Return YYYY-MM-DD for date input
      const year = d.getFullYear();
      const month = String(d.getMonth() + 1).padStart(2, '0');
      const day = String(d.getDate()).padStart(2, '0');
      return `${year}-${month}-${day}`;
    }

    // Image resize to dataURL
    function resizeImageFile(file, maxW, maxH, quality = 0.85) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = () => {
          const img = new Image();
          img.onload = () => {
            let { width: w, height: h } = img;
            const ratio = Math.min(maxW / w, maxH / h, 1);
            const canvas = document.createElement('canvas');
            canvas.width = Math.round(w * ratio);
            canvas.height = Math.round(h * ratio);
            const ctx = canvas.getContext('2d');
            ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
            resolve(canvas.toDataURL('image/jpeg', quality));
          };
          img.src = reader.result;
        };
        reader.onerror = reject;
        reader.readAsDataURL(file);
      });
    }

    // Add Category (edit)
    document.getElementById('addCategoryBtn').addEventListener('click', () => {
      if (!EDIT_MODE) return;
      CONFIG.categories.push({ name: 'New Category', items: [] });
      saveConfig();
      DATA.categories.push({ items: [] });
      saveData();
      rerender();
    });

    // Init
    (async function init() {
      await ensurePassword();
      loadConfig(); loadData();
      titleInput.value = CONFIG.title;
      rerender();
      renderProductTypesEditor();
      sigPads.forEach(initSignaturePad);
      restoreSignatures();
      window.addEventListener('resize', () => {
        sigPads.forEach(resizeCanvasToDisplaySize);
        if (window.resizeListeners) window.resizeListeners.forEach(fn => fn());
      });
      // Ensure canvas sizes initially
      setTimeout(() => {
        sigPads.forEach(resizeCanvasToDisplaySize);
        if (window.resizeListeners) window.resizeListeners.forEach(fn => fn());
      }, 100);
    })();
  </script>
</body>

</html>
