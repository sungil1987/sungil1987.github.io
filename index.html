
#Requires -Version 5.1
[CmdletBinding()]
param(
  [string]$OutDir = 'D:\000. 현장\0000. 진단 보고서\2026\모바일 코딩',
  [string]$FileName = 'index.html',
  [switch]$Open,
  [switch]$Hash
)

$ErrorActionPreference = 'Stop'

try {
  if (-not (Test-Path -LiteralPath $OutDir)) {
    New-Item -ItemType Directory -Path $OutDir -Force | Out-Null
  }
} catch {
  Write-Error "출력 폴더 생성/확인 중 오류: $($_.Exception.Message)"
  throw
}

$indexPath = Join-Path $OutDir $FileName

# ---------- HTML (기존 완전판 + 안드로이드 버튼/JS 추가) ----------
$html = @'
<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="color-scheme" content="light" />
  <title>LG전자 ES에너지컨설팅팀 위험성 평가표 (모바일 표 Ver.)</title>

  <style>
    @font-face {
      font-family: "LG스마트체";
      src: url("LGSmartRegular.woff2") format("woff2"),
           url("LGSmartRegular.woff") format("woff");
      font-weight: 400; font-style: normal; font-display: swap;
    }
    :root{
      --bg:#f6f7fb; --card:#fff; --text:#111827; --border:#e5e7eb; --primary:#111827;
      --fs-body: clamp(15.6px, 2.04vw, 18px);
      --fs-label: clamp(14.4px, 1.92vw, 16.8px);
      --fs-title: clamp(21.6px, 4.32vw, 26.4px);
      --fs-h2: clamp(16.8px, 3.12vw, 19.2px);
      --fs-btn: clamp(15.6px, 2.88vw, 18px);
      --line:1.45; --radius:12px; --table-pad:6px;
      --radius-input:10px; --focus:#3b82f6; --shadow:0 2px 6px rgba(0,0,0,.06); --title-accent:#8B1B3D;
    }
    *{ box-sizing:border-box }
    html,body{
      margin:0; padding:0; width:100%; min-height:100vh; overflow-x:hidden;
      -webkit-text-size-adjust:100%; -webkit-tap-highlight-color:transparent;
      background:var(--bg); color:var(--text);
      font-family:"LG스마트체","Malgun Gothic","Apple SD Gothic Neo","Noto Sans KR",system-ui,-apple-system,"Segoe UI",Roboto,sans-serif;
      font-size:var(--fs-body); line-height:var(--line);
    }
    header{
      background:var(--card);
      border-bottom:1px solid var(--border);
      position:sticky; top:0; z-index:10;
      backdrop-filter:saturate(120%) blur(6px);
    }
    .wrap{max-width:1000px; margin:0 auto; padding:12px}
    .brand{display:flex; align-items:center; justify-content:space-between; gap:8px}
    .title{font-weight:800;}
    .main-title{
      color:var(--title-accent);
      font-size:calc(var(--fs-title) + 8px);
      text-shadow:0 1px 0 rgba(0,0,0,.05);
      letter-spacing:2px;
      transform:translateY(-4px);
      text-align:center;
      line-height:1.25;
      margin:6px 0 10px 0;
    }
    .toolbar{display:flex; gap:8px; margin-top:8px}
    .toolbar-left{display:flex; gap:8px; margin-right:auto}
    button{
      border:1px solid var(--border); background:var(--primary); color:#fff;
      border-radius:var(--radius); padding:9px 12px; font-size:var(--fs-btn);
      min-height:40px; cursor:pointer; font-family:inherit;
    }
    button.secondary{background:#374151}
    button.warn{background:#b91c1c}
    button.mini{ padding:6px 8px; min-height:32px; font-size:calc(var(--fs-btn) - 2px); border-radius:10px }
    @media (pointer:coarse){
      button{min-height:44px}
      input,select,textarea{min-height:48px; font-family:inherit}
      .table-wrap{overflow-x:auto; -webkit-overflow-scrolling:touch}
      button.mini{ min-height:36px }
    }
    main{padding:12px 0}
    .card{
      background:var(--card); border:1px solid var(--border); border-radius:var(--radius);
      padding:18px; margin:12px auto; box-shadow:var(--shadow)
    }
    .field{
      width:100%; padding:10px 12px;
      border:1px solid var(--border); border-radius:var(--radius-input);
      outline:none; font-family:inherit; font-size:inherit; background:#fff;
      transition:border-color .15s ease, box-shadow .15s ease;
      min-height:48px;
    }
    .field:focus{ border-color:var(--focus); box-shadow:0 0 0 3px rgba(59,130,246,.15) }
    .field.textarea{ min-height:72px; resize:vertical }
    .table-wrap{
      width:100%; overflow-x:auto; -webkit-overflow-scrolling:touch;
      border:1px solid var(--border); border-radius:var(--radius); background:#fff;
    }
    table{
      width:100%; border-collapse:collapse; min-width:920px; table-layout:fixed;
      word-break:keep-all; font-family:inherit;
    }
    /* 화면용 열 폭 */
    col.c-task { width:72px }
    col.c-hazard{ width:364px }
    col.c-ok { width:72px }
    col.c-fix { width:72px }
    col.c-na { width:88px }
    col.c-miti { width:220px }
    col.c-done { width:56px }
    th,td{ border:1px solid var(--border); padding:var(--table-pad); font-size:var(--fs-body); vertical-align:top }
    thead th{ background:#f3f4f6; text-align:center; white-space:nowrap }
    td{ text-align:left }
    td.section{
      text-align:center !important; vertical-align:middle !important; font-weight:600; background:#f8fafc;
    }
    .section-cell{ display:flex; flex-direction:column; align-items:center; justify-content:space-between; min-height:100%; gap:8px }
    .section-title{ font-weight:700 }
    .section-actions{ display:flex; gap:6px; justify-content:center; flex-wrap:wrap }
    .chk-wrap{ display:flex; align-items:center; justify-content:center; min-height:32px; }
    .riskchk{ width:18px; height:18px; accent-color:#111827; cursor:pointer; }
    @media(pointer:coarse){ .riskchk{ width:21px; height:21px } }
    .cell-input{
      width:100%; min-height:40px; border:1px solid var(--border); border-radius:8px; background:#fff;
      font-family:inherit; font-size:inherit; padding:6px 8px; outline:none;
      white-space:pre-wrap; word-break:break-word; overflow-wrap:break-word; resize:vertical;
    }

    /* 보완대책 드롭셀/사용자입력 UI */
    .miti-cell{ padding:6px !important; }
    .miti-ui{ display:flex; flex-direction:column; gap:6px; }
    .miti-select, .miti-user{
      box-sizing:border-box; width:100%;
      min-height:48px; padding:6px 8px;
      border:1px solid var(--border); border-radius:8px; background:#fff;
      font-family:inherit; font-size:inherit; line-height:normal; outline:none;
      -webkit-appearance:none; appearance:none;
    }
    .miti-user{ display:none; }
    .miti-print{ display:none; min-height:48px; white-space:pre-wrap; word-break:break-word; }

    .signature{ width:100%; height:130px }
    .sig-box{ position:relative }
    #printPDF{ position:absolute; top:-50px; right:14px; transform:none; z-index:2 }
    /* ✅ (추가) Android 공유 버튼: 기존 PDF 버튼 옆 */
    #btnPdfShareAndroid{ position:absolute; top:-50px; right:92px; transform:none; z-index:2 }

    .signature canvas{
      width:100%; height:100%; display:block; border:1px dashed var(--border);
      border-radius:8px; background:#fff; touch-action:none
    }

    /* ───── 인쇄 최적화 (요청 유지) ───── */
    @page{ margin:12mm }
    @media print{
      html, body{ background:#fff !important; color:#000 !important; -webkit-print-color-adjust:exact; print-color-adjust:exact; }
      .wrap{ transform:none !important; width:auto !important }
      header,.toolbar{ display:none !important }
      .card{ box-shadow:none !important; background:#fff !important; border-color:#ddd !important; transform-origin:top left; }
      .table-wrap, table, thead, tbody, tfoot, tr, th, td, input.field, textarea.field, .signature canvas{ background:#fff !important; }
      thead th{ background:#fff !important } td.section{ background:#fff !important }
      #printPDF, #clearAll, #clearSigSafety, #clearSigW1, #clearSigW2, #clearSigW3{ display:none !important; }
      .section-actions{ display:none !important; }
      thead{ display:table-header-group !important } tfoot{ display:table-footer-group !important }
      table{ min-width:auto; width:100%; table-layout:auto; border-collapse:collapse }
      .table-wrap{ overflow:visible !important }
      tr, th, td, .sig-box, .signature, .section-cell, .miti-print, .cell-input, .miti-select, .miti-user{ page-break-inside:avoid !important; break-inside:avoid !important; }
      tbody{ page-break-inside:auto; break-inside:auto }
      p, .cell-input, .miti-print{ orphans:3; widows:3 }
      h1,h2,h3, .main-title, .section-title{ page-break-after:avoid; break-after:avoid }
      .page-block{ page-break-inside:avoid !important; break-inside:avoid !important; }
      .page-start{ page-break-before:always !important; break-before:page !important; }
      html.print-portrait col.c-task{width:8%!important} html.print-portrait col.c-hazard{width:36%!important}
      html.print-portrait col.c-ok{width:6%!important} html.print-portrait col.c-fix{width:6%!important}
      html.print-portrait col.c-na{width:6%!important} html.print-portrait col.c-miti{width:36%!important}
      html.print-portrait col.c-done{width:2%!important}
      html.print-landscape col.c-task{width:8%!important} html.print-landscape col.c-hazard{width:36%!important}
      html.print-landscape col.c-ok{width:5%!important} html.print-landscape col.c-fix{width:5%!important}
      html.print-landscape col.c-na{width:5%!important} html.print-landscape col.c-miti{width:36%!important}
      html.print-landscape col.c-done{width:5%!important}
      .miti-ui{ display:none !important; }
      .miti-print{ display:block !important; }
    }

    @media (max-width:800px), (pointer:coarse){
      col.c-hazard, col.c-miti { width:182px !important }
      tbody td:nth-child(2){ word-break:break-word; overflow-wrap:break-word; white-space:normal }
      main .card:first-of-type input[type="date"].field{ width:100%; min-width:0; -webkit-appearance:none; appearance:none; height:48px; line-height:48px; color:var(--text); caret-color:var(--text); }
      main .card:first-of-type input[type="date"].field::-webkit-datetime-edit,
      main .card:first-of-type input[type="date"].field::-webkit-datetime-edit-year-field,
      main .card:first-of-type input[type="date"].field::-webkit-datetime-edit-month-field,
      main .card:first-of-type input[type="date"].field::-webkit-datetime-edit-day-field,
      main .card:first-of-type input[type="date"].field::-webkit-datetime-edit-text{ color:var(--text) }
      main .card:first-of-type input[type="date"].field::-webkit-calendar-picker-indicator{ margin:0 6px 0 0; padding:0; width:18px; height:18px; }
      .wrap{ transform:scale(.8); transform-origin:top left; width:calc(100%/.8) }
    }
    #approvalSection > h2{ font-size:calc(var(--fs-h2) - 4px + 3px) }
  </style>

  <!-- ✅ (추가) jsPDF(UMD) & AutoTable: CDN -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
</head>
<body>
<header>
  <div class="wrap">
    <div class="brand">
      <div class="title">LG전자 ES에너지컨설팅팀 위험성 평가표 (모바일 표 Ver.)</div>
    </div>
    <div class="toolbar">
      <div class="toolbar-left">
        <button id="clearAll" class="warn" type="button">초기화</button>
      </div>
    </div>
  </div>
</header>

<main class="wrap">
  <!-- 1) 현장 정보란 (라벨: 작업관리자/작업자1~3 유지) -->
  <section class="card page-block" id="metaCard">
    <div class="title main-title">수시 위험성 평가표</div>
    <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px">
      <div><label class="hint">업체명</label><input id="fCompany" type="text" value="LG전자 ES에너지컨설팅팀" class="field"></div>
      <div><label class="hint">현장명</label><input id="fSiteName" type="text" placeholder="예: ○○공장 ○○라인" class="field"></div>
      <div><label class="hint">진단 시작</label><input id="fDiagStart" type="date" class="field"></div>
      <div><label class="hint">진단 종료</label><input id="fDiagEnd" type="date" class="field"></div>
      <div><label class="hint">작성 일자</label><input id="fWrittenDate" type="date" class="field"></div>
      <div><label class="hint">작업관리자</label><input id="fSafety" type="text" placeholder="성명" class="field"></div>
      <div><label class="hint">작업자1</label><input id="fWorker1" type="text" placeholder="성명" class="field"></div>
      <div><label class="hint">작업자2</label><input id="fWorker2" type="text" placeholder="성명" class="field"></div>
      <div><label class="hint">작업자3</label><input id="fWorker3" type="text" placeholder="성명" class="field"></div>
      <div style="grid-column:1/-1"><label class="hint">비고</label>
        <textarea id="fRemark" class="field textarea" placeholder="특이사항/참고사항"></textarea>
      </div>
    </div>
  </section>

  <!-- 2) 체크리스트 -->
  <section class="card page-block page-start" id="checklistCard">
    <h2 style="display:none">작업별 유해위험요인 평가</h2>
    <div class="table-wrap">
      <table id="riskTable">
        <colgroup>
          <col class="c-task"/><col class="c-hazard"/><col class="c-ok"/><col class="c-fix"/><col class="c-na"/><col class="c-miti"/><col class="c-done"/>
        </colgroup>
        <thead>
          <tr>
            <th rowspan="2" class="th-center">작업</th>
            <th rowspan="2" class="th-center">유해·위험요인 파악</th>
            <th colspan="3" class="th-center">위험성 확인결과</th>
            <th rowspan="2" class="th-center">보완 대책</th>
            <!-- ✅ 확인 헤더 내 마스터 체크박스 (유지) -->
            <th rowspan="2" class="th-center">
              확인
              <div class="chk-wrap" style="margin-top:4px">
                <input id="doneMasterChk" type="checkbox" class="riskchk" title="전체 확인 체크/해제">
              </div>
            </th>
          </tr>
          <tr>
            <th>적정</th><th>보완</th><th>해당없음</th>
          </tr>
        </thead>
        <tbody>
          <!-- 기존 본문 행(사전준비/작업시/기타 등) 그대로 유지 -->
          <tr id="prep-master-row">
            <td id="prep-section-cell" class="section" rowspan="8">
              <div class="section-cell">
                <div class="section-title">사전준비 작업</div>
                <div class="section-actions">
                  <button type="button" class="secondary mini" id="btnPrepAdd">+</button>
                  <button type="button" class="warn mini" id="btnPrepRemove">-</button>
                </div>
              </div>
            </td>
            <td>작업 장소 (기계실, 전기실, 옥상 등)까지 또는 장소 내 이동 및 작업에 있어 유해, 위험 요인이 있는가? 있다면 아래 점검.</td>
            <td class="no-ok"></td>
            <td class="no-fix"></td>
            <td></td>
            <td class="miti-cell"></td>
            <td></td>
          </tr>
          <tr class="prep-sub-row"><td>- 작업장 또는 통로에 배관 등 머리 부딪힘 가능</td><td></td><td></td><td></td><td class="miti-cell"></td><td></td></tr>
          <tr class="prep-sub-row"><td>- 작업장 또는 통로에 추락 가능 장소 있음</td><td></td><td></td><td></td><td class="miti-cell"></td><td></td></tr>
          <tr class="prep-sub-row"><td>- 작업장 또는 통로에 떨어짐 가능 장소 있음</td><td></td><td></td><td></td><td class="miti-cell"></td><td></td></tr>
          <tr class="prep-sub-row"><td>- 작업장 또는 통로에 고전압 주의 장소 있음</td><td></td><td></td><td></td><td class="miti-cell"></td><td></td></tr>
          <tr class="prep-sub-row"><td>- 작업장 또는 통로에 회전장비가 있음</td><td></td><td></td><td></td><td class="miti-cell"></td><td></td></tr>
          <tr><td>측정장비의 현장 운반까지 유해, 위험 요인이 있는가?</td><td></td><td></td><td></td><td class="miti-cell"></td><td></td></tr>
          <tr id="prep-last-fixed"><td>작업 공간이 밀폐되거나, 소통이 어려운 환경인가? Ex. 긴급, 응급상황 대처</td><td></td><td></td><td></td><td class="miti-cell"></td><td></td></tr>

          <!-- 작업시 -->
          <tr>
            <td id="task-works-label" class="section" rowspan="5">
              <div class="section-cell">
                <div class="section-title">작업시</div>
                <div class="section-actions">
                  <button type="button" class="secondary mini" id="btnWorksAdd">+</button>
                  <button type="button" class="warn mini" id="btnWorksRemove">-</button>
                </div>
              </div>
            </td>
            <td>바닥에서 수행 가능 여부(사다리 필요여부)</td>
            <td></td><td></td><td></td><td class="miti-cell"></td><td></td>
          </tr>
          <tr><td>보온재 탈거 및 제거를 고객측 또는 전문점측 인원이 수행하는가?</td><td></td><td></td><td></td><td class="miti-cell"></td><td></td></tr>
          <tr><td>직접 탈거 및 제거를 할 경우 베임방지 장갑 착용, 보안경 착용 등 안전규정을 지키는가?</td><td></td><td></td><td></td><td class="miti-cell"></td><td></td></tr>
          <tr><td>기존 온도센서 제거 및 자사 온도센서 부착 시 배관 내 압력에 의해 문제가 생길 수 있는가?</td><td></td><td></td><td></td><td class="miti-cell"></td><td></td></tr>
          <tr id="works-last-fixed"><td>220V 이상 전원이 있는 장소에서 작업을 하는가?</td><td></td><td></td><td></td><td class="miti-cell"></td><td></td></tr>

          <!-- 기타 -->
          <tr id="misc-section-row">
            <td id="misc-section-cell" class="section" rowspan="1">
              <div class="section-cell">
                <div class="section-title">기타</div>
                <div class="section-actions">
                  <button id="addMiscRow" class="secondary mini" type="button">+</button>
                  <button id="removeMiscRow" class="warn mini" type="button">-</button>
                </div>
              </div>
            </td>
            <td></td>
            <td></td><td></td><td></td>
            <td class="miti-cell"></td>
            <td></td>
          </tr>
        </tbody>
      </table>
    </div>
  </section>

  <!-- 3) 서명란 -->
  <section id="approvalSection" class="card page-block page-start">
    <h2>현장 확인 및 승인 서명</h2>
    <div style="display:grid; grid-template-columns:repeat(4, 1fr); gap:8px">
      <div class="sig-box">
        <label>작업관리자</label>
        <input id="sigNameSafety" type="text" placeholder="성명" class="field">
        <div class="signature" style="margin-top:6px"><canvas id="sigCanvasSafety"></canvas></div>
        <div style="margin-top:6px"><button class="secondary" id="clearSigSafety" type="button">Clear</button></div>
      </div>

      <div class="sig-box">
        <label>작업자1</label>
        <input id="sigNameW1" type="text" placeholder="성명" class="field">
        <div class="signature" style="margin-top:6px"><canvas id="sigCanvasW1"></canvas></div>
        <div style="margin-top:6px"><button class="secondary" id="clearSigW1" type="button">Clear</button></div>
      </div>

      <div class="sig-box">
        <label>작업자2</label>
        <input id="sigNameW2" type="text" placeholder="성명" class="field">
        <div class="signature" style="margin-top:6px"><canvas id="sigCanvasW2"></canvas></div>
        <div style="margin-top:6px"><button class="secondary" id="clearSigW2" type="button">Clear</button></div>
      </div>

      <div class="sig-box">
        <label>작업자3</label>
        <input id="sigNameW3" type="text" placeholder="성명" class="field">
        <div class="signature" style="margin-top:6px"><canvas id="sigCanvasW3"></canvas></div>
        <!-- (유지) 기존 PDF 버튼 -->
        <button id="printPDF" class="secondary" type="button" title="PDF로 내보내기">PDF</button>
        <!-- ✅ (추가) Android 공유 버튼 -->
        <button id="btnPdfShareAndroid" class="secondary" type="button" title="PDF 생성 + 공유하기">안드로이드</button>
        <div style="margin-top:6px"><button class="secondary" id="clearSigW3" type="button">Clear</button></div>
      </div>
    </div>
  </section>

  <!-- ✅ (추가) PDF 변환용 print-area(화면에는 숨김). 기존 레이아웃/로직에 영향 없음 -->
  <div id="print-area" style="display:none"></div>
</main>

<script>
  /* ===== 기존 완전판의 유틸/초기화/행 추가/서명패드 등 로직 (그대로 유지) ===== */
  const byId = (id)=>document.getElementById(id);
  const qs = (sel)=>document.querySelector(sel);
  const qsa = (sel)=>Array.from(document.querySelectorAll(sel));

  document.addEventListener('DOMContentLoaded', ()=>{
    document.querySelectorAll('thead th.th-center').forEach((th)=>{ th.style.textAlign = 'center'; });
  });

  function injectCheckbox(cell, colKey, labelText){
    const input=document.createElement("input");
    input.type="checkbox"; input.className="riskchk";
    input.setAttribute("data-col", colKey); input.setAttribute("title", labelText);
    const wrap=document.createElement("label");
    wrap.className="chk-wrap"; wrap.appendChild(input);
    cell.innerHTML=""; cell.appendChild(wrap);
    return input;
  }
  function injectTextarea(cell){
    const ta=document.createElement("textarea");
    ta.className="cell-input"; ta.setAttribute("rows","1");
    function autosize(){ ta.style.height="auto"; ta.style.height=(ta.scrollHeight)+"px"; }
    ta.addEventListener("input", autosize); setTimeout(autosize,0);
    cell.innerHTML=""; cell.appendChild(ta);
    return ta;
  }
  function injectMitiInput(cell){
    cell.innerHTML=""; cell.classList.add("miti-cell");
    const ui=document.createElement("div"); ui.className="miti-ui";
    const sel=document.createElement("select"); sel.className="miti-select";
    sel.innerHTML = `
      <option value="">선택</option>
      <option value="완료">안전 조치 완료</option>
      <option value="입력">사용자 입력</option>
    `;
    const user=document.createElement("input"); user.type="text"; user.className="miti-user"; user.style.display="none";
    const printDiv=document.createElement("div"); printDiv.className="miti-print";
    function sync(){
      const v = sel.value;
      if(v === "완료"){ user.style.display="none"; printDiv.textContent = "안전 조치 완료"; }
      else if(v === "입력"){ user.style.display="block"; printDiv.textContent = user.value || ""; }
      else{ user.style.display="none"; printDiv.textContent = ""; }
    }
    sel.addEventListener("change", sync);
    user.addEventListener("input", sync);
    ui.appendChild(sel); ui.appendChild(user);
    cell.appendChild(ui); cell.appendChild(printDiv);
    setTimeout(sync,0);
    return sel;
  }

  function initRiskRow(tr){
    const tds=tr.querySelectorAll("td"); const len=tds.length; if(len<6) return;
    const idxHaz = (len===7 ? 1 : 0);
    const idxOk = idxHaz + 1;
    const idxFix = idxHaz + 2;
    const idxNa = idxHaz + 3;
    const idxMiti= idxHaz + 4;
    const idxDone= idxHaz + 5;
    const isPrepMaster = tr.id === "prep-master-row";
    if(isPrepMaster){
      if(!tds[idxNa].querySelector(".riskchk")) injectCheckbox(tds[idxNa], "na", "해당없음");
    } else {
      if(!tds[idxOk ].querySelector(".riskchk")) injectCheckbox(tds[idxOk ], "ok", "적정");
      if(!tds[idxFix].querySelector(".riskchk")) injectCheckbox(tds[idxFix], "fix", "보완");
      if(!tds[idxNa ].querySelector(".riskchk")) injectCheckbox(tds[idxNa ], "na", "해당없음");
      const rowChks=tr.querySelectorAll(".riskchk");
      rowChks.forEach((chk)=>{
        chk.addEventListener("change", ()=>{
          if(chk.checked && (chk.dataset.col==="ok" || chk.dataset.col==="fix" || chk.dataset.col==="na")){
            rowChks.forEach((other)=>{
              if(other!==chk && (other.dataset.col==="ok" || other.dataset.col==="fix" || other.dataset.col==="na")) other.checked=false;
            });
          }
        });
      });
    }
    if(!tds[idxDone].querySelector(".riskchk")) injectCheckbox(tds[idxDone], "done", "확인");
    if(!tds[idxMiti].querySelector(".miti-select")) injectMitiInput(tds[idxMiti]);
    if(idxHaz>=0 && tds[idxHaz].textContent.trim()==="" && !tds[idxHaz].querySelector(".cell-input")){ injectTextarea(tds[idxHaz]); }
  }
  function initRiskTable(){ document.querySelectorAll("#riskTable tbody tr").forEach(initRiskRow); }

  const PREP_BASE_ROWS = 8;
  const WORKS_BASE_ROWS = 5;
  const MISC_BASE_ROWS = 1;
  function adjustRowspan(cellId, base, delta){
    const td = byId(cellId); if(!td) return;
    const cur = td.rowSpan || base;
    let next = cur + delta;
    if(next < base) next = base;
    td.rowSpan = next;
  }
  function addPrepRow(){
    try{
      const tbody = qs("#riskTable tbody"), lastFixed = byId("prep-last-fixed");
      if(!tbody || !lastFixed) return;
      let insertAfter = lastFixed;
      while(insertAfter.nextElementSibling && insertAfter.nextElementSibling.classList && insertAfter.nextElementSibling.classList.contains("prep-extra-row")){
        insertAfter = insertAfter.nextElementSibling;
      }
      const tr = document.createElement("tr"); tr.className = "prep-extra-row";
      tr.innerHTML = '<td></td><td></td><td></td><td></td><td class="miti-cell"></td><td></td>';
      tbody.insertBefore(tr, insertAfter ? insertAfter.nextElementSibling : null);
      const tds = tr.querySelectorAll("td");
      injectTextarea(tds[0]); injectMitiInput(tds[4]); initRiskRow(tr);
      adjustRowspan("prep-section-cell", PREP_BASE_ROWS, +1);
    }catch(e){ console.error(e); alert("사전준비 작업 행 추가 중 오류: " + (e && e.message ? e.message : e)); }
  }
  function removePrepRow(){
    try{
      const tbody = qs("#riskTable tbody"); if(!tbody) return;
      let lastExtra = null, node = tbody.lastElementChild;
      while(node){
        if(node.classList && node.classList.contains("prep-extra-row")){ lastExtra = node; break; }
        node = node.previousElementSibling;
      }
      if(!lastExtra){ alert("사전준비 섹션에 삭제할 추가 행이 없습니다."); return; }
      tbody.removeChild(lastExtra);
      adjustRowspan("prep-section-cell", PREP_BASE_ROWS, -1);
    }catch(e){ console.error(e); alert("사전준비 작업 행 삭제 중 오류: " + (e && e.message ? e.message : e)); }
  }
  function addWorkRow(){
    try{
      const tbody = qs("#riskTable tbody"), lastFixed = byId("works-last-fixed");
      if(!tbody || !lastFixed) return;
      let insertAfter = lastFixed;
      while(insertAfter.nextElementSibling && insertAfter.nextElementSibling.classList && insertAfter.nextElementSibling.classList.contains("extra-work-row")){
        insertAfter = insertAfter.nextElementSibling;
      }
      const tr = document.createElement("tr"); tr.className = "extra-work-row";
      tr.innerHTML = '<td></td><td></td><td></td><td></td><td class="miti-cell"></td><td></td>';
      tbody.insertBefore(tr, insertAfter ? insertAfter.nextElementSibling : null);
      const tds = tr.querySelectorAll("td");
      injectTextarea(tds[0]); injectMitiInput(tds[4]); initRiskRow(tr);
      adjustRowspan("task-works-label", WORKS_BASE_ROWS, +1);
    }catch(e){ console.error(e); alert("작업시 행 추가 중 오류: " + (e && e.message ? e.message : e)); }
  }
  function removeWorkRow(){
    try{
      const tbody = qs("#riskTable tbody"); if(!tbody) return;
      let lastExtra = null, node = tbody.lastElementChild;
      while(node){
        if(node.classList && node.classList.contains("extra-work-row")){ lastExtra = node; break; }
        node = node.previousElementSibling;
      }
      if(!lastExtra){ alert("작업시 섹션에 삭제할 추가 행이 없습니다."); return; }
      tbody.removeChild(lastExtra);
      adjustRowspan("task-works-label", WORKS_BASE_ROWS, -1);
    }catch(e){ console.error(e); alert("작업시 추가 행 삭제 중 오류: " + (e && e.message ? e.message : e)); }
  }
  function addMiscRow(){
    try{
      const tbody = qs("#riskTable tbody"), miscHead = byId("misc-section-row");
      if(!tbody || !miscHead) return;
      let insertAfter = miscHead;
      while(insertAfter.nextElementSibling && insertAfter.nextElementSibling.classList && insertAfter.nextElementSibling.classList.contains("misc-extra-row")){
        insertAfter = insertAfter.nextElementSibling;
      }
      const tr = document.createElement("tr"); tr.className = "misc-extra-row";
      tr.innerHTML = '<td></td><td></td><td></td><td></td><td class="miti-cell"></td><td></td>';
      tbody.insertBefore(tr, insertAfter ? insertAfter.nextElementSibling : null);
      const tds = tr.querySelectorAll("td");
      injectTextarea(tds[0]); injectMitiInput(tds[4]); initRiskRow(tr);
      adjustRowspan("misc-section-cell", MISC_BASE_ROWS, +1);
    }catch(e){ console.error(e); alert("기타 섹션 행 추가 중 오류: " + (e && e.message ? e.message : e)); }
  }
  function removeMiscRow(){
    try{
      const tbody = qs("#riskTable tbody"); if(!tbody) return;
      let lastExtra = null, node = tbody.lastElementChild;
      while(node){
        if(node.classList && node.classList.contains("misc-extra-row")){ lastExtra = node; break; }
        node = node.previousElementSibling;
      }
      if(!lastExtra){ alert("기타 섹션에 삭제할 추가 행이 없습니다."); return; }
      tbody.removeChild(lastExtra);
      adjustRowspan("misc-section-cell", MISC_BASE_ROWS, -1);
    }catch(e){ console.error(e); alert("기타 섹션 행 삭제 중 오류: " + (e && e.message ? e.message : e)); }
  }

  function setPrepSubRowsDisabled(disabled){
    qsa("#riskTable tbody tr.prep-sub-row").forEach((row)=>{
      ["ok","fix","na","done"].forEach((colKey)=>{
        const chk=row.querySelector('input.riskchk[data-col="'+colKey+'"]');
        if(chk){ if(disabled){ chk.checked=false; } chk.disabled=!!disabled; }
      });
      const sel=row.querySelector('.miti-select');
      const user=row.querySelector('.miti-user');
      if(sel){ sel.disabled=!!disabled; }
      if(user){ user.disabled=!!disabled; }
    });
  }
  function initPrepRowLogic(){
    const master=byId("prep-master-row"); if(!master) return;
    function evalState(){
      const na = master.querySelector('input.riskchk[data-col="na"]');
      const disabled = !!(na && na.checked);
      setPrepSubRowsDisabled(disabled);
    }
    qsa('#prep-master-row input.riskchk[data-col="na"]').forEach((chk)=>{ chk.addEventListener("change", evalState); });
    evalState();
  }

  function initSignature(canvasId, clearBtnId){
    const cvs=byId(canvasId), btn=byId(clearBtnId); if(!cvs) return;
    const ctx=cvs.getContext('2d');
    function resize(){
      const ratio=Math.max((window.devicePixelRatio || 1), 1);
      const rect=cvs.getBoundingClientRect(); const w=Math.floor(rect.width*ratio), h=Math.floor(rect.height*ratio);
      cvs.width=w; cvs.height=h; ctx.setTransform(1,0,0,1,0,0); ctx.scale(ratio,ratio);
      ctx.lineWidth=2; ctx.lineJoin='round'; ctx.lineCap='round'; ctx.strokeStyle='#111827';
      ctx.clearRect(0,0,w,h);
    }
    let drawing=false, last=null;
    function getPos(e){ const r=cvs.getBoundingClientRect(); const t=(e.touches&&e.touches[0])||null; return t?{x:t.clientX-r.left,y:t.clientY-r.top}:{x:e.clientX-r.left,y:e.clientY-r.top}; }
    function start(e){ if(e&&e.preventDefault) e.preventDefault(); drawing=true; last=getPos(e); }
    function move (e){ if(!drawing) return; if(e&&e.preventDefault) e.preventDefault(); const p=getPos(e); ctx.beginPath(); ctx.moveTo(last.x,last.y); ctx.lineTo(p.x,p.y); ctx.stroke(); last=p; }
    function end (){ drawing=false; last=null; }
    cvs.addEventListener('mousedown',start); cvs.addEventListener('mousemove',move); window.addEventListener('mouseup',end);
    cvs.addEventListener('touchstart',start,{passive:false}); cvs.addEventListener('touchmove',move,{passive:false}); cvs.addEventListener('touchend',end);
    window.addEventListener('resize',resize); resize();
    if(btn){ btn.addEventListener('click', ()=>{ ctx.clearRect(0,0,cvs.width,cvs.height); }); }
  }

  function syncSigFromMeta(){
    [
      {src:"fSafety", dst:"sigNameSafety"},
      {src:"fWorker1", dst:"sigNameW1"},
      {src:"fWorker2", dst:"sigNameW2"},
      {src:"fWorker3", dst:"sigNameW3"}
    ].forEach((m)=>{
      const s=byId(m.src), d=byId(m.dst); if(!s || !d) return;
      d.value = s.value || "";
      ["input","change"].forEach((ev)=>{ s.addEventListener(ev, ()=>{ d.value = s.value || ""; }); });
    });
  }

  function equalizeHazardMitiWidth(){
    const isMobile = window.matchMedia("(max-width: 800px), (pointer:coarse)").matches;
    const styleId = "dyn-mobile-cols";
    let styleEl = document.getElementById(styleId);
    if(!styleEl){ styleEl = document.createElement("style"); styleEl.id = styleId; document.head.appendChild(styleEl); }
    if(!isMobile){ styleEl.textContent=""; return; }
    try{
      const tb = document.getElementById("riskTable");
      if(!tb || !tb.tBodies.length) return;
      const firstRow = tb.tBodies[0].rows[0];
      if(!firstRow || firstRow.cells.length < 2) return;
      const hazardCell = firstRow.cells[1];
      const width = Math.round(hazardCell.getBoundingClientRect().width);
      if(width>0){ styleEl.textContent = `@media (max-width:800px), (pointer:coarse){ col.c-miti{ width:${width}px !important; } }`; }
    }catch(e){ /* silent */ }
  }

  function setPrintOrientationClass(){
    try{
      const isLandscape = (window.matchMedia && window.matchMedia("(orientation: landscape)").matches) || (window.innerWidth > window.innerHeight);
      const rootEl = document.documentElement;
      if(isLandscape){ rootEl.classList.add("print-landscape"); rootEl.classList.remove("print-portrait"); }
      else{ rootEl.classList.add("print-portrait"); rootEl.classList.remove("print-landscape"); }
    }catch(e){ /* silent */ }
  }
  function clearPrintOrientationClass(){
    const rootEl = document.documentElement;
    rootEl.classList.remove("print-landscape");
    rootEl.classList.remove("print-portrait");
  }

  function scalePageBlocksForPrint(){
    try{
      const blocks = qsa('.page-block');
      const viewportH = window.innerHeight || document.documentElement.clientHeight || 0;
      const marginComp = 40;
      const usableH = Math.max(0, viewportH - marginComp);
      blocks.forEach(block=>{
        block.style.transform = ''; block.style.width = '';
        const rect = block.getBoundingClientRect(); const h = rect.height;
        if(usableH > 0 && h > usableH){
          let scale = usableH / h; scale = Math.max(0.8, Math.min(1.0, scale));
          block.style.transform = `scale(${scale})`;
          block.style.transformOrigin = 'top left';
          block.style.width = `calc(100% / ${scale})`;
        }
      });
      qsa('.miti-cell').forEach(cell=>{
        const sel = cell.querySelector('.miti-select');
        const user = cell.querySelector('.miti-user');
        const p = cell.querySelector('.miti-print');
        if(!p || !sel) return;
        const v = sel.value;
        if(v === '완료'){ p.textContent = '안전 조치 완료'; }
        else if(v === '입력'){ p.textContent = (user && user.value) ? user.value : ''; }
        else { p.textContent = ''; }
      });
    }catch(e){ /* silent */ }
  }
  function resetBlockScaleAfterPrint(){
    qsa('.page-block').forEach(block=>{ block.style.transform = ''; block.style.width = ''; });
  }

  function attachSafePrint(btn){
    if(!btn) return;
    let printing = false;
    const handler = (ev)=>{
      if(printing) return;
      printing = true;
      try { window.print(); }
      finally { setTimeout(()=>{ printing = false; }, 1200); }
    };
    btn.addEventListener("click", handler, {passive:false});
  }

  function attachDoneMaster(){
    const master = byId("doneMasterChk");
    if(!master) return;
    master.addEventListener("change", ()=>{
      const targets = qsa('#riskTable tbody input.riskchk[data-col="done"]');
      targets.forEach(chk=>{
        if(chk.disabled) return;
        chk.checked = master.checked;
      });
    });
  }

  function resetToMaster(){
    try{
      qsa('.riskchk').forEach((chk)=>{ chk.checked=false; chk.disabled=false; });
      qsa('input[type="text"], input[type="date"], textarea').forEach((el)=>{ if(el.id === "fCompany") return; el.value = ""; });
      qsa('.miti-select').forEach((sel)=>{ sel.value=""; });
      qsa('.miti-user').forEach((inp)=>{ inp.value=""; inp.style.display="none"; });
      qsa('.miti-print').forEach((el)=>{ el.textContent=""; });
      ["sigCanvasSafety","sigCanvasW1","sigCanvasW2","sigCanvasW3"].forEach((cid)=>{
        const cvs=byId(cid); if(!cvs) return; const ctx=cvs.getContext('2d'); ctx.clearRect(0,0,cvs.width,cvs.height);
      });
      qsa(".prep-extra-row").forEach((r)=>{ r.remove(); });
      qsa(".extra-work-row").forEach((r)=>{ r.remove(); });
      qsa(".misc-extra-row").forEach((r)=>{ r.remove(); });
      const prepCell = byId("prep-section-cell"); if(prepCell) prepCell.rowSpan = PREP_BASE_ROWS;
      const worksCell= byId("task-works-label"); if(worksCell) worksCell.rowSpan = WORKS_BASE_ROWS;
      const miscCell = byId("misc-section-cell"); if(miscCell) miscCell.rowSpan = MISC_BASE_ROWS;
      setTimeout(equalizeHazardMitiWidth, 50);
    }catch(e){ console.error(e); alert("초기화 중 오류: " + (e && e.message ? e.message : e)); }
  }

  window.addEventListener('beforeprint', ()=>{ setPrintOrientationClass(); scalePageBlocksForPrint(); });
  window.addEventListener('afterprint',  ()=>{ clearPrintOrientationClass(); resetBlockScaleAfterPrint(); });

  function initAll(){
    try{
      try{
        const raw=localStorage.getItem("hra-risk-mobile-v3");
        if(raw){
          const doc=JSON.parse(raw);
          ["fSiteName","fDiagStart","fDiagEnd","fWrittenDate","fSafety","fWorker1","fWorker2","fWorker3","fRemark"].forEach((id)=>{
            const el=byId(id); if(!el) return;
            const keyMap={fSiteName:"siteName",fDiagStart:"diagStart",fDiagEnd:"diagEnd",fWrittenDate:"writtenDate",fSafety:"safetyManager",
                          fWorker1:"worker1",fWorker2:"worker2",fWorker3:"worker3",fRemark:"remark"};
            const k=keyMap[id]; el.value = (doc.meta && doc.meta[k]) || "";
          });
          const c=byId("fCompany"); if(c) c.value = (doc.meta && doc.meta.companyName) || c.value || "LG전자 ES에너지컨설팅팀";
        }
      }catch(e){}
      const btnPrint = byId("printPDF"), btnClear = byId("clearAll");
      const btnPrepAdd = byId("btnPrepAdd"), btnPrepRemove = byId("btnPrepRemove");
      const btnWorksAdd= byId("btnWorksAdd"),btnWorksRemove = byId("btnWorksRemove");
      const btnMiscAdd = byId("addMiscRow"), btnMiscRemove = byId("removeMiscRow");

      attachSafePrint(btnPrint);
      attachDoneMaster();

      if(btnClear){ btnClear.addEventListener("click", ()=>{ if(confirm("초기화 하시겠습니까? 저장된 데이터가 삭제됩니다.")){ resetToMaster(); } }); }
      if(btnPrepAdd) btnPrepAdd .addEventListener("click", addPrepRow);
      if(btnPrepRemove)btnPrepRemove.addEventListener("click", removePrepRow);
      if(btnWorksAdd) btnWorksAdd .addEventListener("click", addWorkRow);
      if(btnWorksRemove)btnWorksRemove.addEventListener("click", removeWorkRow);
      if(btnMiscAdd) btnMiscAdd .addEventListener("click", addMiscRow);
      if(btnMiscRemove)btnMiscRemove.addEventListener("click", removeMiscRow);

      initRiskTable();
      initPrepRowLogic();
      initSignature('sigCanvasSafety','clearSigSafety');
      initSignature('sigCanvasW1','clearSigW1');
      initSignature('sigCanvasW2','clearSigW2');
      initSignature('sigCanvasW3','clearSigW3');
      syncSigFromMeta();
      setTimeout(equalizeHazardMitiWidth, 50);
      window.addEventListener("resize", ()=>{ requestAnimationFrame(equalizeHazardMitiWidth); });
      window.addEventListener("orientationchange", equalizeHazardMitiWidth);
    }catch(e){ console.error(e); alert("기능 초기화 중 오류: " + (e && e.message ? e.message : e)); }
  }
  window.addEventListener("DOMContentLoaded", initAll);

  /* ──────────────────────────────────────────────────────────────────────────
     ✅ (추가) jsPDF + AutoTable 기반 “PDF 생성 + 공유(안드로이드)” 기능
     - html2canvas 미사용(직접 그리기) [1](https://developer.mozilla.org/en-US/docs/Web/API/Navigator/share)
     - 한국어 폰트(Base64) 임베딩/등록 → iOS/Android에서도 한글 보장 [1](https://developer.mozilla.org/en-US/docs/Web/API/Navigator/share)
     - A4(mm) 자동 맞춤, AutoTable로 표 분할/줄바꿈 [2](https://cdnjs.com/libraries/jspdf)[3](https://github.com/simonbengtsson/jsPDF-AutoTable)
     - Web Share API로 즉시 공유 + 미지원 fallback(다운로드) [4](https://web.dev/patterns/files/share-files/)[5](https://blog.logrocket.com/advanced-guide-web-share-api-navigator-share/)
     - 파일명: 위험성평가_현장.pdf
     - 변환 대상: #print-area
     ────────────────────────────────────────────────────────────────────────── */

  /* (폰트 Base64) 실제 NotoSansKR-Regular.ttf의 전체 Base64를 아래 상수에 그대로 대체하세요. */
  const NOTO_SANS_KR_BASE64 = (
    "AAEAAAAKAQAABAAAR0NCAAAAAAA..." +  // ← 실제 배포 시 전체 Base64로 교체
    "....(중략: 반드시 전체 Base64를 그대로 대체하세요)...."
  );

  const FILE_NAME = "위험성평가_현장.pdf";
  const MARGIN_MM = 12;
  const A4_W_MM = 210, A4_H_MM = 297;
  const CONTENT_W_MM = A4_W_MM - MARGIN_MM * 2;

  const pxToMm = (px) => (px * 25.4 / 96);
  const canShareFile = (file) => (navigator.canShare && navigator.canShare({ files: [file] }));

  async function ensureKoreanFont(doc) {
    const FONT_VFS_NAME = "NotoSansKR-Regular.ttf";
    const FONT_FAMILY   = "NotoSansKR";
    try {
      if (NOTO_SANS_KR_BASE64 && NOTO_SANS_KR_BASE64.length > 1000) {
        doc.addFileToVFS(FONT_VFS_NAME, NOTO_SANS_KR_BASE64);
        doc.addFont(FONT_VFS_NAME, FONT_FAMILY, "normal");
        doc.setFont(FONT_FAMILY, "normal");
        return true;
      }
      // Base64 비어있을 때 fallback: 같은 오리진에서 TTF 로딩 → Base64 변환
      const url = "./fonts/NotoSansKR-Regular.ttf";
      const resp = await fetch(url, { mode:"cors", cache:"force-cache" });
      if (!resp.ok) throw new Error(`폰트 응답 실패: ${resp.status}`);
      const buf = await resp.arrayBuffer();
      const base64 = arrayBufferToBase64(buf);
      doc.addFileToVFS(FONT_VFS_NAME, base64);
      doc.addFont(FONT_VFS_NAME, FONT_FAMILY, "normal");
      doc.setFont(FONT_FAMILY, "normal");
      return true;
    } catch (e) {
      console.warn("폰트 로딩 실패. 기본 폰트로 진행합니다.(한글 깨질 수 있음)", e);
      doc.setFont("Helvetica", "normal");
      return false;
    }
  }
  function arrayBufferToBase64(buf) {
    let binary = "";
    const bytes = new Uint8Array(buf);
    for (let i = 0; i < bytes.byteLength; i++) binary += String.fromCharCode(bytes[i]);
    return btoa(binary);
  }

  /* (도움함수) print-area를 현재 화면 값으로 동적 구성 */
  function buildPrintArea() {
    const area = byId("print-area");
    if (!area) return;
    area.innerHTML = ""; // 초기화

    // 메타 정보 텍스트 블록
    const company  = (byId('fCompany')     || {}).value || 'LG전자 ES에너지컨설팅팀';
    const siteName = (byId('fSiteName')    || {}).value || '';
    const dStart   = (byId('fDiagStart')   || {}).value || '';
    const dEnd     = (byId('fDiagEnd')     || {}).value || '';
    const written  = (byId('fWrittenDate') || {}).value || '';
    const safety   = (byId('fSafety')      || {}).value || '';
    const w1       = (byId('fWorker1')     || {}).value || '';
    const w2       = (byId('fWorker2')     || {}).value || '';
    const w3       = (byId('fWorker3')     || {}).value || '';
    const remark   = (byId('fRemark')      || {}).value || '';

    const metaHTML = `
      <h2>현장 정보</h2>
      <p>업체명: ${company}</p>
      <p>현장명: ${siteName}</p>
      <p>진단 시작: ${dStart} &nbsp;&nbsp; 진단 종료: ${dEnd}</p>
      <p>작성 일자: ${written}</p>
      <p>작업관리자: ${safety} &nbsp;&nbsp; 작업자1: ${w1}</p>
      <p>작업자2: ${w2} &nbsp;&nbsp; 작업자3: ${w3}</p>
      ${remark ? `<p>비고: ${remark}</p>` : ''}
      <h2>작업별 유해·위험요인 평가</h2>
    `;
    area.insertAdjacentHTML('beforeend', metaHTML);

    // 체크리스트 표(현재 화면 값으로 재구성)
    const srcTable = byId("riskTable");
    if (srcTable) {
      const dstTable = document.createElement("table");
      dstTable.id = "riskTable-print";
      const thead = document.createElement("thead");
      thead.innerHTML = `
        <tr>
          <th>작업</th>
          <th>유해·위험요인 파악</th>
          <th>적정</th>
          <th>보완</th>
          <th>해당없음</th>
          <th>보완 대책</th>
          <th>확인</th>
        </tr>`;
      dstTable.appendChild(thead);
      const tbody = document.createElement("tbody");

      Array.from(srcTable.tBodies[0].rows).forEach(tr=>{
        const tds = tr.cells;
        if (!tds || tds.length < 6) return;

        // 유해·위험요인 텍스트
        const hazardCell = tds[1];
        const ta = hazardCell.querySelector('textarea, input[type="text"]');
        const hazardText = ta ? (ta.value || '').trim() : (hazardCell.textContent || '').trim();

        // 체크박스 상태 표시
        const ok   = tr.querySelector('input.riskchk[data-col="ok"]');
        const fix  = tr.querySelector('input.riskchk[data-col="fix"]');
        const na   = tr.querySelector('input.riskchk[data-col="na"]');
        const done = tr.querySelector('input.riskchk[data-col="done"]');
        const mark = c => (!c ? '' : (c.checked ? '☑' : '□'));

        // 보완 대책
        let mitiText = '';
        const sel  = tr.querySelector('.miti-select');
        const user = tr.querySelector('.miti-user');
        if (sel) {
          if (sel.value === '완료')      mitiText = '안전 조치 완료';
          else if (sel.value === '입력') mitiText = (user && user.value) ? user.value : '';
          else                          mitiText = '';
        }

        const row = document.createElement("tr");
        row.innerHTML = `
          <td>${tds[0].textContent.trim()}</td>
          <td>${hazardText}</td>
          <td>${mark(ok)}</td>
          <td>${mark(fix)}</td>
          <td>${mark(na)}</td>
          <td>${mitiText}</td>
          <td>${mark(done)}</td>
        `;
        tbody.appendChild(row);
      });

      dstTable.appendChild(tbody);
      area.appendChild(dstTable);
    }
  }

  function extractTableAsAutoTable(tableEl) {
    const head = [];
    const body = [];
    if (tableEl.tHead) {
      const heads = Array.from(tableEl.tHead.rows[tableEl.tHead.rows.length-1].cells).map(th => th.innerText.trim());
      head.push(heads);
    }
    const rows = Array.from(tableEl.tBodies).flatMap(tbody => Array.from(tbody.rows));
    rows.forEach(tr => {
      const cols = Array.from(tr.cells).map(td => td.innerText.trim());
      body.push(cols);
    });
    return { head, body };
  }

  function drawTextBlock(doc, text, cursor, options = {}) {
    const maxWidth = options.maxWidth ?? (210 - 12*2);
    const fontSize = options.fontSize ?? 10;
    const lineGap  = options.lineGap ?? 4.5; // mm
    doc.setFontSize(fontSize);
    const lines = doc.splitTextToSize(text, maxWidth);
    for (const line of lines) {
      if (cursor.y + lineGap > 297 - 12) { doc.addPage(); cursor.y = 12; }
      doc.text(line, 12, cursor.y);
      cursor.y += lineGap;
    }
  }

  function computeScaleForA4(printAreaEl) {
    const rect = printAreaEl.getBoundingClientRect();
    const areaWidthMm = (rect.width * 25.4 / 96);
    return Math.min(1.0, (210 - 12*2) / Math.max(areaWidthMm, 1));
  }

  async function buildPdfBlobFromPrintArea() {
    const { jsPDF } = window.jspdf; // UMD  [1](https://developer.mozilla.org/en-US/docs/Web/API/Navigator/share)
    const doc = new jsPDF({ orientation:"portrait", unit:"mm", format:"a4" }); // A4(mm)  [2](https://cdnjs.com/libraries/jspdf)

    await ensureKoreanFont(doc);

    doc.setFontSize(14);
    doc.text("모바일 위험성 평가 체크리스트", 12, 12);
    let cursor = { y: 12 + 7 };

    const area = byId("print-area");
    if (!area) throw new Error("print-area를 찾을 수 없습니다.");

    const scale = computeScaleForA4(area);
    const baseFont = 10 * scale;
    const headFont = 12 * scale;

    // 텍스트 블록: h2 + p
    Array.from(area.querySelectorAll('h2, p')).forEach(el=>{
      const isHead = el.tagName.toLowerCase()==='h2';
      drawTextBlock(doc, el.innerText.trim(), cursor, { fontSize: isHead ? headFont : baseFont, lineGap: isHead ? 5.0*scale : 4.5*scale });
    });

    // 표: AutoTable (자동 페이지 분할/줄바꿈)  [3](https://github.com/simonbengtsson/jsPDF-AutoTable)
    const tPrint = byId("riskTable-print");
    if (tPrint) {
      if (cursor.y + 20 > 297 - 12) { doc.addPage(); cursor.y = 12; }
      const { head, body } = extractTableAsAutoTable(tPrint);
      doc.autoTable({
        head, body,
        startY: cursor.y,
        margin: { left:12, right:12 },
        styles:     { fontSize: Math.max(8, baseFont - 1), cellPadding: 1.5, overflow: "linebreak" },
        headStyles: { fillColor:[243,244,246], textColor:0, fontStyle:"bold" },
        theme:"grid",
        pageBreak:"auto",
        rowPageBreak:"avoid"
      });
      cursor.y = doc.lastAutoTable.finalY + 6;
    }

    // 페이지 번호(푸터)
    const pageCount = doc.getNumberOfPages();
    for (let i = 1; i <= pageCount; i++) {
      doc.setPage(i);
      doc.setFontSize(8);
      doc.text(`${i} / ${pageCount}`, 210 - 12, 297 - 10, { align:"right" });
    }

    return doc.output("blob"); // Blob  [1](https://developer.mozilla.org/en-US/docs/Web/API/Navigator/share)
  }

  async function shareOrDownloadPdf(blob) {
    const file = new File([blob], "위험성평가_현장.pdf", { type:"application/pdf" });
    if (navigator.canShare && navigator.canShare({ files:[file] })) { // Web Share API  [4](https://web.dev/patterns/files/share-files/)
      try {
        await navigator.share({ files:[file], title:"위험성 평가 PDF", text:"위험성 평가표 공유" }); // Android 등  [5](https://blog.logrocket.com/advanced-guide-web-share-api-navigator-share/)
        return;
      } catch (err) {
        if (!err || err.name !== "AbortError") alert(`공유 중 오류: ${err?.message || err}`);
      }
    }
    // fallback: 다운로드
    const a = document.createElement("a");
    a.download = "위험성평가_현장.pdf";
    a.href = URL.createObjectURL(blob);
    document.body.appendChild(a);
    a.click();
    setTimeout(()=>{ URL.revokeObjectURL(a.href); a.remove(); }, 1000);
  }

  async function onAndroidPdfShareClick() {
    try {
      buildPrintArea();                      // 현재 화면 값으로 print-area 구성
      const blob = await buildPdfBlobFromPrintArea();
      await shareOrDownloadPdf(blob);
    } catch (e) {
      alert(`PDF 생성 실패: ${e?.message || e}`);
      console.error(e);
    }
  }

  // ✅ (추가) 안드로이드 버튼 연결 — 기존 initAll/기능 변경 없음
  window.addEventListener("DOMContentLoaded", () => {
    const btnAndroid = byId('btnPdfShareAndroid');
    if (btnAndroid) btnAndroid.addEventListener('click', onAndroidPdfShareClick);
  });
</script>
</body>
</html>
'@

# 파일 쓰기
Set-Content -Path $indexPath -Value $html -Encoding UTF8

# 폰트 복사(있을 경우)
$fontFiles = @("LGSmartRegular.woff2","LGSmartRegular.woff")
foreach($f in $fontFiles){
  $src = Join-Path $PSScriptRoot $f
  $dst = Join-Path $OutDir $f
  if(Test-Path $src){ Copy-Item -LiteralPath $src -Destination $dst -Force }
}

# 해시 출력(선택)
if ($Hash) {
  try {
    $h = Get-FileHash -LiteralPath $indexPath -Algorithm SHA256
    Write-Host ("SHA256: " + $h.Hash)
  } catch {
    Write-Warning "SHA256 해시 계산 실패: $($_.Exception.Message)"
  }
}

# 자동 열기(선택)
if ($Open) {
  try {
    Start-Process $indexPath
    Write-Host "생성 완료: $indexPath (자동 열기)"
  } catch {
    Write-Warning "생성은 완료되었지만 자동 열기에 실패했습니다. 파일을 직접 더블클릭 해주세요."
  }
} else {
  Write-Host "생성 완료: $indexPath"
}
``
