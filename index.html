<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="color-scheme" content="light" />
  <title>LG전자 ES에너지컨설팅팀 위험성 평가표 (모바일 표 Ver.)</title>

  <!--  CDN 로드 태그 수정(이전 버전의 잘못된 표기 수정) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

  <style>
    @font-face {
      font-family: "LG스마트체";
      src: url("LGSmartRegular.woff2") format("woff2"),
           url("LGSmartRegular.woff")  format("woff");
      font-weight: 400; font-style: normal; font-display: swap;
    }
    :root{
      --bg:#f6f7fb; --card:#fff; --text:#111827; --border:#e5e7eb; --primary:#111827;
      --fs-body: clamp(15.6px, 2.04vw, 18px);
      --fs-label: clamp(14.4px, 1.92vw, 16.8px);
      --fs-title: clamp(21.6px, 4.32vw, 26.4px);
      --fs-h2: clamp(16.8px, 3.12vw, 19.2px);
      --fs-btn: clamp(15.6px, 2.88vw, 18px);
      --line:1.45; --radius:12px; --table-pad:6px;
      --radius-input:10px; --focus:#3b82f6; --shadow:0 2px 6px rgba(0,0,0,.06); --title-accent:#8B1B3D;
    }
    *{ box-sizing:border-box }
    html,body{
      margin:0; padding:0; width:100%; min-height:100vh; overflow-x:hidden;
      -webkit-text-size-adjust:100%; -webkit-tap-highlight-color:transparent;
      background:var(--bg); color:var(--text);
      font-family:"LG스마트체","Malgun Gothic","Apple SD Gothic Neo","Noto Sans KR",system-ui,-apple-system,"Segoe UI",Roboto,sans-serif;
      font-size:var(--fs-body); line-height:var(--line);
    }
    header{
      background:var(--card);
      border-bottom:1px solid var(--border);
      position:sticky; top:0; z-index:10;
      backdrop-filter:saturate(120%) blur(6px);
    }
    .wrap{max-width:1000px; margin:0 auto; padding:12px}
    .brand{display:flex; align-items:center; justify-content:space-between; gap:8px}
    .title{font-weight:800;}
    .main-title{
      color:var(--title-accent);
      font-size:calc(var(--fs-title) + 8px);
      text-shadow:0 1px 0 rgba(0,0,0,.05);
      letter-spacing:2px;
      transform:translateY(-4px);
      text-align:center;
      line-height:1.25;
      margin:6px 0 10px 0;
    }
    .toolbar{display:flex; gap:8px; margin-top:8px}
    .toolbar-left{display:flex; gap:8px; margin-right:auto}
    button{
      border:1px solid var(--border); background:var(--primary); color:#fff;
      border-radius:var(--radius); padding:9px 12px; font-size:var(--fs-btn);
      min-height:40px; cursor:pointer; font-family:inherit;
    }
    button.secondary{background:#374151}
    button.warn{background:#b91c1c}
    button.mini{ padding:6px 8px; min-height:32px; font-size:calc(var(--fs-btn) - 2px); border-radius:10px }
    @media (pointer:coarse){
      button{min-height:44px}
      input,select,textarea{min-height:48px; font-family:inherit}
      .table-wrap{overflow-x:auto; -webkit-overflow-scrolling:touch}
      button.mini{ min-height:36px }
    }
    main{padding:12px 0}
    .card{
      background:var(--card); border:1px solid var(--border); border-radius:var(--radius);
      padding:18px; margin:12px auto; box-shadow:var(--shadow)
    }
    .field{
      width:100%; padding:10px 12px;
      border:1px solid var(--border); border-radius:var(--radius-input);
      outline:none; font-family:inherit; font-size:inherit; background:#fff;
      transition:border-color .15s ease, box-shadow .15s ease;
      min-height:48px;
    }
    .field:focus{ border-color:var(--focus); box-shadow:0 0 0 3px rgba(59,130,246,.15) }
    .field.textarea{ min-height:72px; resize:vertical }

    .table-wrap{
      width:100%; overflow-x:auto; -webkit-overflow-scrolling:touch;
      border:1px solid var(--border); border-radius:var(--radius); background:#fff;
    }
    table{
      width:100%; border-collapse:collapse; min-width:920px; table-layout:fixed; /* 고정 레이아웃(공유 캡처에도 일관성) */
      word-break:keep-all; font-family:inherit;
    }

    /* 화면용 열 폭(기존 유지) */
    col.c-task { width:72px }
    col.c-hazard{ width:364px }
    col.c-ok { width:72px }
    col.c-fix { width:72px }
    col.c-na  { width:88px }
    col.c-miti{ width:220px }
    col.c-done{ width:56px }

    th,td{ border:1px solid var(--border); padding:var(--table-pad); font-size:var(--fs-body); vertical-align:top }
    thead th{ background:#f3f4f6; text-align:center; white-space:nowrap }
    td{ text-align:left }
    td.section{
      text-align:center !important; vertical-align:middle !important; font-weight:600; background:#f8fafc;
    }
    .section-cell{ display:flex; flex-direction:column; align-items:center; justify-content:space-between; min-height:100%; gap:8px }
    .section-title{ font-weight:700 }
    .section-actions{ display:flex; gap:6px; justify-content:center; flex-wrap:wrap }

    .chk-wrap{ display:flex; align-items:center; justify-content:center; min-height:32px; }
    .riskchk{ width:18px; height:18px; accent-color:#111827; cursor:pointer; }
    @media(pointer:coarse){ .riskchk{ width:21px; height:21px } }

    .cell-input{
      width:100%; min-height:40px; border:1px solid var(--border); border-radius:8px; background:#fff;
      font-family:inherit; font-size:inherit; padding:6px 8px; outline:none;
      white-space:pre-wrap; word-break:break-word; overflow-wrap:break-word; resize:vertical;
    }

    /*  드롭셀/사용자입력 UI */
    .miti-cell{
      padding:6px !important;
      position:relative;
    }
    .miti-ui{ display:flex; flex-direction:column; gap:6px; }
    .miti-select, .miti-user{
      box-sizing:border-box; width:100%;
      height:48px; padding:0 34px 0 10px; border:1px solid var(--border);
      border-radius:8px; background:#fff; font-family:inherit; font-size:inherit; line-height:48px; outline:none;
      -webkit-appearance:none; appearance:none; background-image:none;
    }
    .miti-user{ display:none; padding:6px 8px; line-height:normal; }
    .miti-cell::after{
      content:""; position:absolute; right:14px; top:50%; margin-top:-4px;
      width:0; height:0; border-left:6px solid transparent; border-right:6px solid transparent; border-top:8px solid #6b7280; pointer-events:none;
    }
    .miti-print{ display:none; min-height:48px; white-space:pre-wrap; word-break:break-word; }

    .signature{ width:100%; height:130px }
    .sig-box{ position:relative }

    /* 버튼: PDF 오른쪽, 공유는 그 왼쪽(기존 위치 유지) */
    #sharePDF{ position:absolute; top:-50px; right:88px; z-index:10000; pointer-events:auto; }
    #printPDF{ position:absolute; top:-50px; right:14px;  z-index:10000; pointer-events:auto; }

    .signature canvas{
      width:100%; height:100%; display:block; border:1px dashed var(--border);
      border-radius:8px; background:#fff; touch-action:none
    }

    /*  @media print 인쇄 최적화(기존 유지)  */
    @page{ margin:12mm }
    @media print{
      html, body{ background:#fff !important; color:#000 !important; -webkit-print-color-adjust: exact; print-color-adjust: exact; }
      .wrap{ transform:none !important; width:auto !important }
      header,.toolbar{ display:none !important }
      .card{ box-shadow:none !important; background:#fff !important; border-color:#ddd !important; transform-origin:top left; }
      .table-wrap, table, thead, tbody, tfoot, tr, th, td, input.field, textarea.field, .signature canvas{ background:#fff !important; }
      thead th{ background:#fff !important } td.section{ background:#fff !important }
      #printPDF, #sharePDF, #clearAll, #clearSigSafety, #clearSigW1, #clearSigW2, #clearSigW3{ display:none !important; }
      .section-actions{ display:none !important; }
      thead{ display:table-header-group !important } tfoot{ display:table-footer-group !important }
      table{ min-width:auto; width:100%; table-layout:auto; border-collapse:collapse }
      .table-wrap{ overflow:visible !important }
      tr, th, td, .sig-box, .signature, .section-cell, .miti-print, .cell-input, .miti-select, .miti-user{ page-break-inside:avoid !important; break-inside:avoid !important; }
      .page-block{ page-break-inside:avoid !important; break-inside:avoid !important; }
      .page-start{ page-break-before:always !important; break-before:page !important; }
      html.print-portrait  col.c-task {width:8%!important}  html.print-portrait  col.c-hazard{width:36%!important}
      html.print-portrait  col.c-ok   {width:6%!important}  html.print-portrait  col.c-fix   {width:6%!important}
      html.print-portrait  col.c-na   {width:6%!important}  html.print-portrait  col.c-miti  {width:36%!important}
      html.print-portrait  col.c-done {width:2%!important}
      html.print-landscape col.c-task {width:8%!important}  html.print-landscape col.c-hazard{width:36%!important}
      html.print-landscape col.c-ok   {width:5%!important}  html.print-landscape col.c-fix   {width:5%!important}
      html.print-landscape col.c-na   {width:5%!important}  html.print-landscape col.c-miti  {width:36%!important}
      html.print-landscape col.c-done {width:5%!important}
      .miti-ui{ display:none !important; }
      .miti-print{ display:block !important; }
    }

    /*  모바일 전용 (유지) */
    @media (max-width:800px), (pointer:coarse){
      col.c-hazard, col.c-miti { width:182px !important }
      tbody td:nth-child(2){ word-break:break-word; overflow-wrap:break-word; white-space:normal }
      main .card:first-of-type input[type="date"].field{
        width:100%; min-width:0; -webkit-appearance:none; appearance:none; height:48px; line-height:48px; color:var(--text); caret-color:var(--text);
      }
      main .card:first-of-type input[type="date"].field::-webkit-calendar-picker-indicator{ margin:0 6px 0 0; padding:0; width:18px; height:18px; }
      .wrap{ transform:scale(.8); transform-origin:top left; width:calc(100%/.8) }
    }

    #approvalSection > h2{ font-size:calc(var(--fs-h2) - 4px + 3px) }

    /* 
        공유용 캡처 모드(세로 인쇄와 동일 + Android/iOS 보정)
        */
    html.capture-print header,
    html.capture-print .toolbar{ display:none !important; }

    /* 캡처 모드에서는 화면 축소(transform) 없이 자연 폭으로 캡처 */
    html.capture-print .wrap{ transform:none !important; width:auto !important }

    /* 캡처 중 버튼/액션만 잠시 숨김  캡처 종료 시 즉시 복원됨 */
    html.capture-print #printPDF,
    html.capture-print #sharePDF,
    html.capture-print #clearAll,
    html.capture-print #clearSigSafety,
    html.capture-print #clearSigW1,
    html.capture-print #clearSigW2,
    html.capture-print #clearSigW3{ display:none !important; }

    html.capture-print .section-actions{ display:none !important; }

    /* 테이블/헤더/오버플로우: 인쇄 규칙 그대로 */
    html.capture-print .table-wrap{ overflow:visible !important }
    html.capture-print thead{ display:table-header-group !important }

    /*  캡처 모드 전용: 테이블 픽셀 폭 고정(너비 부족 방지) */
    html.capture-print #riskTable{ width:980px !important; } /* iPhone에서 열 좁아짐 방지 */

    html.capture-print table{
      min-width:auto; table-layout:fixed; border-collapse:collapse; background:#fff !important;
    }
    html.capture-print #riskTable thead th,
    html.capture-print #riskTable tbody td{ box-sizing:border-box; }

    html.capture-print td.section{ background:#fff !important }
    html.capture-print tr, html.capture-print th, html.capture-print td,
    html.capture-print .sig-box, html.capture-print .signature,
    html.capture-print .section-cell, html.capture-print .miti-print,
    html.capture-print .cell-input, html.capture-print .miti-select, html.capture-print .miti-user{
      page-break-inside:avoid !important; break-inside:avoid !important; background:#fff !important;
      word-break:break-word; overflow-wrap:break-word;
    }

    /* 캡처 모드: UI 숨김  텍스트 출력 */
    html.capture-print .miti-ui{ display:none !important; }
    html.capture-print .miti-print{ display:block !important; }

    /* 세로 열폭(인쇄 동일)  퍼센트 폭을 강제 */
    html.capture-print.print-portrait  col.c-task {width:8%!important}
    html.capture-print.print-portrait  col.c-hazard{width:36%!important}
    html.capture-print.print-portrait  col.c-ok   {width:6%!important}
    html.capture-print.print-portrait  col.c-fix  {width:6%!important}
    html.capture-print.print-portrait  col.c-na   {width:6%!important}
    html.capture-print.print-portrait  col.c-miti {width:36%!important}
    html.capture-print.print-portrait  col.c-done {width:2%!important}

    /*  Android 클립 방지: 보완대책/확인 최소 너비 보강(캡처 모드 전용) */
    html.capture-print #riskTable thead th:nth-child(6),
    html.capture-print #riskTable tbody td:nth-child(6){ min-width:160px !important; } /* 보완대책(열6) */
    html.capture-print #riskTable thead th:nth-child(7),
    html.capture-print #riskTable tbody td:nth-child(7){ min-width:40px  !important; } /* 확인(열7) */
    html.capture-print .riskchk{ width:20px; height:20px; } /* 체크 크기 살짝 확대(클립 여유) */
  </style>
</head>
<body>
  <header>
    <div class="wrap">
      <div class="brand">
        <div class="title">LG전자 ES에너지컨설팅팀 위험성 평가표 (모바일 표 Ver.)</div>
      </div>
      <div class="toolbar">
        <div class="toolbar-left">
          <button id="clearAll" class="warn" type="button">초기화</button>
        </div>
      </div>
    </div>
  </header>

  <main class="wrap">
    <!-- 1) 현장 정보란 -->
    <section class="card page-block" id="metaCard">
      <div class="title main-title">수시 위험성 평가표</div>
      <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px">
        <div><label class="hint">업체명</label><input id="fCompany" type="text" value="LG전자 ES에너지컨설팅팀" class="field"></div>
        <div><label class="hint">현장명</label><input id="fSiteName" type="text" placeholder="예: 공장 라인" class="field"></div>
        <div><label class="hint">진단 시작</label><input id="fDiagStart" type="date" class="field"></div>
        <div><label class="hint">진단 종료</label><input id="fDiagEnd" type="date" class="field"></div>
        <div><label class="hint">작성 일자</label><input id="fWrittenDate" type="date" class="field"></div>
        <div><label class="hint">현장관리자</label><input id="fSafety" type="text" placeholder="성명" class="field"></div>
        <div><label class="hint">실무자1</label><input id="fWorker1" type="text" placeholder="성명" class="field"></div>
        <div><label class="hint">실무자2</label><input id="fWorker2" type="text" placeholder="성명" class="field"></div>
        <div><label class="hint">실무자3</label><input id="fWorker3" type="text" placeholder="성명" class="field"></div>
        <div style="grid-column:1/-1"><label class="hint">비고</label>
          <textarea id="fRemark" class="field textarea" placeholder="특이사항/참고사항"></textarea>
        </div>
      </div>
    </section>

    <!-- 2) 체크리스트 -->
    <section class="card page-block page-start" id="checklistCard">
      <h2 style="display:none">작업별 유해위험요인 평가</h2>
      <div class="table-wrap">
        <table id="riskTable">
          <colgroup>
            <col class="c-task"/><col class="c-hazard"/><col class="c-ok"/><col class="c-fix"/><col class="c-na"/><col class="c-miti"/><col class="c-done"/>
          </colgroup>
          <thead>
            <tr>
              <th rowspan="2" class="th-center">작업</th>
              <th rowspan="2" class="th-center">유해위험요인 파악</th>
              <th colspan="3" class="th-center">위험성 확인결과</th>
              <th rowspan="2" class="th-center">보완 대책</th>
              <th rowspan="2" class="th-center">
                <div style="display:flex; flex-direction:column; align-items:center; gap:4px">
                  <span>확인</span>
                  <label class="chk-wrap" title="전체 확인 체크/해제">
                    <input id="chkConfirmAll" type="checkbox" class="riskchk" style="width:18px;height:18px">
                  </label>
                </div>
              </th>
            </tr>
            <tr>
              <th>적정</th><th>보완</th><th>해당없음</th>
            </tr>
          </thead>
          <tbody>
            <!-- 사전준비/작업시/기타 행들(기존 유지) -->
            <tr id="prep-master-row">
              <td id="prep-section-cell" class="section" rowspan="8">
                <div class="section-cell">
                  <div class="section-title">사전준비 작업</div>
                  <div class="section-actions">
                    <button type="button" class="secondary mini" id="btnPrepAdd">+</button>
                    <button type="button" class="warn mini" id="btnPrepRemove">-</button>
                  </div>
                </div>
              </td>
              <td>작업 장소 (기계실, 전기실, 옥상 등)까지 또는 장소 내 이동 및 작업에 있어 유해, 위험 요인이 있는가? 있다면 아래 점검.</td>
              <td class="no-ok"></td>
              <td class="no-fix"></td>
              <td></td>
              <td class="miti-cell"></td>
              <td></td>
            </tr>
            <!--  (중략) 기존 행들 그대로  -->
            <tr id="misc-section-row">
              <td id="misc-section-cell" class="section" rowspan="1">
                <div class="section-cell">
                  <div class="section-title">기타</div>
                  <div class="section-actions">
                    <button id="addMiscRow" class="secondary mini" type="button">+</button>
                    <button id="removeMiscRow" class="warn mini" type="button">-</button>
                  </div>
                </div>
              </td>
              <td></td>
              <td></td><td></td><td></td>
              <td class="miti-cell"></td>
              <td></td>
            </tr>
          </tbody>
        </table>
      </div>
    </section>

    <!-- 3) 서명란 -->
    <section id="approvalSection" class="card page-block page-start">
      <h2>현장 확인 및 승인 서명</h2>
      <div style="display:grid; grid-template-columns:repeat(4, 1fr); gap:8px">
        <div class="sig-box">
          <label>현장관리자</label>
          <input id="sigNameSafety" type="text" placeholder="성명" class="field">
          <div class="signature" style="margin-top:6px"><canvas id="sigCanvasSafety"></canvas></div>
          <div style="margin-top:6px"><button class="secondary" id="clearSigSafety" type="button">Clear</button></div>
        </div>
        <div class="sig-box">
          <label>실무자1</label>
          <input id="sigNameW1" type="text" placeholder="성명" class="field">
          <div class="signature" style="margin-top:6px"><canvas id="sigCanvasW1"></canvas></div>
          <div style="margin-top:6px"><button class="secondary" id="clearSigW1" type="button">Clear</button></div>
        </div>
        <div class="sig-box">
          <label>실무자2</label>
          <input id="sigNameW2" type="text" placeholder="성명" class="field">
          <div class="signature" style="margin-top:6px"><canvas id="sigCanvasW2"></canvas></div>
          <div style="margin-top:6px"><button class="secondary" id="clearSigW2" type="button">Clear</button></div>
        </div>
        <div class="sig-box">
          <label>실무자3</label>
          <input id="sigNameW3" type="text" placeholder="성명" class="field">
          <div class="signature" style="margin-top:6px"><canvas id="sigCanvasW3"></canvas></div>

          <!-- 공유 버튼( PDF 왼쪽 ) -->
          <button id="sharePDF" class="secondary" type="button" title="PDF 공유">공유</button>
          <!-- PDF 버튼 -->
          <button id="printPDF" class="secondary" type="button" title="PDF로 내보내기">PDF</button>

          <div style="margin-top:6px"><button class="secondary" id="clearSigW3" type="button">Clear</button></div>
        </div>
      </div>
    </section>
  </main>

  <script>
    const byId = (id)=>document.getElementById(id);
    const qs  = (sel)=>document.querySelector(sel);
    const qsa = (sel)=>Array.from(document.querySelectorAll(sel));

    /* 헤더 th 중앙 정렬(유지) */
    document.addEventListener('DOMContentLoaded', ()=>{
      document.querySelectorAll('thead th.th-center').forEach((th)=>{ th.style.textAlign = 'center'; });
    });

    /*  (기존 injectCheckbox/injectTextarea/injectMitiInput/initRiskRow 등 함수는 그대로 유지  생략)  */

    /* 인쇄 방향 클래스(유지) */
    function setPrintOrientationClass(){
      try{
        const isLandscape = (window.matchMedia && window.matchMedia("(orientation: landscape)").matches) || (window.innerWidth > window.innerHeight);
        const rootEl = document.documentElement;
        if(isLandscape){
          rootEl.classList.add("print-landscape");
          rootEl.classList.remove("print-portrait");
        }else{
          rootEl.classList.add("print-portrait");
          rootEl.classList.remove("print-landscape");
        }
      }catch(e){ /* silent */ }
    }
    function clearPrintOrientationClass(){
      const rootEl = document.documentElement;
      rootEl.classList.remove("print-landscape");
      rootEl.classList.remove("print-portrait");
    }

    /* 프린트 이벤트(유지) */
    window.addEventListener('beforeprint', ()=>{ setPrintOrientationClass(); /* scalePageBlocksForPrint(); */ });
    window.addEventListener('afterprint',  ()=>{ clearPrintOrientationClass(); /* resetBlockScaleAfterPrint(); */ });

    /*  공유용 캡처 모드  적용/해제 보장 */
    function applyCapturePrintMode(){
      const root = document.documentElement;
      root.classList.add('capture-print');
      root.classList.add('print-portrait');  // 세로 인쇄 동일
    }
    function clearCapturePrintMode(){
      const root = document.documentElement;
      root.classList.remove('capture-print');
      root.classList.remove('print-portrait');
    }

    /* A4 mm */
    const PDF_MM = { w: 210, h: 297, margin: 12 };

    async function makePdfBlob(){
      let blob = null;
      try{
        applyCapturePrintMode();

        const hasH2C  = !!window.html2canvas;
        const hasJsPDF= !!window.jspdf && !!window.jspdf.jsPDF;
        if(!hasH2C || !hasJsPDF){ window.print(); return null; }

        const jsPDF = window.jspdf.jsPDF;
        const doc   = new jsPDF({ orientation:'portrait', unit:'mm', format:'a4' });

        const blocks = qsa('.page-block');
        for(let i=0;i<blocks.length;i++){
          const el = blocks[i];
          const canvas = await html2canvas(el, {
            scale: Math.max(window.devicePixelRatio||1, 2),
            useCORS:true,
            background:'#ffffff'
          });
          const imgData = canvas.toDataURL('image/jpeg', 0.92);
          const pageW = PDF_MM.w - PDF_MM.margin*2;
          const pageH = PDF_MM.h - PDF_MM.margin*2;
          const imgWpx = canvas.width, imgHpx = canvas.height;
          const imgRatio = imgWpx / imgHpx;
          let drawW = pageW, drawH = drawW / imgRatio;
          if(drawH > pageH){ drawH = pageH; drawW = drawH * imgRatio; }
          if(i>0) doc.addPage('a4', 'portrait');
          doc.addImage(imgData, 'JPEG',
                       PDF_MM.margin + (pageW - drawW)/2,
                       PDF_MM.margin + (pageH - drawH)/2,
                       drawW, drawH);
        }
        blob = doc.output('blob');
        return blob;

      }catch(e){
        console.error(e);
        return null;
      }finally{
        /*  반드시 UI 복구  메뉴/버튼이 사라지는 현상 방지 */
        clearCapturePrintMode();
      }
    }

    /* 공유 동작 */
    async function sharePdfFromButton(){
      try{
        const blob = await makePdfBlob();
        if(!blob){ return; }
        const fileName = `위험성평가_${new Date().toISOString().slice(0,10)}.pdf`;
        const file = new File([blob], fileName, { type:'application/pdf' });

        const canShare = !!navigator.canShare && navigator.canShare({ files:[file] });
        if(canShare && navigator.share){
          await navigator.share({
            title: '위험성 평가 PDF',
            text: '위험성 평가표 (모바일 표 Ver.)',
            files: [file]
          });
        }else{
          const url = URL.createObjectURL(blob);
          const w = window.open(url, '_blank');
          setTimeout(()=>URL.revokeObjectURL(url), 60*1000);
        }
      }catch(err){
        console.error('PDF 공유 중 오류:', err);
      }finally{
        /* 추가 복구 보장(이중 안전) */
        clearCapturePrintMode();
      }
    }

    /* 프린트 버튼  사용자 제스처 내 동기 호출(팝업 차단 회피) */
    function attachSafePrint(btn){
      if(!btn) return;
      let printing = false;
      const handler = ()=>{
        if(printing) return;
        printing = true;
        try { window.print(); } finally { setTimeout(()=>{ printing = false; }, 1200); }
      };
      btn.addEventListener("click", handler, {passive:false});
      btn.addEventListener("pointerup", handler, {passive:false});
    }

    /*  (initRiskTable / initPrepRowLogic / initConfirmMaster / initSignature / syncSigFromMeta 등 기존 함수는 유지)  */

    function initAll(){
      try{
        const btnPrint = byId("printPDF"),
              btnShare = byId("sharePDF"),
              btnClear = byId("clearAll");

        attachSafePrint(btnPrint);

        if(btnShare){
          const handler = async ()=>{ await sharePdfFromButton(); };
          btnShare.addEventListener("click", handler, {passive:false});
          btnShare.addEventListener("pointerup", handler, {passive:false});
        }

        if(btnClear){
          btnClear.addEventListener("click", ()=>{
            if(confirm("초기화 하시겠습니까? 저장된 데이터가 삭제됩니다.")){
              /* 기존 resetToMaster 호출(생략) */
              location.reload(); /* 메뉴/버튼 복구 보장  최소 변경 대안 */
            }
          });
        }

        /*  나머지 초기화 로직(행 추가/삭제 등) 기존과 동일  */
      }catch(e){
        console.error(e); alert("기능 초기화 중 오류: " + (e && e.message ? e.message : e));
      }
    }
    window.addEventListener("DOMContentLoaded", initAll);
  </script>
</body>
</html>
