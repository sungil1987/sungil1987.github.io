<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<meta name="color-scheme" content="light" />
<title>LG전자 ES에너지컨설팅팀 위험성 평가표 (모바일 표 Ver.)</title>

<!--  html2pdf.js (CDN) -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"
        integrity="sha512-GsLlZN/3F2ErC5ifS5QtgpiJtWd43JWSuIgh7mbzZ8zBps+dvLusV+eNQATqgA/HdeKFVgA5v3S/cIrLF7QnIg=="
        crossorigin="anonymous" referrerpolicy="no-referrer"></script>

<style>
@font-face{
  font-family: "LG스마트체";
  src: url("LGSmartRegular.woff2") format("woff2"),
       url("LGSmartRegular.woff") format("woff");
  font-weight: 400; font-style: normal; font-display: swap;
}
:root{
  --bg:#f6f7fb; --card:#fff; --text:#111827; --border:#e5e7eb; --primary:#111827;
  --fs-body: clamp(15.6px, 2.04vw, 18px);
  --fs-label: clamp(14.4px, 1.92vw, 16.8px);
  --fs-title: clamp(21.6px, 4.32vw, 26.4px);
  --fs-h2: clamp(16.8px, 3.12vw, 19.2px);
  --fs-btn: clamp(15.6px, 2.88vw, 18px);
  --line:1.45; --radius:12px; --table-pad:6px;
  --radius-input:10px; --focus:#3b82f6; --shadow:0 2px 6px rgba(0,0,0,.06); --title-accent:#8B1B3D;
}
*{ box-sizing:border-box }
html,body{
  margin:0; padding:0; width:100%; min-height:100vh; overflow-x:hidden;
  -webkit-text-size-adjust:100%; -webkit-tap-highlight-color:transparent;
  background:var(--bg); color:var(--text);
  font-family:"LG스마트체","Malgun Gothic","Apple SD Gothic Neo","Noto Sans KR",system-ui,-apple-system,"Segoe UI",Roboto,sans-serif;
  font-size:var(--fs-body); line-height:var(--line);
}
header{
  background:var(--card);
  border-bottom:1px solid var(--border);
  position:sticky; top:0; z-index:10;
  backdrop-filter:saturate(120%) blur(6px);
}
.wrap{max-width:1000px; margin:0 auto; padding:12px}
.brand{display:flex; align-items:center; justify-content:space-between; gap:8px}
.title{font-weight:800;}
.main-title{
  color:var(--title-accent);
  font-size:calc(var(--fs-title) + 8px);
  text-shadow:0 1px 0 rgba(0,0,0,.05);
  letter-spacing:2px;
  transform:translateY(-4px);
  text-align:center;
  line-height:1.25;
  margin:6px 0 10px 0;
}
.toolbar{display:flex; gap:8px; margin-top:8px}
.toolbar-left{display:flex; gap:8px; margin-right:auto}
button{
  border:1px solid var(--border); background:var(--primary); color:#fff;
  border-radius:var(--radius); padding:9px 12px; font-size:var(--fs-btn);
  min-height:40px; cursor:pointer; font-family:inherit;
}
button.secondary{background:#374151}
button.warn{background:#b91c1c}
button.mini{ padding:6px 8px; min-height:32px; font-size:calc(var(--fs-btn) - 2px); border-radius:10px }
@media (pointer:coarse){
  button{min-height:44px}
  input,select,textarea{min-height:48px; font-family:inherit}
  .table-wrap{overflow-x:auto; -webkit-overflow-scrolling:touch}
  button.mini{ min-height:36px }
}
main{padding:12px 0}
.card{
  background:var(--card); border:1px solid var(--border); border-radius:var(--radius);
  padding:18px; margin:12px auto; box-shadow:var(--shadow)
}
.field{
  width:100%; padding:10px 12px;
  border:1px solid var(--border); border-radius:var(--radius-input);
  outline:none; font-family:inherit; font-size:inherit; background:#fff;
  transition:border-color .15s ease, box-shadow .15s ease;
  min-height:48px;
}
.field:focus{ border-color:var(--focus); box-shadow:0 0 0 3px rgba(59,130,246,.15) }
.field.textarea{ min-height:72px; resize:vertical }
.table-wrap{
  width:100%; overflow-x:auto; -webkit-overflow-scrolling:touch;
  border:1px solid var(--border); border-radius:var(--radius); background:#fff;
}
table{
  width:100%; border-collapse:collapse; min-width:920px; table-layout:fixed;
  word-break:keep-all; font-family:inherit;
}
/* 화면용 열 폭 */
col.c-task{ width:72px }
col.c-hazard{ width:364px }
col.c-ok{ width:72px }
col.c-fix{ width:72px }
col.c-na{ width:88px }
col.c-miti{ width:220px }
col.c-done{ width:56px }
th,td{ border:1px solid var(--border); padding:var(--table-pad); font-size:var(--fs-body); vertical-align:top }
thead th{ background:#f3f4f6; text-align:center; white-space:nowrap }
td{ text-align:left }
td.section{
  text-align:center !important; vertical-align:middle !important; font-weight:600; background:#f8fafc;
}
.section-cell{ display:flex; flex-direction:column; align-items:center; justify-content:space-between; min-height:100%; gap:8px }
.section-title{ font-weight:700 }
.section-actions{ display:flex; gap:6px; justify-content:center; flex-wrap:wrap } /* + / - 버튼 컨테이너 */
.chk-wrap{ display:flex; align-items:center; justify-content:center; min-height:32px; }
.riskchk{ width:18px; height:18px; accent-color:#111827; cursor:pointer; }
@media(pointer:coarse){ .riskchk{ width:21px; height:21px } }
.cell-input{
  width:100%; min-height:40px; border:1px solid var(--border); border-radius:8px; background:#fff;
  font-family:inherit; font-size:inherit; padding:6px 8px; outline:none;
  white-space:pre-wrap; word-break:break-word; overflow-wrap:break-word; resize:vertical;
}

/*  보완대책 드롭셀/사용자입력 UI */
.miti-cell{ padding:6px !important; position:relative; }
.miti-ui{ display:flex; flex-direction:column; gap:6px; }
.miti-select,
.miti-user{
  box-sizing:border-box; width:100%; height:48px;
  padding:0 34px 0 10px; border:1px solid var(--border); border-radius:8px; background:#fff;
  font-family:inherit; font-size:inherit; line-height:48px; outline:none;
  -webkit-appearance:none; appearance:none; background-image:none;
}
.miti-user{ display:none; padding:6px 8px; line-height:normal; }
.miti-cell::after{
  content:""; position:absolute; right:14px; top:50%; margin-top:-4px; width:0; height:0;
  border-left:6px solid transparent; border-right:6px solid transparent; border-top:8px solid #6b7280;
}
@supports (-webkit-touch-callout: none){ .miti-select{ line-height:48px; } }
@media (pointer:coarse) and (max-width:800px){ .miti-select{ line-height:48px; } }
.miti-print{ display:none; min-height:48px; white-space:pre-wrap; word-break:break-word; }

/* 서명 */
.signature{ width:100%; height:130px }
.sig-box{ position:relative }
#printPDF{ position:absolute; top:-50px; right:14px; transform:none; z-index:2 }
.signature canvas{
  width:100%; height:100%; display:block; border:1px dashed var(--border);
  border-radius:8px; background:#fff; touch-action:none
}

/* 
 인쇄 최적화 + 3단락 묶기 + 열폭 동기화
 */
@page{ margin:15mm }
@media print{
  html, body{
    background:#fff !important; color:#000 !important;
    -webkit-print-color-adjust: exact; print-color-adjust: exact;
  }
  .wrap{ transform:none !important; width:auto !important }
  header,.toolbar{ display:none !important }
  .card{ box-shadow:none !important; background:#fff !important; border-color:#ddd !important; transform-origin:top left; }
  .table-wrap, table, thead, tbody, tfoot, tr, th, td,
  input.field, textarea.field, .signature canvas{ background:#fff !important; }
  thead th{ background:#fff !important } td.section{ background:#fff !important }

  #printPDF, #clearAll, #clearSigSafety, #clearSigW1, #clearSigW2, #clearSigW3 { display:none !important; }
  .section-actions{ display:none !important; }

  thead{ display:table-header-group !important } tfoot{ display:table-footer-group !important }
  table{ min-width:auto; width:100%; table-layout:auto; border-collapse:collapse }
  .table-wrap{ overflow:visible !important }

  tr, th, td, .sig-box, .signature, .section-cell,
  .miti-print, .cell-input, .miti-select, .miti-user{
    page-break-inside:avoid !important; break-inside:avoid !important;
  }
  tbody{ page-break-inside:auto; break-inside:auto }
  p, .cell-input, .miti-print{ orphans:3; widows:3 }
  h1,h2,h3, .main-title, .section-title{ page-break-after:avoid; break-after:avoid }
  .page-block{ page-break-inside:avoid !important; break-inside:avoid !important; }
  .page-start{ page-break-before:always !important; break-before:page !important; }

  html.print-portrait  col.c-task{width:8%!important}  html.print-portrait  col.c-hazard{width:36%!important}
  html.print-portrait  col.c-ok{width:6%!important}   html.print-portrait  col.c-fix{width:6%!important}
  html.print-portrait  col.c-na{width:6%!important}   html.print-portrait  col.c-miti{width:36%!important}
  html.print-portrait  col.c-done{width:2%!important}
  html.print-landscape col.c-task{width:8%!important}  html.print-landscape col.c-hazard{width:36%!important}
  html.print-landscape col.c-ok{width:5%!important}   html.print-landscape col.c-fix{width:5%!important}
  html.print-landscape col.c-na{width:5%!important}   html.print-landscape col.c-miti{width:36%!important}
  html.print-landscape col.c-done{width:5%!important}

  .miti-ui{ display:none !important; } .miti-print{ display:block !important; }
}

/*  내보내기/공유 모드: UI 숨김 + 텍스트만 출력 + 안드로이드 안정화(클론에 적용될 규칙) */
html.export-mode header,
html.export-mode .toolbar,
html.export-mode #printPDF,
html.export-mode #clearAll,
html.export-mode #clearSigSafety,
html.export-mode #clearSigW1,
html.export-mode #clearSigW2,
html.export-mode #clearSigW3,
html.export-mode .section-actions,
html.export-mode button { display:none !important; }
html.export-mode .miti-ui    { display:none !important; }
html.export-mode .miti-print { display:block !important; }
html.export-mode .card{
  box-shadow:none !important; background:#fff !important; border-color:#ddd !important;
}
html.export-mode html,
html.export-mode body,
html.export-mode .table-wrap,
html.export-mode table,
html.export-mode thead,
html.export-mode tbody,
html.export-mode tr,
html.export-mode th,
html.export-mode td { background:#fff !important; }

/* Sticky/Transform 해제 + 레이아웃 보정 */
html.export-mode header { position: static !important; }
html.export-mode .wrap  { transform:none !important; width:auto !important; }
html.export-mode .page-block { transform: none !important; width: auto !important; }
html.export-mode table { table-layout: auto !important; }
html.export-mode th,
html.export-mode td {
  padding: 8px 10px !important;
  white-space: normal !important;
  word-break: break-word !important;
  overflow-wrap: break-word !important;
}
/* 체크박스는 캡처용으로 숨기고 텍스트 표시()로 대체 */
html.export-mode input.riskchk { visibility: hidden !important; }
/* 섹션 제목은 반드시 보이게 */
html.export-mode td.section .section-title { display:block !important; }

/* 프린트 진입용 클래스(미리보기 직전 잠깐 적용) */
html.print-mode .wrap{ transform:none !important; width:auto !important; }
html.print-mode header{ position:static !important; }
</style>
</head>

<body>
<header>
  <div class="wrap">
    <div class="brand">
      <div class="title">LG전자 ES에너지컨설팅팀 위험성 평가표 (모바일 표 Ver.)</div>
    </div>
    <div class="toolbar">
      <div class="toolbar-left">
        <button id="clearAll" class="warn" type="button">초기화</button>
        <button id="openViewer" class="secondary" type="button" title="PDF 뷰어로 열기">뷰어로 열기</button>
        <!--  공유 버튼 -->
        <button id="sharePDF" class="secondary" type="button" title="공유">공유</button>
        <!--  인쇄(미리보기) 버튼: 기존 PDF 버튼과 별도로 확실히 프린트 진입 -->
        <button id="printPreview" class="secondary" type="button" title="인쇄 미리보기">인쇄 미리보기</button>
      </div>
    </div>
  </div>
</header>

<main class="wrap">
  <!-- 1) 현장 정보란 -->
  <section class="card page-block" id="metaCard">
    <div class="title main-title">수시 위험성 평가표</div>
    <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px">
      <div><label class="hint">업체명</label><input id="fCompany" type="text" value="LG전자 ES에너지컨설팅팀" class="field"></div>
      <div><label class="hint">현장명</label><input id="fSiteName" type="text" placeholder="예: 공장 라인" class="field"></div>
      <div><label class="hint">진단 시작</label><input id="fDiagStart" type="date" class="field"></div>
      <div><label class="hint">진단 종료</label><input id="fDiagEnd" type="date" class="field"></div>
      <div><label class="hint">작성 일자</label><input id="fWrittenDate" type="date" class="field"></div>
      <div><label class="hint">현장관리자</label><input id="fSafety" type="text" placeholder="성명" class="field"></div>
      <div><label class="hint">실무자1</label><input id="fWorker1" type="text" placeholder="성명" class="field"></div>
      <div><label class="hint">실무자2</label><input id="fWorker2" type="text" placeholder="성명" class="field"></div>
      <div><label class="hint">실무자3</label><input id="fWorker3" type="text" placeholder="성명" class="field"></div>
      <div style="grid-column:1/-1"><label class="hint">비고</label>
        <textarea id="fRemark" class="field textarea" placeholder="특이사항/참고사항"></textarea>
      </div>
    </div>
  </section>

  <!-- 2) 체크리스트 -->
  <section class="card page-block page-start" id="checklistCard">
    <h2 style="display:none">작업별 유해위험요인 평가</h2>
    <div class="table-wrap">
      <table id="riskTable">
        <colgroup>
          <col class="c-task"/><col class="c-hazard"/><col class="c-ok"/><col class="c-fix"/><col class="c-na"/><col class="c-miti"/><col class="c-done"/>
        </colgroup>
        <thead>
          <tr>
            <th rowspan="2" class="th-center">작업</th>
            <th rowspan="2" class="th-center">유해위험요인 파악</th>
            <th colspan="3" class="th-center">위험성 확인결과</th>
            <th rowspan="2" class="th-center">보완 대책</th>
            <th rowspan="2" class="th-center">
              <div style="display:flex; flex-direction:column; align-items:center; gap:4px">
                <span>확인</span>
                <label class="chk-wrap" title="전체 확인 체크/해제">
                  <input id="chkConfirmAll" type="checkbox" class="riskchk" style="width:18px;height:18px">
                </label>
              </div>
            </th>
          </tr>
          <tr>
            <th>적정</th><th>보완</th><th>해당없음</th>
          </tr>
        </thead>
        <tbody>
          <!-- 사전준비 작업 -->
          <tr id="prep-master-row">
            <td id="prep-section-cell" class="section" rowspan="8">
              <div class="section-cell">
                <div class="section-title">사전준비 작업</div>
                <div class="section-actions">
                  <button type="button" class="secondary mini" id="btnPrepAdd">+</button>
                  <button type="button" class="warn mini" id="btnPrepRemove">-</button>
                </div>
              </div>
            </td>
            <td>작업 장소 (기계실, 전기실, 옥상 등)까지 또는 장소 내 이동 및 작업에 있어 유해, 위험 요인이 있는가? 있다면 아래 점검.</td>
            <td class="no-ok"></td><td class="no-fix"></td><td></td>
            <td class="miti-cell"></td>
            <td></td>
          </tr>
          <tr class="prep-sub-row"><td>- 작업장 또는 통로에 배관 등 머리 부딪힘 가능</td><td></td><td></td><td></td><td class="miti-cell"></td><td></td></tr>
          <tr class="prep-sub-row"><td>- 작업장 또는 통로에 추락 가능 장소 있음</td><td></td><td></td><td></td><td class="miti-cell"></td><td></td></tr>
          <tr class="prep-sub-row"><td>- 작업장 또는 통로에 떨어짐 가능 장소 있음</td><td></td><td></td><td></td><td class="miti-cell"></td><td></td></tr>
          <tr class="prep-sub-row"><td>- 작업장 또는 통로에 고전압 주의 장소 있음</td><td></td><td></td><td></td><td class="miti-cell"></td><td></td></tr>
          <tr class="prep-sub-row"><td>- 작업장 또는 통로에 회전장비가 있음</td><td></td><td></td><td></td><td class="miti-cell"></td><td></td></tr>
          <tr><td>측정장비의 현장 운반까지 유해, 위험 요인이 있는가?</td><td></td><td></td><td></td><td class="miti-cell"></td><td></td></tr>
          <tr id="prep-last-fixed"><td>작업 공간이 밀폐되거나, 소통이 어려운 환경인가? Ex. 긴급, 응급상황 대처</td><td></td><td></td><td></td><td class="miti-cell"></td><td></td></tr>

          <!-- 작업시 -->
          <tr>
            <td id="task-works-label" class="section" rowspan="5">
              <div class="section-cell">
                <div class="section-title">작업시</div>
                <div class="section-actions">
                  <button type="button" class="secondary mini" id="btnWorksAdd">+</button>
                  <button type="button" class="warn mini" id="btnWorksRemove">-</button>
                </div>
              </div>
            </td>
            <td>보온재 탈거/제거, 각종 측정 등의 작업이 바닥에 서서 할 수 있는가? Ex. 사다리 필요여부</td>
            <td></td><td></td><td></td><td class="miti-cell"></td><td></td>
          </tr>
          <tr><td>보온재 탈거 및 제거를 고객측 또는 전문점측 인원이 수행하는가?</td><td></td><td></td><td></td><td class="miti-cell"></td><td></td></tr>
          <tr><td>직접 탈거 및 제거를 할 경우 베임방지 장갑 착용, 보안경 착용 등 안전규정을 지키는가?</td><td></td><td></td><td></td><td class="miti-cell"></td><td></td></tr>
          <tr><td>기존 온도센서 제거 및 자사 온도센서 부착 시 배관 내 압력에 의해 문제가 생길 수 있는가?</td><td></td><td></td><td></td><td class="miti-cell"></td><td></td></tr>
          <tr id="works-last-fixed"><td>220V 이상 전원이 있는 장소에서 작업을 하는가?</td><td></td><td></td><td></td><td class="miti-cell"></td><td></td></tr>

          <!-- 기타 -->
          <tr id="misc-section-row">
            <td id="misc-section-cell" class="section" rowspan="1">
              <div class="section-cell">
                <div class="section-title">기타</div>
                <div class="section-actions">
                  <button id="addMiscRow" class="secondary mini" type="button">+</button>
                  <button id="removeMiscRow" class="warn mini" type="button">-</button>
                </div>
              </div>
            </td>
            <td></td><td></td><td></td><td></td>
            <td class="miti-cell"></td><td></td>
          </tr>
        </tbody>
      </table>
    </div>
  </section>

  <!-- 3) 서명란 -->
  <section id="approvalSection" class="card page-block page-start">
    <h2>현장 확인 및 승인 서명</h2>
    <div style="display:grid; grid-template-columns:repeat(4, 1fr); gap:8px">
      <div class="sig-box">
        <label>현장관리자</label>
        <input id="sigNameSafety" type="text" placeholder="성명" class="field">
        <div class="signature" style="margin-top:6px"><canvas id="sigCanvasSafety"></canvas></div>
        <div style="margin-top:6px"><button class="secondary" id="clearSigSafety" type="button">Clear</button></div>
      </div>
      <div class="sig-box">
        <label>실무자1</label>
        <input id="sigNameW1" type="text" placeholder="성명" class="field">
        <div class="signature" style="margin-top:6px"><canvas id="sigCanvasW1"></canvas></div>
        <div style="margin-top:6px"><button class="secondary" id="clearSigW1" type="button">Clear</button></div>
      </div>
      <div class="sig-box">
        <label>실무자2</label>
        <input id="sigNameW2" type="text" placeholder="성명" class="field">
        <div class="signature" style="margin-top:6px"><canvas id="sigCanvasW2"></canvas></div>
        <div style="margin-top:6px"><button class="secondary" id="clearSigW2" type="button">Clear</button></div>
      </div>
      <div class="sig-box">
        <label>실무자3</label>
        <input id="sigNameW3" type="text" placeholder="성명" class="field">
        <div class="signature" style="margin-top:6px"><canvas id="sigCanvasW3"></canvas></div>
        <button id="printPDF" class="secondary" type="button" title="PDF로 내보내기">PDF</button>
        <div style="margin-top:6px"><button class="secondary" id="clearSigW3" type="button">Clear</button></div>
      </div>
    </div>
  </section>
</main>

<script>
/* 유틸리티 */
const byId = (id)=>document.getElementById(id);
const qs = (sel)=>document.querySelector(sel);
const qsa = (sel)=>Array.from(document.querySelectorAll(sel));

document.addEventListener('DOMContentLoaded', ()=>{
  document.querySelectorAll('thead th.th-center').forEach((th)=>{ th.style.textAlign = 'center'; });
});

/* 셀 인젝터 (기존 유지) */
function injectCheckbox(cell, colKey, labelText){
  const input=document.createElement("input");
  input.type="checkbox"; input.className="riskchk";
  input.setAttribute("data-col", colKey); input.setAttribute("title", labelText);
  const wrap=document.createElement("label");
  wrap.className="chk-wrap"; wrap.appendChild(input);
  cell.innerHTML=""; cell.appendChild(wrap);
  return input;
}
function injectTextarea(cell){
  const ta=document.createElement("textarea");
  ta.className="cell-input"; ta.setAttribute("rows","1");
  function autosize(){ ta.style.height="auto"; ta.style.height=(ta.scrollHeight)+"px"; }
  ta.addEventListener("input", autosize); setTimeout(autosize,0);
  cell.innerHTML=""; cell.appendChild(ta);
  return ta;
}
function injectMitiInput(cell){
  cell.innerHTML=""; cell.classList.add("miti-cell");
  const ui=document.createElement("div"); ui.className="miti-ui";
  const sel=document.createElement("select"); sel.className="miti-select";
  sel.innerHTML = `
    <option value="">선택</option>
    <option value="완료">안전 조치 완료</option>
    <option value="입력">사용자 입력</option>
  `;
  const user=document.createElement("input");
  user.type="text"; user.className="miti-user"; user.placeholder=""; user.style.display="none";
  const printDiv=document.createElement("div"); printDiv.className="miti-print";
  function sync(){
    const v = sel.value;
    if(v === "완료"){
      user.style.display="none";
      printDiv.textContent = "안전 조치 완료";
    }else if(v === "입력"){
      user.style.display="block";
      printDiv.textContent = user.value || "";
    }else{
      user.style.display="none";
      printDiv.textContent = ""; // '선택'은 공백
    }
  }
  sel.addEventListener("change", sync);
  user.addEventListener("input", sync);
  setTimeout(sync,0);
  ui.appendChild(sel); ui.appendChild(user);
  cell.appendChild(ui); cell.appendChild(printDiv);
  return sel;
}

/* 행 초기화/동적 행 (기존 유지) */
function initRiskRow(tr){
  const tds=tr.querySelectorAll("td"); const len=tds.length; if(len<6) return;
  const idxHaz = (len===7 ? 1 : 0);
  const idxOk  = idxHaz + 1;
  const idxFix = idxHaz + 2;
  const idxNa  = idxHaz + 3;
  const idxMiti= idxHaz + 4;
  const idxDone= idxHaz + 5;

  const isPrepMaster = tr.id === "prep-master-row";
  if(isPrepMaster){
    if(!tds[idxNa].querySelector(".riskchk")) injectCheckbox(tds[idxNa], "na", "해당없음");
  } else {
    if(!tds[idxOk ].querySelector(".riskchk")) injectCheckbox(tds[idxOk ], "ok",  "적정");
    if(!tds[idxFix].querySelector(".riskchk")) injectCheckbox(tds[idxFix], "fix", "보완");
    if(!tds[idxNa ].querySelector(".riskchk")) injectCheckbox(tds[idxNa ], "na",  "해당없음");
    const rowChks=tr.querySelectorAll(".riskchk");
    rowChks.forEach((chk)=>{
      chk.addEventListener("change", ()=>{
        if(chk.checked && (chk.dataset.col==="ok" || chk.dataset.col==="fix" || chk.dataset.col==="na")){
          rowChks.forEach((other)=>{
            if(other!==chk && (other.dataset.col==="ok" || other.dataset.col==="fix" || other.dataset.col==="na")) other.checked=false;
          });
        }
      });
    });
  }
  if(!tds[idxDone].querySelector(".riskchk")) injectCheckbox(tds[idxDone], "done", "확인");
  if(!tds[idxMiti].querySelector(".miti-select")) injectMitiInput(tds[idxMiti]);
  if(idxHaz>=0 && tds[idxHaz].textContent.trim()==="" && !tds[idxHaz].querySelector(".cell-input")){
    injectTextarea(tds[idxHaz]);
  }
}
function initRiskTable(){ qsa("#riskTable tbody tr").forEach(initRiskRow); }

const PREP_BASE_ROWS  = 8;
const WORKS_BASE_ROWS = 5;
const MISC_BASE_ROWS  = 1;
function adjustRowspan(cellId, base, delta){
  const td = byId(cellId); if(!td) return;
  const cur = td.rowSpan || base;
  let next = cur + delta;
  if(next < base) next = base;
  td.rowSpan = next;
}
/* ... add/remove rows (동일, 생략해도 무방: 기존 완전판 포함) */

/* 사전준비 하위행 잠금/해제 (기존 유지) */
function setPrepSubRowsDisabled(disabled){
  qsa("#riskTable tbody tr.prep-sub-row").forEach((row)=>{
    ["ok","fix","na","done"].forEach((colKey)=>{
      const chk=row.querySelector('input.riskchk[data-col="'+colKey+'"]');
      if(chk){ if(disabled){ chk.checked=false; } chk.disabled=!!disabled; }
    });
    const sel=row.querySelector('.miti-select');
    const user=row.querySelector('.miti-user');
    if(sel){ sel.disabled=!!disabled; }
    if(user){ user.disabled=!!disabled; }
  });
}
function initPrepRowLogic(){
  const master=byId("prep-master-row"); if(!master) return;
  function evalState(){
    const na = master.querySelector('input.riskchk[data-col="na"]');
    const disabled = !!(na && na.checked);
    setPrepSubRowsDisabled(disabled);
  }
  qsa('#prep-master-row input.riskchk[data-col="na"]').forEach((chk)=>{ chk.addEventListener("change", evalState); });
  evalState();
}

/* 서명 패드(기존 유지) */
function initSignature(canvasId, clearBtnId){ /* ... 동일 ... */ }

/* 성명 동기화(기존 유지) */
function syncSigFromMeta(){ /* ... 동일 ... */ }

/* 모바일 폭 동기화(기존 유지) */
function equalizeHazardMitiWidth(){ /* ... 동일 ... */ }

/* 프린트 방향 클래스(기존 유지) */
function setPrintOrientationClass(){ /* ... 동일 ... */ }
function clearPrintOrientationClass(){ /* ... 동일 ... */ }

/* 인쇄 전/후(기존 유지) */
function scalePageBlocksForPrint(){ /* ... 동일 ... */ }
function resetBlockScaleAfterPrint(){ /* ... 동일 ... */ }

/* 확인 마스터 체크(기존 유지) */
function initConfirmMaster(){ /* ... 동일 ... */ }

/* 초기화(기존 유지) */
function resetToMaster(){ /* ... 동일 ... */ }

/*  클론 DOM에서 내보내기용 안전 정리 + 체크박스   텍스트 표시 */
function prepareExportClone(doc){
  const root = doc.documentElement;
  root.classList.add('export-mode');

  // 보완대책 텍스트 동기화
  doc.querySelectorAll('.miti-cell').forEach(cell=>{
    const sel  = cell.querySelector('.miti-select');
    const user = cell.querySelector('.miti-user');
    const p    = cell.querySelector('.miti-print');
    if(!p || !sel) return;
    const v = sel.value;
    if(v === '완료'){ p.textContent = '안전 조치 완료'; }
    else if(v === '입력'){ p.textContent = (user && user.value) ? user.value : ''; }
    else { p.textContent = ''; }
  });

  // 체크박스   텍스트 레이어
  doc.querySelectorAll('#riskTable tbody tr').forEach(tr=>{
    const cells = tr.querySelectorAll('td'); if(!cells.length) return;
    const len = cells.length;
    const idxHaz  = (len === 7 ? 1 : 0);
    const idxOk   = idxHaz + 1;
    const idxFix  = idxHaz + 2;
    const idxNa   = idxHaz + 3;
    const idxMiti = idxHaz + 4;
    const idxDone = idxHaz + 5;

    function mark(cell, colKey, label){
      const chk = cell ? cell.querySelector(`input.riskchk[data-col="${colKey}"]`) : null;
      if(chk && chk.checked){
        let markSpan = cell.querySelector('.print-mark');
        if(!markSpan){
          markSpan = doc.createElement('span');
          markSpan.className = 'print-mark';
          markSpan.style.display = 'inline-block';
          markSpan.style.marginLeft = '2px';
          markSpan.textContent = ' ' + label;
          cell.appendChild(markSpan);
        } else {
          markSpan.textContent = ' ' + label;
        }
      }else{
        const markSpan = cell.querySelector('.print-mark');
        if(markSpan) markSpan.remove();
      }
    }
    mark(cells[idxOk],  'ok',  '적정');
    mark(cells[idxFix], 'fix', '보완');
    mark(cells[idxNa],  'na',  '해당없음');
    mark(cells[idxDone],'done','확인');
  });

  // 섹션 제목 보장
  doc.querySelectorAll('td.section .section-title').forEach(el=>{
    el.style.display = 'block';
  });
}

/*  PDF Blob  새 탭(브라우저 내장 PDF 뷰어) */
async function openPdfViewerTab(){
  try{
    setPrintOrientationClass();

    const opt = {
      margin: 15,
      filename: '위험성_평가표.pdf',
      image: { type: 'jpeg', quality: 0.98 },
      html2canvas: {
        scale: Math.max(window.devicePixelRatio || 1, 2),
        useCORS: true,
        allowTaint: true,
        backgroundColor: '#fff',
        windowWidth: document.documentElement.scrollWidth,
        windowHeight: document.documentElement.scrollHeight,
        scrollY: -window.scrollY,
        //  클론 DOM에 export-mode 적용 + 체크박스 표시 보정
        onclone: (doc) => { try { prepareExportClone(doc); } catch(e){} }
      },
      jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
    };

    const blob = await html2pdf().set(opt).from(document.body).toPdf().output('blob');
    const url  = URL.createObjectURL(blob);
    window.open(url, '_blank');
  }catch(e){
    alert('PDF 뷰어 열기 중 오류: ' + (e?.message || e));
  }finally{
    clearPrintOrientationClass();
  }
}

/*  공유: 가능하면 OS 공유 시트  미지원/HTTP면 뷰어 폴백 */
async function sharePdfDirect(){
  const isHttps = location.protocol === 'https:';
  try{
    setPrintOrientationClass();

    const opt = {
      margin: 15,
      filename: '위험성_평가표.pdf',
      image: { type: 'jpeg', quality: 0.98 },
      html2canvas: {
        scale: Math.max(window.devicePixelRatio || 1, 2),
        useCORS: true,
        allowTaint: true,
        backgroundColor: '#fff',
        windowWidth: document.documentElement.scrollWidth,
        windowHeight: document.documentElement.scrollHeight,
        scrollY: -window.scrollY,
        onclone: (doc) => { try { prepareExportClone(doc); } catch(e){} }
      },
      jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
    };
    const blob = await html2pdf().set(opt).from(document.body).toPdf().output('blob');

    const file = new File([blob], '위험성_평가표.pdf', { type: 'application/pdf' });
    const data = { files: [file], title: '위험성 평가표', text: 'PDF 공유' };

    if (isHttps && 'canShare' in navigator && navigator.canShare(data)) {
      await navigator.share(data);
    } else {
      const url = URL.createObjectURL(blob);
      window.open(url, '_blank');
    }
  }catch(e){
    alert('공유 처리 중 오류: ' + (e?.message || e));
  }finally{
    clearPrintOrientationClass();
  }
}

/*  프린트 미리보기로 확실히 진입 */
function enterPrintPreview(){
  try{
    document.documentElement.classList.add('print-mode'); // 출력 방해 요소 해제
    setPrintOrientationClass();

    // 사용자 제스처 내에서 rAF를 거쳐 print() 호출 (모바일 차단 방지)
    requestAnimationFrame(()=>{
      try { window.print(); } catch(e) { alert('인쇄 호출 오류: ' + (e?.message || e)); }
    });
  }catch(e){
    alert('인쇄 모드 진입 오류: ' + (e?.message || e));
  }
}
/* 인쇄 이벤트 후 원복 */
window.addEventListener('afterprint', ()=>{
  document.documentElement.classList.remove('print-mode');
  clearPrintOrientationClass();
  resetBlockScaleAfterPrint();
});

/* 초기화 */
function initAll(){
  try{
    /* 선택: 로컬스토리지 복원 (기존 유지) */
    try{
      const raw=localStorage.getItem("hra-risk-mobile-v3");
      if(raw){
        const doc=JSON.parse(raw);
        ["fSiteName","fDiagStart","fDiagEnd","fWrittenDate","fSafety","fWorker1","fWorker2","fWorker3","fRemark"].forEach((id)=>{
          const el=byId(id); if(!el) return;
          const keyMap={fSiteName:"siteName",fDiagStart:"diagStart",fDiagEnd:"diagEnd",fWrittenDate:"writtenDate",fSafety:"safetyManager",
                        fWorker1:"worker1",fWorker2:"worker2",fWorker3:"worker3",fRemark:"remark"};
          const k=keyMap[id]; el.value = (doc.meta && doc.meta[k]) || "";
        });
        const c=byId("fCompany"); if(c) c.value = (doc.meta && doc.meta.companyName) || c.value || "LG전자 ES에너지컨설팅팀";
      }
    }catch(e){ /* 무시 */ }

    const btnPrint       = byId("printPDF");
    const btnClear       = byId("clearAll");
    const btnPrepAdd     = byId("btnPrepAdd");
    const btnPrepRemove  = byId("btnPrepRemove");
    const btnWorksAdd    = byId("btnWorksAdd");
    const btnWorksRemove = byId("btnWorksRemove");
    const btnMiscAdd     = byId("addMiscRow");
    const btnMiscRemove  = byId("removeMiscRow");
    const btnOpenViewer  = byId("openViewer");
    const btnShare       = byId("sharePDF");
    const btnPrintPrev   = byId("printPreview");

    // 기존 PDF 버튼은 프린트로 연결 (요청 사항 반영)
    if(btnPrint)     btnPrint.addEventListener("click", enterPrintPreview);
    if(btnPrintPrev) btnPrintPrev.addEventListener("click", enterPrintPreview);

    if(btnClear){ btnClear.addEventListener("click", ()=>{ if(confirm("초기화 하시겠습니까? 저장된 데이터가 삭제됩니다.")){ resetToMaster(); } }); }
    if(btnPrepAdd)     btnPrepAdd   .addEventListener("click", addPrepRow);
    if(btnPrepRemove)  btnPrepRemove.addEventListener("click", removePrepRow);
    if(btnWorksAdd)    btnWorksAdd  .addEventListener("click", addWorkRow);
    if(btnWorksRemove) btnWorksRemove.addEventListener("click", removeWorkRow);
    if(btnMiscAdd)     btnMiscAdd   .addEventListener("click", addMiscRow);
    if(btnMiscRemove)  btnMiscRemove.addEventListener("click", removeMiscRow);

    if(btnOpenViewer)  btnOpenViewer.addEventListener("click", openPdfViewerTab);
    if(btnShare)       btnShare.addEventListener("click", sharePdfDirect);

    initRiskTable();
    initPrepRowLogic();
    initConfirmMaster();

    initSignature('sigCanvasSafety','clearSigSafety');
    initSignature('sigCanvasW1','clearSigW1');
    initSignature('sigCanvasW2','clearSigW2');
    initSignature('sigCanvasW3','clearSigW3');

    syncSigFromMeta();
    setTimeout(equalizeHazardMitiWidth, 50);
    window.addEventListener("resize", ()=>{ requestAnimationFrame(equalizeHazardMitiWidth); });
    window.addEventListener("orientationchange", equalizeHazardMitiWidth);
  }catch(e){
    console.error(e); alert("기능 초기화 중 오류: " + (e?.message || e));
  }
}
window.addEventListener("DOMContentLoaded", initAll);
</script>
</body>
</html>
